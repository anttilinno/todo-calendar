---
phase: 36-status-subcommand
plan: 02
type: execute
wave: 2
depends_on:
  - 36-01
files_modified:
  - main.go
autonomous: true
requirements:
  - BAR-01
  - BAR-02
  - BAR-03

must_haves:
  truths:
    - "Running `todo-calendar status` queries SQLite for today's pending todos and writes output to /tmp/.todo_status"
    - "Subcommand exits immediately after writing (no TUI, no blocking)"
    - "State file contains Polybar-formatted string when pending todos exist"
    - "State file contains empty string when zero pending todos today"
  artifacts:
    - path: "main.go"
      provides: "status subcommand routing that branches before TUI launch"
      contains: "status"
  key_links:
    - from: "main.go"
      to: "internal/status/status.go"
      via: "FormatStatus + WriteStatusFile called from status subcommand branch"
      pattern: "status\\.FormatStatus|status\\.WriteStatusFile"
    - from: "main.go"
      to: "internal/store/sqlite.go"
      via: "TodosForDateRange queried with today's date"
      pattern: "TodosForDateRange"
    - from: "main.go"
      to: "internal/config/config.go"
      via: "config.Load and config.DBPath for theme and store initialization"
      pattern: "config\\.Load|config\\.DBPath"
---

<objective>
Wire the `status` subcommand into main.go so `todo-calendar status` queries the database, formats Polybar output, writes the state file, and exits.

Purpose: Complete the user-facing entry point for the Polybar integration. After this, users can call `todo-calendar status` from a Polybar script or cron job.

Output: Modified main.go with subcommand routing.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-status-subcommand/36-01-SUMMARY.md
@main.go
@internal/status/status.go
@internal/config/config.go
@internal/config/paths.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add status subcommand routing to main.go</name>
  <files>main.go</files>
  <action>
  Add subcommand detection at the top of main(), before any TUI setup. The pattern:

  1. Check if `len(os.Args) >= 2 && os.Args[1] == "status"` early in main()
  2. If matched, branch to a `runStatus()` function that:
     a. Loads config via config.Load() (needed for theme)
     b. Opens SQLite store via config.DBPath() + store.NewSQLiteStore()
     c. Queries today's todos: `s.TodosForDateRange(today, today)` where today is `time.Now().Format("2006-01-02")`
     d. Gets theme: `theme.ForName(cfg.Theme)`
     e. Calls `status.FormatStatus(todos, t)`
     f. Calls `status.WriteStatusFile(output)`
     g. Closes store, exits with code 0 (or 1 on error)
  3. The subcommand must NOT initialize the holiday provider, Google Calendar, recurring tasks, or Bubble Tea -- only config, store, theme, and status

  Import `"github.com/antti/todo-calendar/internal/status"` and `"time"`.

  Place the `if os.Args[1] == "status"` check AFTER config load and db open but BEFORE holiday provider, google, recurring, and tea.NewProgram. Restructure main() so config+db are loaded first, then the status branch can exit early, then the rest continues for TUI mode.

  The runStatus function signature: `func runStatus(cfg config.Config, s *store.SQLiteStore)` -- takes already-opened config and store to avoid duplicating that setup.
  </action>
  <verify>
    <automated>cd /home/antti/Repos/Misc/todo-calendar/.dmux/worktrees/notifier && go build -o /tmp/todo-calendar-test . && /tmp/todo-calendar-test status && cat /tmp/.todo_status; echo "EXIT: $?"</automated>
    <manual>Verify /tmp/.todo_status contains either empty string or Polybar-formatted output. Verify the command exits immediately (no TUI).</manual>
  </verify>
  <done>
  - `todo-calendar status` runs, writes /tmp/.todo_status, and exits with code 0
  - No TUI is launched, no blocking
  - State file matches expected Polybar format (or empty if no pending todos today)
  - `go build ./...` compiles cleanly
  </done>
</task>

</tasks>

<verification>
cd /home/antti/Repos/Misc/todo-calendar/.dmux/worktrees/notifier && go build ./...
cd /home/antti/Repos/Misc/todo-calendar/.dmux/worktrees/notifier && go test ./... -count=1
cd /home/antti/Repos/Misc/todo-calendar/.dmux/worktrees/notifier && go build -o /tmp/todo-calendar-test . && /tmp/todo-calendar-test status && echo "Status file:" && cat /tmp/.todo_status && echo "---"
</verification>

<success_criteria>
- `todo-calendar status` exits immediately after writing state file
- State file at /tmp/.todo_status contains Polybar-formatted output or empty string
- No TUI launched, no alt-screen, no blocking
- All existing tests still pass
- Project compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/36-status-subcommand/36-02-SUMMARY.md`
</output>

---
phase: 02-calendar-holidays
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - go.mod
  - go.sum
  - internal/config/config.go
  - internal/config/paths.go
  - internal/holidays/registry.go
  - internal/holidays/provider.go
  - internal/calendar/grid.go
  - internal/calendar/styles.go
  - internal/calendar/keys.go
autonomous: true

must_haves:
  truths:
    - "Config loads country and monday_start from TOML file or falls back to defaults"
    - "Holiday provider returns correct holiday day numbers for a given month"
    - "Calendar grid pure function produces a 20-char wide month grid with per-cell styling"
  artifacts:
    - path: "internal/config/config.go"
      provides: "Config struct with Load and DefaultConfig"
      exports: ["Config", "DefaultConfig", "Load"]
    - path: "internal/config/paths.go"
      provides: "XDG config path resolution"
      exports: ["Path"]
    - path: "internal/holidays/registry.go"
      provides: "Country code to holiday slice mapping"
      exports: ["Registry"]
    - path: "internal/holidays/provider.go"
      provides: "Holiday lookup for a given month"
      exports: ["Provider", "NewProvider"]
    - path: "internal/calendar/grid.go"
      provides: "Pure function calendar grid rendering"
      exports: ["RenderGrid"]
    - path: "internal/calendar/styles.go"
      provides: "Lip Gloss styles for calendar cells"
    - path: "internal/calendar/keys.go"
      provides: "PrevMonth/NextMonth key bindings"
      exports: ["KeyMap", "DefaultKeyMap"]
  key_links:
    - from: "internal/holidays/provider.go"
      to: "internal/holidays/registry.go"
      via: "Registry lookup by country code"
      pattern: "Registry\\[countryCode\\]"
    - from: "internal/calendar/grid.go"
      to: "internal/calendar/styles.go"
      via: "Per-cell style application"
      pattern: "(todayStyle|holidayStyle|normalStyle)\\.Render"
---

<objective>
Create all building-block packages for Phase 2: TOML config, holiday provider, and calendar grid rendering with styles and key bindings.

Purpose: Establish the data layer and pure rendering logic that Plan 02 will wire into the Bubble Tea model. By building these as independent packages first, each can be verified in isolation before integration.

Output: Three new packages (config, holidays, calendar additions) with all exports ready for consumption. No existing files are modified -- this plan only creates new files and installs new dependencies.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-calendar-holidays/02-RESEARCH.md
@internal/calendar/model.go
@internal/app/styles.go
@go.mod
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create config package</name>
  <files>
    go.mod
    go.sum
    internal/config/config.go
    internal/config/paths.go
  </files>
  <action>
Install the two new dependencies:
```bash
cd /home/antti/Repos/Misc/todo-calendar
go get github.com/rickar/cal/v2@v2.1.27
go get github.com/BurntSushi/toml@v1.6.0
```

Create `internal/config/paths.go`:
- Export a `Path() (string, error)` function
- Use `os.UserConfigDir()` to get the XDG config directory
- Return `filepath.Join(dir, "todo-calendar", "config.toml")`

Create `internal/config/config.go`:
- Define `Config` struct with two fields:
  - `Country string` with toml tag `"country"`
  - `MondayStart bool` with toml tag `"monday_start"`
- Export `DefaultConfig() Config` returning `Config{Country: "us", MondayStart: false}`
- Export `Load() (Config, error)`:
  1. Start with `DefaultConfig()`
  2. Call `Path()` to get config file path; if error, return defaults (no error)
  3. `os.Stat(path)` -- if `os.IsNotExist`, return defaults (no error)
  4. Call `toml.DecodeFile(path, &cfg)` -- this overlays only the fields present in the file onto the defaults
  5. Return cfg and any decode error (so malformed TOML is reported, but missing file is not)

Import `github.com/BurntSushi/toml` in config.go. Do NOT auto-create the config file on first run.

Verify the package compiles:
```bash
go build ./internal/config/...
```
  </action>
  <verify>
`go build ./internal/config/...` succeeds with zero errors. `go vet ./internal/config/...` passes clean.
  </verify>
  <done>
Config package exists with Load, DefaultConfig, and Path exports. Missing config file returns defaults without error. Malformed TOML returns an error. Both rickar/cal/v2 and BurntSushi/toml appear in go.mod.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create holiday provider and country registry</name>
  <files>
    internal/holidays/registry.go
    internal/holidays/provider.go
  </files>
  <action>
Create `internal/holidays/registry.go`:
- Import `github.com/rickar/cal/v2` and country subpackages for a practical subset of 10 countries:
  `fi`, `us`, `gb`, `de`, `se`, `no`, `dk`, `fr`, `es`, `it`
- Export `var Registry = map[string][]*cal.Holiday{...}` mapping lowercase ISO codes to each country's `Holidays` slice
  - Example: `"fi": fi.Holidays, "us": us.Holidays, "gb": gb.Holidays`, etc.
- Export `SupportedCountries() []string` that returns sorted keys of Registry (for future help text)

Create `internal/holidays/provider.go`:
- Define `Provider` struct with fields: `cal *cal.Calendar`, `country string`
- Export `NewProvider(countryCode string) (*Provider, error)`:
  1. Look up `countryCode` in `Registry`
  2. If not found, return `nil, fmt.Errorf("unsupported country code: %q (supported: %v)", countryCode, SupportedCountries())`
  3. Create `c := &cal.Calendar{}`
  4. Call `c.AddHoliday(holidays...)` with the looked-up slice
  5. Return `&Provider{cal: c, country: countryCode}, nil`
- Export `(p *Provider) HolidaysInMonth(year int, month time.Month) map[int]bool`:
  1. Compute `daysInMonth` using `time.Date(year, month+1, 0, 0, 0, 0, 0, time.Local).Day()`
  2. Loop day 1..daysInMonth, construct date with NOON time.Local: `time.Date(year, month, day, 12, 0, 0, 0, time.Local)` (noon avoids timezone edge cases)
  3. Call `p.cal.IsHoliday(date)` -- returns `(actual bool, observed bool, holiday *cal.Holiday)`
  4. If `actual || observed`, set `result[day] = true`
  5. Return the map
- Export `(p *Provider) Country() string` getter

IMPORTANT: Use noon (12:00) for all IsHoliday date construction per research pitfall #4.

Verify:
```bash
go build ./internal/holidays/...
```
  </action>
  <verify>
`go build ./internal/holidays/...` succeeds. `go vet ./internal/holidays/...` passes clean.
  </verify>
  <done>
Holiday provider exists with NewProvider and HolidaysInMonth. Registry maps 10 country codes to their holiday slices. Unsupported country code returns a descriptive error.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create calendar styles, key bindings, and grid renderer</name>
  <files>
    internal/calendar/styles.go
    internal/calendar/keys.go
    internal/calendar/grid.go
  </files>
  <action>
Create `internal/calendar/styles.go`:
- Define package-level Lip Gloss style variables:
  - `headerStyle = lipgloss.NewStyle().Bold(true)` -- month/year title
  - `weekdayHeaderStyle = lipgloss.NewStyle().Faint(true)` -- "Su Mo Tu We Th Fr Sa"
  - `normalStyle = lipgloss.NewStyle()` -- regular day numbers
  - `todayStyle = lipgloss.NewStyle().Bold(true).Reverse(true)` -- today highlight (bold + reverse video)
  - `holidayStyle = lipgloss.NewStyle().Foreground(lipgloss.Color("1"))` -- red foreground for holidays
- These are unexported (lowercase) since only grid.go in the same package uses them

Create `internal/calendar/keys.go`:
- Define `KeyMap` struct with `PrevMonth` and `NextMonth` as `key.Binding` fields
- Implement `ShortHelp() []key.Binding` and `FullHelp() [][]key.Binding` on KeyMap (satisfying help.KeyMap interface for Phase 3)
- Export `DefaultKeyMap() KeyMap` returning:
  - PrevMonth: keys `"left", "h"`, help `"<-/h", "prev month"`
  - NextMonth: keys `"right", "l"`, help `->/l", "next month"`

Create `internal/calendar/grid.go`:
- Export `RenderGrid(year int, month time.Month, today int, holidays map[int]bool, mondayStart bool) string`
- The function is PURE -- no side effects, no Bubble Tea dependency
- Implementation:
  1. **Title line:** Format `month.String() + " " + year` (e.g., "February 2026"), center it within 20 chars using leading spaces, apply `headerStyle.Render()` to the title text only
  2. **Weekday header:** If mondayStart: `"Mo Tu We Th Fr Sa Su"`, else `"Su Mo Tu We Th Fr Sa"`. Apply `weekdayHeaderStyle.Render()` to the entire header line
  3. **First weekday:** `time.Date(year, month, 1, 0, 0, 0, 0, time.Local).Weekday()` -- returns Sunday=0..Saturday=6. If mondayStart, rotate: `(wd + 6) % 7` so Monday=0
  4. **Days in month:** `time.Date(year, month+1, 0, 0, 0, 0, 0, time.Local).Day()` (month+1, day 0 = last day of target month)
  5. **Leading blanks:** Write `startWeekday` count of `"   "` (3 spaces each)
  6. **Day cells:** Loop day 1..daysInMonth:
     - Format number FIRST: `cell := fmt.Sprintf("%2d", day)` -- this is critical, format BEFORE styling
     - Apply style based on priority: `day == today` -> todayStyle, `holidays[day]` -> holidayStyle, else normalStyle
     - Write styled cell
     - Increment column counter; if col == 7, write `"\n"` and reset to 0; else write `" "` (single space separator)
  7. **Trailing newline:** If col != 0 after loop, write `"\n"`
  8. Use `strings.Builder` for efficient concatenation

CRITICAL per research pitfall #3: Format the number (`%2d`) BEFORE applying Lip Gloss Render(). ANSI escape codes in styled strings would break `%2d` width formatting.

Verify the entire calendar package compiles:
```bash
go build ./internal/calendar/...
```
Note: calendar/model.go still exists as the Phase 1 placeholder. It will be rewritten in Plan 02-02. The new files must not conflict with it (they don't -- model.go doesn't define any of the same names).
  </action>
  <verify>
`go build ./internal/calendar/...` succeeds (including the existing model.go placeholder alongside the new files). `go vet ./internal/calendar/...` passes clean.
  </verify>
  <done>
Calendar package has grid.go (pure RenderGrid function), styles.go (5 Lip Gloss styles), and keys.go (PrevMonth/NextMonth bindings). All compile alongside the existing placeholder model.go without conflicts.
  </done>
</task>

</tasks>

<verification>
All three new packages compile and pass vet:
```bash
go build ./internal/config/... ./internal/holidays/... ./internal/calendar/...
go vet ./internal/config/... ./internal/holidays/... ./internal/calendar/...
```
The existing `go build ./...` still succeeds (placeholder model.go coexists with new files).
</verification>

<success_criteria>
- go.mod contains rickar/cal/v2 v2.1.27 and BurntSushi/toml v1.6.0
- `internal/config/` package exports Config, DefaultConfig, Load, Path
- `internal/holidays/` package exports Provider, NewProvider, Registry, SupportedCountries
- `internal/calendar/grid.go` exports RenderGrid pure function
- `internal/calendar/styles.go` defines todayStyle, holidayStyle, normalStyle, headerStyle, weekdayHeaderStyle
- `internal/calendar/keys.go` exports KeyMap with PrevMonth/NextMonth
- `go build ./...` succeeds with all packages
</success_criteria>

<output>
After completion, create `.planning/phases/02-calendar-holidays/02-01-SUMMARY.md`
</output>

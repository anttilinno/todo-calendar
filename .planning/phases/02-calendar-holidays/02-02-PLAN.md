---
phase: 02-calendar-holidays
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - internal/calendar/model.go
  - internal/app/model.go
  - main.go
autonomous: false

must_haves:
  truths:
    - "Left pane displays a monthly calendar grid with day-of-week headers resembling cal output"
    - "Today's date is visually highlighted on the calendar"
    - "User can navigate to the next or previous month and the calendar updates immediately"
    - "National holidays appear in red on the calendar"
    - "Holiday country is sourced from TOML config file with sane defaults"
  artifacts:
    - path: "internal/calendar/model.go"
      provides: "Calendar Bubble Tea model with month state, navigation, holiday display"
      exports: ["Model", "New", "Update", "View", "SetFocused"]
      min_lines: 60
    - path: "internal/app/model.go"
      provides: "Root model wiring config and holiday provider into calendar"
      contains: "config.Load"
    - path: "main.go"
      provides: "Entry point loading config before creating app model"
      contains: "config.Load"
  key_links:
    - from: "main.go"
      to: "internal/config/config.go"
      via: "config.Load() call"
      pattern: "config\\.Load"
    - from: "main.go"
      to: "internal/app/model.go"
      via: "app.New(cfg) or app.New(provider, mondayStart)"
      pattern: "app\\.New"
    - from: "internal/app/model.go"
      to: "internal/holidays/provider.go"
      via: "holidays.NewProvider(cfg.Country)"
      pattern: "holidays\\.NewProvider"
    - from: "internal/calendar/model.go"
      to: "internal/calendar/grid.go"
      via: "RenderGrid call in View()"
      pattern: "RenderGrid"
    - from: "internal/calendar/model.go"
      to: "internal/holidays/provider.go"
      via: "provider.HolidaysInMonth in Update/New"
      pattern: "provider\\.HolidaysInMonth"
---

<objective>
Wire the config, holiday provider, and calendar grid into the Bubble Tea model hierarchy so the user sees a working calendar with today highlighted, month navigation, and holidays in red.

Purpose: This is the integration plan that transforms the Phase 1 placeholder calendar pane into a fully functional calendar. It rewrites the calendar model, updates the app model constructor to accept dependencies, and modifies main.go to load config and create the provider.

Output: A running application where the left pane shows the current month's calendar with today highlighted, holidays in red, and left/right arrow navigation between months.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-calendar-holidays/02-RESEARCH.md
@.planning/phases/02-calendar-holidays/02-01-SUMMARY.md
@internal/calendar/model.go
@internal/app/model.go
@internal/app/keys.go
@main.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite calendar model with month state, navigation, and holiday integration</name>
  <files>
    internal/calendar/model.go
  </files>
  <action>
Completely rewrite `internal/calendar/model.go` (replacing the 39-line placeholder) with the full calendar model.

The Model struct should have these fields:
- `focused bool`
- `width int`
- `height int`
- `year int`
- `month time.Month`
- `today time.Time`
- `holidays map[int]bool` (day-of-month -> is holiday, recalculated on month change)
- `provider *holidays.Provider` (from internal/holidays package)
- `keys KeyMap` (from internal/calendar/keys.go)
- `mondayStart bool`

Update `New` to accept dependencies: `New(provider *holidays.Provider, mondayStart bool) Model`
- Initialize year/month from `time.Now()`
- Store `today: time.Now()`
- Call `provider.HolidaysInMonth(year, month)` to populate initial holidays
- Set `keys: DefaultKeyMap()` (from calendar package's keys.go)

Update `Update(msg tea.Msg) (Model, tea.Cmd)`:
- On `tea.KeyMsg`, ONLY process if `m.focused` (guard at top: `if !m.focused { return m, nil }` for KeyMsg)
- `key.Matches(msg, m.keys.PrevMonth)`:
  - Decrement month. CRITICAL: guard underflow explicitly -- `if m.month < time.January { m.month = time.December; m.year-- }`. Do NOT rely on time.Month arithmetic wrapping.
  - Recalculate: `m.holidays = m.provider.HolidaysInMonth(m.year, m.month)`
- `key.Matches(msg, m.keys.NextMonth)`:
  - Increment month. Guard overflow: `if m.month > time.December { m.month = time.January; m.year++ }`
  - Recalculate holidays
- On `tea.WindowSizeMsg`: update width/height as before

Update `View() string`:
- Compute `todayDay`: if `now.Year() == m.year && now.Month() == m.month` then `todayDay = time.Now().Day()`, else `todayDay = 0`
- Return `RenderGrid(m.year, m.month, todayDay, m.holidays, m.mondayStart)`

Keep `SetFocused(f bool)` as-is (pointer receiver, sets m.focused).

Import paths needed: `time`, `github.com/charmbracelet/bubbles/key`, `tea "github.com/charmbracelet/bubbletea"`, `"github.com/antti/todo-calendar/internal/holidays"`
  </action>
  <verify>
`go build ./internal/calendar/...` succeeds. The model exports New (with provider+mondayStart params), Update, View, SetFocused.
  </verify>
  <done>
Calendar model tracks year/month state, handles PrevMonth/NextMonth key navigation with proper month overflow/underflow guards, recalculates holidays on navigation, and renders via RenderGrid pure function. Only processes keys when focused.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire config and provider into app model and main.go</name>
  <files>
    internal/app/model.go
    internal/app/keys.go
    main.go
  </files>
  <action>
**main.go changes:**
1. Import `"github.com/antti/todo-calendar/internal/config"` and `"github.com/antti/todo-calendar/internal/holidays"`
2. Before creating the app model, load config:
   ```go
   cfg, err := config.Load()
   if err != nil {
       fmt.Fprintf(os.Stderr, "Config error: %v\n", err)
       os.Exit(1)
   }
   ```
3. Create holiday provider:
   ```go
   provider, err := holidays.NewProvider(cfg.Country)
   if err != nil {
       fmt.Fprintf(os.Stderr, "Holiday provider error: %v\n", err)
       os.Exit(1)
   }
   ```
4. Pass dependencies to app: `model := app.New(provider, cfg.MondayStart)`

**internal/app/model.go changes:**
1. Update `New` signature to accept dependencies: `New(provider *holidays.Provider, mondayStart bool) Model`
2. Update the calendar construction: `cal := calendar.New(provider, mondayStart)` (was `calendar.New()`)
3. Import `"github.com/antti/todo-calendar/internal/holidays"` for the Provider type in the function signature
4. Everything else in model.go stays the same -- the focus routing, WindowSizeMsg broadcast, pane layout, all unchanged. The calendar's `Update` and `View` signatures are the same (Model, tea.Cmd return), so the existing routing code works without modification.

**internal/app/model.go View() status bar update:**
No structural changes needed to keys.go itself. Update the status bar string in `model.go` View():
- Change `statusBar := "q: quit | Tab: switch pane"` to `statusBar := "q: quit | Tab: switch pane | <-/h ->l: month"`

This gives the user immediate feedback about the new month navigation keys.

Verify full build:
```bash
go build ./...
```

Then run the app briefly to confirm it starts without panic:
```bash
timeout 2 go run . 2>&1 || true
```
(The timeout will kill it after 2 seconds; we just want to confirm no startup crash.)
  </action>
  <verify>
`go build ./...` succeeds with zero errors. `go vet ./...` passes clean. Running `timeout 2 go run .` does not produce any error output on stderr (app starts and renders without crashing).
  </verify>
  <done>
main.go loads TOML config and creates holiday provider, passing both to app.New. App model passes provider and mondayStart to calendar.New. The full dependency chain is wired: config -> provider -> calendar model -> grid renderer. Status bar shows month navigation hints. App starts without crashing.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete calendar view with monthly grid, today highlight, national holidays in red, and month navigation. The calendar pane (left side) now shows a real calendar grid resembling `cal` output instead of the placeholder text.
  </what-built>
  <how-to-verify>
1. Run the app: `cd /home/antti/Repos/Misc/todo-calendar && go run .`
2. **Calendar grid** -- Left pane should show current month (February 2026) with day-of-week headers (Su Mo Tu We Th Fr Sa) and numbered days in a grid layout resembling `cal` output
3. **Today highlight** -- Today's date (5th or whatever today is) should be visually highlighted (bold + reverse video, appearing as a bright/inverted block)
4. **Month navigation** -- Press right arrow or `l` to go to March 2026. Press left arrow or `h` to go back to February. The grid should update immediately.
5. **Navigate to January** -- Press left arrow to go to January 2026. Verify New Year's Day (Jan 1) appears in red (holiday). If using default "us" country, also check Presidents' Day in February, Independence Day in July, etc.
6. **Holiday color** -- To test with a specific country, create config file:
   ```bash
   mkdir -p ~/.config/todo-calendar
   echo 'country = "fi"' > ~/.config/todo-calendar/config.toml
   ```
   Restart the app. Navigate to December -- Christmas Eve (24), Christmas (25), St. Stephen's Day (26) should appear in red.
7. **Focus behavior** -- Press Tab to switch to right pane. Arrow keys should NOT change the month when calendar is unfocused. Press Tab back and verify navigation works again.
8. **Edge cases** -- Navigate several months forward and backward. Verify no crashes, no visual glitches, no misaligned columns.
9. Press `q` to quit.
  </how-to-verify>
  <resume-signal>Type "approved" if the calendar looks correct, or describe any visual issues.</resume-signal>
</task>

</tasks>

<verification>
Phase 2 is complete when:
1. `go build ./...` succeeds
2. Calendar grid displays in left pane with correct day-of-week headers
3. Today's date has a distinct visual highlight (bold + reverse)
4. Left/right arrow (and h/l) navigate between months
5. Month navigation handles January->December and December->January year boundary correctly
6. National holidays appear in red based on configured country
7. Missing config file defaults to "us" country and Sunday start
8. App does not crash on any navigation sequence
</verification>

<success_criteria>
- Left pane shows monthly calendar grid resembling `cal` output (CAL-01)
- Month navigation works with left/right and h/l keys (CAL-02)
- Today is visually highlighted (CAL-03)
- Holidays appear in red (CAL-04)
- Country is configurable via TOML config (CAL-05)
- Config stored at XDG-compliant path (DATA-02)
- All 6 requirements (CAL-01 through CAL-05, DATA-02) satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/02-calendar-holidays/02-02-SUMMARY.md`
</output>

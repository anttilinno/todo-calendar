---
phase: 03-todo-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/store/todo.go
  - internal/store/store.go
autonomous: true

must_haves:
  truths:
    - "Todo data can be created with text, optional date, and auto-assigned ID"
    - "Todos persist to a JSON file and survive app restart"
    - "Missing or empty data file is handled gracefully (returns empty list)"
    - "Atomic writes prevent data corruption on interrupted saves"
  artifacts:
    - path: "internal/store/todo.go"
      provides: "Todo struct, Data struct, date helpers"
      contains: "type Todo struct"
    - path: "internal/store/store.go"
      provides: "Store with Load/Save/Add/Toggle/Delete operations"
      contains: "func (s *Store) Save"
  key_links:
    - from: "internal/store/store.go"
      to: "internal/store/todo.go"
      via: "Store holds Data which contains []Todo"
      pattern: "s\\.data\\.Todos"
    - from: "internal/store/store.go"
      to: "os.CreateTemp + os.Rename"
      via: "atomic write pattern"
      pattern: "os\\.Rename"
---

<objective>
Create the todo data model and JSON persistence layer with atomic file writes and XDG-compliant storage path.

Purpose: Foundation for all todo operations -- the store package provides the data types and persistence that the UI layer (Plan 02) will consume. Without this, there is nothing to display or manipulate.
Output: `internal/store/` package with Todo model, Store (CRUD + atomic persistence), and XDG path resolution.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-todo-management/03-RESEARCH.md

@internal/config/paths.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Todo data model with date-only serialization</name>
  <files>internal/store/todo.go</files>
  <action>
Create `internal/store/todo.go` with:

1. **Todo struct** with fields:
   - `ID int` (json:"id") -- auto-incrementing, assigned by Store
   - `Text string` (json:"text")
   - `Date string` (json:"date,omitempty") -- format "YYYY-MM-DD" or empty string for floating todos. Use string, NOT `time.Time`, to avoid timezone corruption in JSON (see Research pitfall 1).
   - `Done bool` (json:"done")
   - `CreatedAt string` (json:"created_at") -- format "YYYY-MM-DD"

2. **Data struct** (top-level JSON envelope):
   - `NextID int` (json:"next_id")
   - `Todos []Todo` (json:"todos")

3. **Helper methods on Todo:**
   - `HasDate() bool` -- returns `t.Date != ""`
   - `InMonth(year int, month time.Month) bool` -- parses date string, returns true if year/month match. Returns false if no date or parse error.

4. **Package-level constant:** `dateFormat = "2006-01-02"` for consistent date parsing.

Use `time.Parse(dateFormat, t.Date)` for date parsing in helpers. Import only `time`.
  </action>
  <verify>
`cd /home/antti/Repos/Misc/todo-calendar && go build ./internal/store/...` compiles without errors.
  </verify>
  <done>Todo and Data structs exist with correct JSON tags, HasDate and InMonth helpers work, dateFormat constant defined. No timezone-carrying types in serialized fields.</done>
</task>

<task type="auto">
  <name>Task 2: JSON store with atomic writes and CRUD operations</name>
  <files>internal/store/store.go</files>
  <action>
Create `internal/store/store.go` with:

1. **Store struct** with fields:
   - `path string` -- full path to todos.json
   - `data Data` -- in-memory state

2. **TodosPath() (string, error)** -- package-level function. Uses `os.UserConfigDir()` (same pattern as `config/paths.go`) to return `~/.config/todo-calendar/todos.json`. This keeps data co-located with config.

3. **NewStore(path string) (*Store, error)** -- constructor. Calls `load()`. If file missing or empty, initializes with `Data{NextID: 1, Todos: []Todo{}}`. If file exists with content, unmarshal it.

4. **load() error** -- private method:
   - `os.ReadFile(s.path)` -- if `os.IsNotExist(err)`, set defaults and return nil
   - If file exists but `len(b) == 0`, treat as missing (return defaults) -- see Research pitfall 4
   - Otherwise `json.Unmarshal(b, &s.data)`

5. **Save() error** -- atomic write:
   - `json.MarshalIndent(s.data, "", "  ")` + append `'\n'` for POSIX
   - `os.MkdirAll(dir, 0755)` on parent directory
   - `os.CreateTemp(dir, ".todos-*.tmp")` -- temp file in same directory for same-filesystem rename
   - Write -> `tmp.Sync()` -> `tmp.Close()` -> `os.Rename(tmpName, s.path)`
   - On any error before rename: `tmp.Close()` + `os.Remove(tmpName)` cleanup

6. **Add(text string, date string) Todo** -- creates todo with `s.data.NextID`, increments NextID, appends to Todos, calls `s.Save()`, returns the new Todo.

7. **Toggle(id int)** -- finds todo by ID, flips `Done`, calls `s.Save()`.

8. **Delete(id int)** -- removes todo with matching ID from slice, calls `s.Save()`.

9. **Todos() []Todo** -- returns `s.data.Todos` (read-only access).

10. **TodosForMonth(year int, month time.Month) []Todo** -- filters todos where `InMonth(year, month)` is true. Sort by date ascending (string sort is fine for YYYY-MM-DD format), then by ID for same-date stability.

11. **FloatingTodos() []Todo** -- filters todos where `!HasDate()`. Sort by ID ascending.

Imports: `encoding/json`, `os`, `path/filepath`, `sort`, `time` (for time.Month parameter type and `time.Now().Format(dateFormat)` in Add).

Do NOT use `ioutil` (deprecated). Do NOT use async I/O via tea.Cmd for saves -- synchronous is fine for a single small JSON file.
  </action>
  <verify>
`cd /home/antti/Repos/Misc/todo-calendar && go build ./internal/store/...` compiles without errors. `go vet ./internal/store/...` passes.
  </verify>
  <done>Store loads from disk (or creates defaults), Add/Toggle/Delete mutate and persist atomically, TodosForMonth and FloatingTodos filter correctly. TodosPath returns XDG-compliant path.</done>
</task>

</tasks>

<verification>
1. `go build ./internal/store/...` -- package compiles
2. `go vet ./internal/store/...` -- no issues
3. The store package has no dependency on Bubble Tea or any UI package (clean separation)
4. JSON tags use `omitempty` on Date field (floating todos have no date key in JSON)
5. Atomic write uses CreateTemp + Rename pattern (grep for `os.Rename` in store.go)
</verification>

<success_criteria>
- `internal/store/todo.go` exists with Todo struct, Data struct, HasDate/InMonth helpers
- `internal/store/store.go` exists with NewStore, Save (atomic), Add, Toggle, Delete, TodosForMonth, FloatingTodos
- Package compiles and passes vet
- No new Go module dependencies added
- Date stored as string "YYYY-MM-DD", not time.Time
</success_criteria>

<output>
After completion, create `.planning/phases/03-todo-management/03-01-SUMMARY.md`
</output>

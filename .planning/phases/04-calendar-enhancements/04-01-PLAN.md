---
phase: 04-calendar-enhancements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/config/config.go
  - internal/store/store.go
  - internal/calendar/grid.go
  - internal/calendar/styles.go
  - main.go
autonomous: true

must_haves:
  truths:
    - "Config accepts first_day_of_week string field instead of monday_start bool"
    - "Store can return per-day counts of incomplete todos for a given month"
    - "Calendar grid renders all cells at uniform 4-character width"
    - "Dates with incomplete todos display bracket indicators [N]"
    - "Dates without incomplete todos display without brackets"
    - "Weekday header aligns with 4-char cell grid"
  artifacts:
    - path: "internal/config/config.go"
      provides: "FirstDayOfWeek string field with MondayStart() convenience method"
      contains: "FirstDayOfWeek"
    - path: "internal/store/store.go"
      provides: "IncompleteTodosPerDay method"
      contains: "func (s *Store) IncompleteTodosPerDay"
    - path: "internal/calendar/grid.go"
      provides: "4-char cell grid with indicator support"
      contains: "indicators map[int]int"
  key_links:
    - from: "internal/config/config.go"
      to: "main.go"
      via: "cfg.MondayStart() method call replaces cfg.MondayStart field"
      pattern: "cfg\\.MondayStart\\(\\)"
    - from: "internal/store/store.go"
      to: "internal/calendar/grid.go"
      via: "indicators map consumed by RenderGrid"
      pattern: "indicators map\\[int\\]int"
---

<objective>
Add the data layer and rendering foundation for Phase 4 calendar enhancements: migrate config field from `monday_start` bool to `first_day_of_week` string, add a store method for per-day incomplete todo counts, and overhaul the calendar grid to use 4-character-wide cells with bracket indicators.

Purpose: These are the core building blocks that Plan 02 will wire into the calendar model and app layout.
Output: Updated config.go, store.go, grid.go, styles.go, and main.go with all new logic in place but not yet connected to the calendar model.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-calendar-enhancements/04-RESEARCH.md
@internal/config/config.go
@internal/store/store.go
@internal/store/todo.go
@internal/calendar/grid.go
@internal/calendar/styles.go
@main.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate config field and add store query method</name>
  <files>
    internal/config/config.go
    internal/store/store.go
    main.go
  </files>
  <action>
    1. In `internal/config/config.go`:
       - Replace `MondayStart bool` field with `FirstDayOfWeek string` field, TOML tag `first_day_of_week`
       - Update `DefaultConfig()` to set `FirstDayOfWeek: "sunday"` (replaces `MondayStart: false`)
       - Add a convenience method `func (c Config) MondayStart() bool { return c.FirstDayOfWeek == "monday" }`
       - This keeps downstream code (calendar model, app model) working via `MondayStart()` method calls

    2. In `main.go`:
       - Change `cfg.MondayStart` (field access) to `cfg.MondayStart()` (method call) on the line that creates the app model
       - This is a single character change: add `()`

    3. In `internal/store/store.go`:
       - Add method `IncompleteTodosPerDay(year int, month time.Month) map[int]int`
       - Iterate `s.data.Todos`, skip if `t.Done` or `!t.InMonth(year, month)`
       - Parse date with `time.Parse(dateFormat, t.Date)`, skip on error
       - Increment `counts[d.Day()]` for matching todos
       - Return the counts map
       - Import `time` is already present in store.go

    Note: Do NOT change the `dateFormat` constant -- it is already defined in `todo.go` in the same package and accessible.
  </action>
  <verify>
    Run `go build ./...` from the project root -- must compile without errors.
    Run `go vet ./...` -- must pass with no issues.
  </verify>
  <done>
    Config struct has FirstDayOfWeek string field with MondayStart() method. Store has IncompleteTodosPerDay method. main.go calls cfg.MondayStart(). Project compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Overhaul calendar grid to 4-char cells with indicator support</name>
  <files>
    internal/calendar/grid.go
    internal/calendar/styles.go
  </files>
  <action>
    1. In `internal/calendar/grid.go`:
       - Update the `RenderGrid` function signature to accept an additional parameter: `indicators map[int]int` (day number to count of incomplete todos)
       - Change grid width from 20 to 34 chars (7 cells x 4 chars + 6 x 1 char separator)
       - Update the title centering to use 34 instead of 20
       - Replace weekday headers with 4-char-per-day aligned versions:
         - Monday start: `" Mo  Tu  We  Th  Fr  Sa  Su"` (each label is 4 chars: space + 2-letter + space, joined by single space separators -- but simpler: use an array of 4-char strings joined by single space)
         - Actually, use arrays for clarity:
           ```
           mondayHdr  = " Mo  Tu  We  Th  Fr  Sa  Su"
           sundayHdr  = " Su  Mo  Tu  We  Th  Fr  Sa"
           ```
         - These must be exactly 34 chars wide to match the grid. Calculate: each day is 4 chars, 7 days = 28 chars, plus 6 single-space separators = 34 chars. So each header element is `_XX_` (space, two-letter, space) = 4 chars, joined by single space.
         - Verify: `" Mo " + " " + " Tu " + " " + ...` = 4+1+4+1+4+1+4+1+4+1+4+1+4 = 34. Correct.
       - Update leading blanks: each blank cell is now 4 chars + 1 separator = 5 chars per blank slot (but last blank before first day has no trailing separator -- handle carefully). Simplest: write `"    "` (4 spaces) for each blank cell, then `" "` separator if not the last column.
         - Actually, match the day cell pattern: for each blank column, write `"    "` (4 spaces), then if not the last column in the row, write `" "` (1 space separator).
       - Format day cells using a helper approach:
         - If `indicators[day] > 0`: cell = `fmt.Sprintf("[%2d]", day)` (4 chars: `[ 5]` or `[15]`)
         - Else: cell = `fmt.Sprintf(" %2d ", day)` (4 chars: ` 5 ` or ` 15`)
       - Apply lipgloss styles AFTER formatting to 4-char width (same pattern as current code -- format first, style second)
       - Add a new style priority: indicator dates. The style priority should be: today > holiday > indicator > normal. For indicator style, use the `indicatorStyle` from styles.go.
       - Separator between cells: `" "` (single space), same as before but cells are now 4 chars instead of 2
       - End-of-row: newline when col == 7, same logic as before

    2. In `internal/calendar/styles.go`:
       - Add `indicatorStyle` variable: `lipgloss.NewStyle().Bold(true)` -- brackets make the indicator visually distinct; bold adds emphasis. Keep it simple since Phase 6 (Themes) will overhaul all styles.

    3. IMPORTANT: After this task, the `RenderGrid` function has a new `indicators` parameter, but the caller in `calendar/model.go` View() has NOT been updated yet. This will cause a compile error that Plan 02 fixes. This is expected -- Plan 02 handles wiring.

    Actually, to keep the project compilable between tasks, temporarily update the View() call in model.go to pass `nil` for indicators:
       - In `internal/calendar/model.go` View(): change `RenderGrid(m.year, m.month, todayDay, m.holidays, m.mondayStart)` to `RenderGrid(m.year, m.month, todayDay, m.holidays, m.mondayStart, nil)`
       - RenderGrid must handle nil indicators gracefully (treat as empty map -- `indicators[day]` on a nil map returns 0 in Go, so this works automatically)
  </action>
  <verify>
    Run `go build ./...` from the project root -- must compile without errors.
    Run `go vet ./...` -- must pass.
    Visually verify grid output is correct: run `go run .` and confirm the calendar renders with 4-char-wide cells, proper alignment, and the weekday header matches the cell widths. Dates should show as ` 5 ` or ` 15` (no brackets yet since indicators are nil).
  </verify>
  <done>
    RenderGrid accepts indicators parameter. All cells are 4 chars wide. Weekday header aligns with cells. Grid is 34 chars wide. indicatorStyle exists. Project compiles and runs (with nil indicators for now).
  </done>
</task>

</tasks>

<verification>
- `go build ./...` passes
- `go vet ./...` passes
- App launches and displays calendar with wider 4-char cells
- Weekday header aligns with date columns
- Config file can use `first_day_of_week = "monday"` or `first_day_of_week = "sunday"`
</verification>

<success_criteria>
- Config struct uses FirstDayOfWeek string field with MondayStart() convenience method
- Store has IncompleteTodosPerDay method that returns day-to-count map
- RenderGrid renders uniform 4-char cells with indicator bracket support
- Project compiles and runs correctly with the wider grid
</success_criteria>

<output>
After completion, create `.planning/phases/04-calendar-enhancements/04-01-SUMMARY.md`
</output>

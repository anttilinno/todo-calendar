---
phase: 04-calendar-enhancements
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - internal/calendar/model.go
  - internal/app/model.go
autonomous: true

must_haves:
  truths:
    - "Calendar dates with incomplete todos display bracket indicators [N]"
    - "Dates with only completed todos show no indicator"
    - "Calendar grid alignment is maintained with indicators present"
    - "Toggling a todo complete/incomplete immediately updates the calendar indicator"
    - "Navigating months updates indicators for the new month"
    - "calendarInnerWidth accommodates the wider 34-char grid"
  artifacts:
    - path: "internal/calendar/model.go"
      provides: "Calendar model with store reference and indicator data"
      contains: "store *store.Store"
    - path: "internal/app/model.go"
      provides: "Updated layout width and store passed to calendar"
      contains: "calendarInnerWidth"
  key_links:
    - from: "internal/calendar/model.go"
      to: "internal/store/store.go"
      via: "store.IncompleteTodosPerDay call in View or on month change"
      pattern: "s\\.IncompleteTodosPerDay|store\\.IncompleteTodosPerDay"
    - from: "internal/calendar/model.go"
      to: "internal/calendar/grid.go"
      via: "RenderGrid receives indicators parameter"
      pattern: "RenderGrid.*indicators"
    - from: "internal/app/model.go"
      to: "internal/calendar/model.go"
      via: "calendar.New receives store parameter"
      pattern: "calendar\\.New.*store"
---

<objective>
Wire the indicator data through the calendar model and update the app layout to accommodate the wider grid. This plan connects the store query (from Plan 01) to the calendar rendering, ensures indicators refresh on todo mutations and month navigation, and updates the layout width constant.

Purpose: Complete the end-to-end indicator feature and finalize all Phase 4 requirements.
Output: Fully functional date indicators and configurable first day of week, visible in the running app.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-calendar-enhancements/04-RESEARCH.md
@.planning/phases/04-calendar-enhancements/04-01-SUMMARY.md
@internal/calendar/model.go
@internal/app/model.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire store into calendar model for indicator data</name>
  <files>
    internal/calendar/model.go
  </files>
  <action>
    1. Add `store *store.Store` field to the Model struct (import `github.com/antti/todo-calendar/internal/store`)
    2. Add `indicators map[int]int` field to the Model struct for cached per-day counts
    3. Update the `New` constructor to accept `s *store.Store` as a third parameter:
       `func New(provider *holidays.Provider, mondayStart bool, s *store.Store) Model`
    4. In `New`, initialize `indicators` by calling `s.IncompleteTodosPerDay(y, m)` and store the `store` reference
    5. In the `Update` method, when month changes (PrevMonth and NextMonth key handlers), refresh indicators alongside holidays:
       - After `m.holidays = m.provider.HolidaysInMonth(m.year, m.month)`, add:
         `m.indicators = m.store.IncompleteTodosPerDay(m.year, m.month)`
    6. Add a public method `RefreshIndicators()` that recomputes indicators for the current month:
       ```
       func (m *Model) RefreshIndicators() {
           m.indicators = m.store.IncompleteTodosPerDay(m.year, m.month)
       }
       ```
       This will be called by the app model after todo mutations.
    7. In the `View` method, replace the nil indicators with actual data:
       Change `RenderGrid(m.year, m.month, todayDay, m.holidays, m.mondayStart, nil)`
       to `RenderGrid(m.year, m.month, todayDay, m.holidays, m.mondayStart, m.indicators)`
  </action>
  <verify>
    Run `go build ./...` -- will fail because app/model.go still calls `calendar.New(provider, mondayStart)` with 2 args instead of 3. This is expected and fixed in Task 2.
  </verify>
  <done>
    Calendar model has store reference, indicators field, refreshes indicators on month change, and passes indicators to RenderGrid. RefreshIndicators method exists for external callers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update app model layout width and wire store to calendar</name>
  <files>
    internal/app/model.go
  </files>
  <action>
    1. Update `calendar.New` call in `app.New` to pass the store:
       Change `calendar.New(provider, mondayStart)` to `calendar.New(provider, mondayStart, s)`
    2. Update `calendarInnerWidth` constant in the `View` method:
       - Old: `calendarInnerWidth := 24` (20-char grid + 4 padding/border)
       - New: `calendarInnerWidth := 38` (34-char grid + 4 padding/border)
       - Breakdown: grid is 34 chars, `Padding(0, 1)` adds 2 chars, border adds 2 chars = 38
       - Actually check: `paneStyle(true).GetFrameSize()` returns (frameH, frameV). The `frameH` accounts for border + padding on both sides. Currently `calendarInnerWidth` is the WIDTH passed to `.Width()`, and lipgloss adds frame on top. So `calendarInnerWidth` should be the inner content width = 34 chars (the grid width). Let me verify: currently it is 24, and the grid is 20 chars wide. That means 24 = 20 + some padding. Looking at paneStyle, it likely adds padding. Actually, the `Width()` sets the inner width, and `paneStyle` border/padding is added by `GetFrameSize`. The current value 24 for a 20-char grid means 4 chars of internal padding (Padding(0,1) = 1 on each side = 2, but 24-20=4 suggests Padding(0,2)). Read the pane style to confirm.
       - Simpler approach: the grid grew from 20 to 34 chars = +14 chars. So increase calendarInnerWidth from 24 to 38.
       - Set: `calendarInnerWidth := 38`
    3. Add indicator refresh after todo mutations. In the `Update` method, after routing to the todoPane child:
       ```
       case todoPane:
           m.todoList, cmd = m.todoList.Update(msg)
           m.calendar.RefreshIndicators()
       ```
       This ensures that after any todo add/toggle/delete, the calendar indicators update immediately.
       Also refresh after tab-switching and month sync to catch any changes:
       - The existing `m.todoList.SetViewMonth(...)` calls already sync months. Add `m.calendar.RefreshIndicators()` after the month sync in the calendar pane routing too, so indicators refresh when navigating months.

    4. Actually, the simplest and most reliable approach: call `m.calendar.RefreshIndicators()` at the END of every Update cycle, right before `return m, cmd`. This is negligible cost (iterating tens of todos) and guarantees indicators are always fresh. The research confirms this is fine for a personal app.
       - Place the refresh call just before the final `return m, cmd` at the bottom of Update, after the switch on activePane.
  </action>
  <verify>
    Run `go build ./...` from the project root -- must compile.
    Run `go vet ./...` -- must pass.
    Run the app with `go run .`:
    1. Calendar should display with wider cells and proper alignment
    2. Add a todo with a date (press 'a', type text, enter, type date, enter) -- the calendar date should show brackets like `[ 5]`
    3. Toggle the todo complete (press space) -- the bracket indicator should disappear
    4. Toggle it back incomplete -- bracket returns
    5. Navigate to a different month and back -- indicators correct
    6. Test with `first_day_of_week = "monday"` in config.toml -- header should show Mo first
  </verify>
  <done>
    - calendar.New receives store, calendarInnerWidth is 38, indicators refresh after every update cycle
    - Bracket indicators appear on dates with incomplete todos and disappear when all todos on that date are done
    - First day of week configurable via config.toml
    - Grid alignment maintained throughout
    - All Phase 4 requirements (INDI-01, INDI-02, INDI-03, FDOW-01, FDOW-02, FDOW-03) satisfied
  </done>
</task>

</tasks>

<verification>
- `go build ./...` passes
- `go vet ./...` passes
- App launches with wider calendar grid, proper alignment
- Adding a dated todo shows `[N]` bracket indicator on that date
- Completing all todos on a date removes the indicator
- Toggling a todo immediately updates the indicator
- Month navigation refreshes indicators correctly
- `first_day_of_week = "monday"` in config.toml changes header and grid layout
- `first_day_of_week = "sunday"` (or absent) defaults to Sunday start
</verification>

<success_criteria>
- INDI-01: Calendar dates with incomplete todos display bracket indicators [N]
- INDI-02: Dates with only completed todos render without indicators
- INDI-03: Calendar grid columns and rows remain properly aligned
- FDOW-01: User can set first_day_of_week in config.toml
- FDOW-02: Calendar grid renders with configured first day
- FDOW-03: Day-of-week header reflects configured start day
</success_criteria>

<output>
After completion, create `.planning/phases/04-calendar-enhancements/04-02-SUMMARY.md`
</output>

---
phase: 08-settings-overlay
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/config/config.go
  - internal/theme/theme.go
  - internal/settings/model.go
  - internal/settings/keys.go
  - internal/settings/styles.go
  - internal/calendar/model.go
  - internal/todolist/model.go
autonomous: true

must_haves:
  truths:
    - "config.Save() writes a Config struct to config.toml atomically"
    - "theme.Names() returns the list of available theme names"
    - "Settings model renders 3 cycling options (theme, country, first day)"
    - "SetTheme() on calendar and todolist replaces styles without losing state"
  artifacts:
    - path: "internal/config/config.go"
      provides: "Save function for atomic TOML write-back"
      contains: "func Save"
    - path: "internal/theme/theme.go"
      provides: "Names() helper returning available theme names"
      contains: "func Names"
    - path: "internal/settings/model.go"
      provides: "Settings overlay Model with Update/View and message types"
      exports: ["Model", "New", "ThemeChangedMsg", "SaveMsg", "CancelMsg"]
    - path: "internal/settings/keys.go"
      provides: "KeyMap for settings navigation"
      contains: "func DefaultKeyMap"
    - path: "internal/settings/styles.go"
      provides: "Themed styles for settings overlay"
      contains: "func NewStyles"
    - path: "internal/calendar/model.go"
      provides: "SetTheme, SetProvider, SetMondayStart methods"
      contains: "func (m *Model) SetTheme"
    - path: "internal/todolist/model.go"
      provides: "SetTheme method"
      contains: "func (m *Model) SetTheme"
  key_links:
    - from: "internal/settings/model.go"
      to: "internal/config/config.go"
      via: "Config() method returns config.Config from current selections"
      pattern: "func \\(m Model\\) Config\\(\\)"
    - from: "internal/settings/model.go"
      to: "internal/theme/theme.go"
      via: "Uses theme.Names() for theme option values"
      pattern: "theme\\.Names\\(\\)"
    - from: "internal/settings/model.go"
      to: "internal/holidays/registry.go"
      via: "Uses holidays.SupportedCountries() for country option values"
      pattern: "holidays\\.SupportedCountries\\(\\)"
---

<objective>
Build the settings overlay component and supporting infrastructure: Config.Save() for writing settings to disk, theme.Names() for theme enumeration, the settings Model with cycling options and message types, and SetTheme/SetProvider/SetMondayStart methods on existing models for runtime reconfiguration.

Purpose: These are the building blocks that Plan 02 will wire into the app model to create the full settings overlay experience.
Output: A complete `internal/settings/` package, an enhanced config package with Save(), and runtime reconfiguration methods on calendar and todolist models.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-settings-overlay/08-RESEARCH.md

@internal/config/config.go
@internal/config/paths.go
@internal/theme/theme.go
@internal/holidays/registry.go
@internal/calendar/model.go
@internal/todolist/model.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Config.Save() and theme.Names()</name>
  <files>internal/config/config.go, internal/theme/theme.go</files>
  <action>
  1. In `internal/config/config.go`, add a `Save(cfg Config) error` function:
     - Call `Path()` to get the config file path
     - Call `os.MkdirAll(filepath.Dir(path), 0755)` to ensure the directory exists (first-time use)
     - Use `toml.NewEncoder(&buf).Encode(cfg)` to serialize the Config struct (import `bytes` and `path/filepath`)
     - Write atomically using the temp-file-rename pattern (same as store.Save()): `os.CreateTemp(dir, ".config-*.tmp")` -> write -> `tmp.Sync()` -> `tmp.Close()` -> `os.Rename(tmpName, path)`
     - Handle errors at each step: close and remove temp file on failure
     - Add required imports: `bytes`, `path/filepath`

  2. In `internal/theme/theme.go`, add a `Names() []string` function:
     - Return `[]string{"dark", "light", "nord", "solarized"}` -- matching the cases in ForName()
     - This is the single source of truth for available theme names; settings will use it instead of hardcoding
  </action>
  <verify>
  `cd /home/antti/Repos/Misc/todo-calendar && go build ./...` compiles without errors.
  `go vet ./internal/config/... ./internal/theme/...` passes.
  </verify>
  <done>
  - `config.Save()` exists and writes Config to config.toml atomically with directory creation
  - `theme.Names()` exists and returns the 4 theme names
  </done>
</task>

<task type="auto">
  <name>Task 2: Create settings package (model, keys, styles)</name>
  <files>internal/settings/model.go, internal/settings/keys.go, internal/settings/styles.go</files>
  <action>
  Create the `internal/settings/` package with three files:

  **internal/settings/keys.go:**
  - Define `KeyMap` struct with fields: Up, Down, Left, Right, Save, Cancel (all `key.Binding`)
  - `DefaultKeyMap()` returns:
    - Up: "k", "up" -- help "k/up", "up"
    - Down: "j", "down" -- help "j/dn", "down"
    - Left: "h", "left" -- help "h/<-", "prev"
    - Right: "l", "right" -- help "l/->", "next"
    - Save: "enter" -- help "enter", "save"
    - Cancel: "esc" -- help "esc", "cancel"
  - Implement `ShortHelp()` returning [Left, Right, Up, Down, Save, Cancel]
  - Implement `FullHelp()` wrapping ShortHelp in a single group

  **internal/settings/styles.go:**
  - Define `Styles` struct with fields: Title, Label, Value, SelectedLabel, SelectedValue, Hint (all `lipgloss.Style`)
  - `NewStyles(t theme.Theme) Styles`:
    - Title: Bold, Foreground(t.AccentFg)
    - Label: Foreground(t.NormalFg)
    - Value: Foreground(t.MutedFg)
    - SelectedLabel: Foreground(t.AccentFg), Bold
    - SelectedValue: Foreground(t.AccentFg)
    - Hint: Foreground(t.MutedFg)

  **internal/settings/model.go:**
  - Define `option` struct: label string, values []string, display []string, index int
  - Define message types:
    - `ThemeChangedMsg struct { Theme theme.Theme }` -- emitted when user cycles theme
    - `SaveMsg struct { Cfg config.Config }` -- emitted on Enter
    - `CancelMsg struct{}` -- emitted on Escape
  - Define `Model` struct: options []option, cursor int, width int, height int, keys KeyMap, styles Styles
  - `New(cfg config.Config, t theme.Theme) Model`:
    - Theme option: values from `theme.Names()`, display as Title Case (capitalize first letter of each name)
    - Country option: values from `holidays.SupportedCountries()`, display via `countryLabels()` helper (map of 11 country codes to "XX - Country Name")
    - First Day option: values ["sunday", "monday"], display ["Sunday", "Monday"]
    - Set each option's index to match the current config value using an `indexOf` helper
    - Initialize keys with DefaultKeyMap(), styles with NewStyles(t)
  - `Config() config.Config` -- returns a config.Config from current option selections (theme = options[0].values[index], country = options[1].values[index], firstDayOfWeek = options[2].values[index])
  - `SetTheme(t theme.Theme)` -- replaces m.styles with NewStyles(t)
  - `SetSize(w, h int)` -- stores width and height for centered rendering
  - `Update(msg tea.Msg) (Model, tea.Cmd)`:
    - Handle tea.KeyMsg:
      - Up/Down: move cursor between 0 and len(options)-1
      - Left/Right: cycle current option's index (wrap around)
      - If cycling theme (cursor==0): return a cmd that produces ThemeChangedMsg{theme.ForName(newValue)}
      - Save (Enter): return a cmd that produces SaveMsg{m.Config()}
      - Cancel (Escape): return a cmd that produces CancelMsg{}
    - Handle tea.WindowSizeMsg: store width/height
  - `View() string`:
    - Render title "Settings" with Title style, centered horizontally in m.width
    - For each option: render label + "< value >" format
    - Selected row uses SelectedLabel/SelectedValue styles, with ">" prefix
    - Unselected rows use Label/Value styles, with "  " prefix
    - Add hint line at bottom: "enter save | esc cancel | <-/-> change"
    - Center the content block vertically using m.height (pad top with newlines)
  - Helper `indexOf(slice []string, val string) int` -- returns index or 0 if not found
  - Helper `countryLabels(codes []string) []string` -- maps codes to "XX - Country Name" using a local map of 11 entries (de->Germany, dk->Denmark, ee->Estonia, es->Spain, fi->Finland, fr->France, gb->United Kingdom, it->Italy, no->Norway, se->Sweden, us->United States)
  - `HelpBindings() []key.Binding` -- returns settings-specific key bindings for help bar display
  </action>
  <verify>
  `cd /home/antti/Repos/Misc/todo-calendar && go build ./...` compiles without errors.
  `go vet ./internal/settings/...` passes.
  </verify>
  <done>
  - Settings package exists with Model, keys, styles
  - Model can be created from a config.Config, renders 3 cycling options
  - Model emits ThemeChangedMsg, SaveMsg, CancelMsg via Update
  - Config() returns a config.Config reflecting current selections
  </done>
</task>

<task type="auto">
  <name>Task 3: Add SetTheme/SetProvider/SetMondayStart to calendar and todolist</name>
  <files>internal/calendar/model.go, internal/todolist/model.go</files>
  <action>
  1. In `internal/calendar/model.go`, add three pointer-receiver methods:
     - `func (m *Model) SetTheme(t theme.Theme)` -- sets `m.styles = NewStyles(t)`. Do NOT recreate the model (preserves year, month, cursor, provider state).
     - `func (m *Model) SetProvider(p *holidays.Provider)` -- sets `m.provider = p` and refreshes holidays for current month: `m.holidays = p.HolidaysInMonth(m.year, m.month)`.
     - `func (m *Model) SetMondayStart(v bool)` -- sets `m.mondayStart = v`.

  2. In `internal/todolist/model.go`, add one pointer-receiver method:
     - `func (m *Model) SetTheme(t theme.Theme)` -- sets `m.styles = NewStyles(t)`. Do NOT recreate the model (preserves cursor, mode, input state).

  These methods enable runtime reconfiguration without state loss, which Plan 02 uses for live theme preview and settings save.
  </action>
  <verify>
  `cd /home/antti/Repos/Misc/todo-calendar && go build ./...` compiles without errors.
  `go vet ./internal/calendar/... ./internal/todolist/...` passes.
  </verify>
  <done>
  - calendar.Model has SetTheme(), SetProvider(), SetMondayStart() pointer-receiver methods
  - todolist.Model has SetTheme() pointer-receiver method
  - All methods modify fields in place without recreating the model
  </done>
</task>

</tasks>

<verification>
```bash
cd /home/antti/Repos/Misc/todo-calendar
go build ./...
go vet ./...
go test ./...
```
All must pass. The settings package is self-contained and the new methods on calendar/todolist don't change existing behavior.
</verification>

<success_criteria>
- `config.Save()` writes Config to TOML atomically with os.MkdirAll
- `theme.Names()` returns ["dark", "light", "nord", "solarized"]
- `internal/settings/` package exists with Model, KeyMap, Styles
- Settings Model renders 3 options, emits ThemeChangedMsg/SaveMsg/CancelMsg
- calendar.Model has SetTheme/SetProvider/SetMondayStart methods
- todolist.Model has SetTheme method
- `go build ./...` and `go test ./...` pass
</success_criteria>

<output>
After completion, create `.planning/phases/08-settings-overlay/08-01-SUMMARY.md`
</output>

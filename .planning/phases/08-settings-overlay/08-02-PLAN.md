---
phase: 08-settings-overlay
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - internal/app/model.go
  - internal/app/keys.go
  - main.go
autonomous: false

must_haves:
  truths:
    - "User can open settings overlay by pressing 's' from any pane"
    - "User can cycle theme and see the entire app redraw with new colors immediately"
    - "User can cycle country and first day of week in the settings overlay"
    - "User can press Enter to save all settings to config.toml and return to main view"
    - "User can press Escape to cancel and revert any previewed theme changes"
    - "Help bar shows settings-specific keys when overlay is open"
    - "Pressing 's' while typing a todo does NOT open settings"
  artifacts:
    - path: "internal/app/model.go"
      provides: "Settings overlay routing, live preview, save/cancel handling"
      contains: "showSettings"
    - path: "internal/app/keys.go"
      provides: "Settings keybinding on 's'"
      contains: "Settings"
    - path: "main.go"
      provides: "Config passed to app.New for snapshot/save"
      contains: "cfg"
  key_links:
    - from: "internal/app/model.go"
      to: "internal/settings/model.go"
      via: "Routes all input to settings.Model when showSettings is true"
      pattern: "m\\.showSettings"
    - from: "internal/app/model.go"
      to: "settings.ThemeChangedMsg"
      via: "Catches ThemeChangedMsg and calls applyTheme on all children"
      pattern: "settings\\.ThemeChangedMsg"
    - from: "internal/app/model.go"
      to: "settings.SaveMsg"
      via: "Catches SaveMsg, calls config.Save, rebuilds provider if country changed"
      pattern: "settings\\.SaveMsg"
    - from: "internal/app/model.go"
      to: "settings.CancelMsg"
      via: "Catches CancelMsg, restores savedConfig snapshot, reverts theme"
      pattern: "settings\\.CancelMsg"
    - from: "internal/app/model.go"
      to: "internal/config/config.go"
      via: "Calls config.Save() on save, stores config for snapshot/restore"
      pattern: "config\\.Save"
---

<objective>
Wire the settings overlay into the app model: add the "s" keybinding, route input to settings when overlay is open, handle live theme preview via ThemeChangedMsg, save settings to config.toml on Enter, and revert on Escape. Also update main.go to pass config into app.New.

Purpose: This completes the settings overlay feature -- users can configure theme, country, and first day of week from inside the app with live preview, save, and cancel.
Output: A fully functional settings overlay accessible from any pane.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-settings-overlay/08-RESEARCH.md
@.planning/phases/08-settings-overlay/08-01-SUMMARY.md

@internal/app/model.go
@internal/app/keys.go
@internal/app/styles.go
@internal/settings/model.go
@internal/config/config.go
@main.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire settings overlay into app model</name>
  <files>internal/app/model.go, internal/app/keys.go, main.go</files>
  <action>
  **internal/app/keys.go:**
  - Add `Settings key.Binding` field to KeyMap struct
  - In DefaultKeyMap(), add: `Settings: key.NewBinding(key.WithKeys("s"), key.WithHelp("s", "settings"))`
  - Update ShortHelp() and FullHelp() to include Settings binding

  **internal/app/model.go:**
  - Add fields to Model struct:
    - `showSettings bool`
    - `settings settings.Model`
    - `cfg config.Config` (current active config)
    - `savedConfig config.Config` (snapshot for cancel/revert)
  - Update `New()` signature to accept `cfg config.Config` in addition to existing params. Store cfg on the model. Import `settings` and `config` packages.
  - In `Update()`, add settings overlay routing BEFORE existing key handling:
    - When `m.showSettings` is true, call `m.updateSettings(msg)` for ALL messages (including tea.WindowSizeMsg -- forward to settings model via SetSize)
    - Exception: tea.WindowSizeMsg should ALSO update m.width/m.height and propagate to children even when settings is open (so the app resizes correctly)
  - Add settings key handler in the existing tea.KeyMsg switch:
    - `case key.Matches(msg, m.keys.Settings) && !isInputting:` -- opens settings
    - On open: snapshot `m.savedConfig = m.cfg`, create `m.settings = settings.New(m.cfg, theme.ForName(m.cfg.Theme))`, set `m.showSettings = true`
    - Pass current window size to settings: `m.settings.SetSize(m.width, m.height)`
  - Add `updateSettings(msg tea.Msg) (tea.Model, tea.Cmd)` method:
    - Forward msg to `m.settings.Update(msg)` first
    - Then switch on returned cmd's message type by running the cmd and checking:
      - Actually, use the pattern: forward to settings, get back (newSettings, cmd), then switch on msg type for the settings-specific messages
      - For tea.KeyMsg: forward to settings.Update, which returns cmds producing ThemeChangedMsg/SaveMsg/CancelMsg
      - For settings.ThemeChangedMsg: call `m.applyTheme(msg.Theme)` and update `m.cfg.Theme` to match
      - For settings.SaveMsg: set `m.cfg = msg.Cfg`, call `config.Save(m.cfg)`, close overlay (`m.showSettings = false`), rebuild provider if country changed (`holidays.NewProvider(m.cfg.Country)`), update calendar (`m.calendar.SetProvider(provider)`, `m.calendar.SetMondayStart(m.cfg.MondayStart())`), refresh calendar holidays/indicators
      - For settings.CancelMsg: restore `m.cfg = m.savedConfig`, call `m.applyTheme(theme.ForName(m.savedConfig.Theme))`, close overlay
    - For tea.WindowSizeMsg when settings is open: update m.width/m.height, propagate to all children AND settings model
  - Add `applyTheme(t theme.Theme)` method:
    - `m.styles = NewStyles(t)`
    - `m.calendar.SetTheme(t)`
    - `m.todoList.SetTheme(t)`
    - `m.settings.SetTheme(t)`
    - Update help styles: `m.help.Styles.ShortKey = lipgloss.NewStyle().Foreground(t.AccentFg)`, same for ShortDesc and ShortSeparator with t.MutedFg
  - In `View()`, add settings check after ready check:
    - `if m.showSettings { return m.settings.View() }` -- full-screen replacement, no pane borders
  - In `currentHelpKeys()`, add settings case:
    - When `m.showSettings` is true, return settings-specific help bindings from `m.settings.HelpBindings()`
    - Add Settings binding to the common bindings appended at the end (alongside Tab and Quit) so it shows in the help bar during normal operation

  **Important implementation detail for message handling:**
  The settings model returns tea.Cmd functions that produce ThemeChangedMsg/SaveMsg/CancelMsg. In Bubble Tea, these commands are executed by the runtime and delivered as messages in the next Update cycle. So the flow is:
  1. User presses Enter in settings -> settings.Update returns cmd producing SaveMsg
  2. Next Update cycle: msg is settings.SaveMsg -> app handles save logic

  In updateSettings, route ALL msgs to settings.Update first, then handle the app-level message types (ThemeChangedMsg, SaveMsg, CancelMsg) in a separate switch. This means updateSettings should handle both routing to settings AND catching settings messages.

  **main.go:**
  - Update `app.New()` call to pass `cfg` as the new parameter: `app.New(provider, cfg.MondayStart(), s, t, cfg)` (add cfg as last param, or adjust param order to match the new signature)
  - The config is needed so the app model can snapshot it for cancel and save it on settings save

  **Keybinding conflict prevention:**
  The "s" key must NOT trigger when todolist is in input mode. The existing `isInputting` check pattern already handles this -- just add the settings key check with `&& !isInputting` like Quit and Tab.
  </action>
  <verify>
  `cd /home/antti/Repos/Misc/todo-calendar && go build ./...` compiles without errors.
  `go vet ./...` passes.
  `go test ./...` passes.
  </verify>
  <done>
  - "s" key opens settings overlay from either pane
  - "s" key does NOT open settings when typing a todo
  - Settings overlay renders full-screen with 3 cycling options
  - Live theme preview works: cycling theme in settings redraws entire app
  - Enter saves all settings to config.toml, rebuilds provider if country changed, closes overlay
  - Escape cancels and reverts any previewed theme changes, closes overlay
  - Help bar shows settings-specific keys when overlay is open
  - Help bar shows "s" for settings during normal operation
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete settings overlay with live theme preview, save, and cancel</what-built>
  <how-to-verify>
  1. Run the app: `cd /home/antti/Repos/Misc/todo-calendar && go run .`
  2. Press "s" -- settings overlay should open full-screen with 3 options (Theme, Country, First Day of Week)
  3. Use j/k to move between options, left/right to cycle values
  4. Cycle theme -- the app should redraw with new colors immediately (live preview)
  5. Press Escape -- theme should revert to the original
  6. Open settings again, change theme and/or country, press Enter -- changes should persist
  7. Restart the app -- saved settings should be active
  8. While in todo pane, start adding a todo (press "a"), type some text including "s" -- "s" should be inserted as text, NOT open settings
  9. Verify help bar shows "s settings" during normal operation and "enter save | esc cancel" during settings
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
```bash
cd /home/antti/Repos/Misc/todo-calendar
go build ./...
go vet ./...
go test ./...
```
All pass. Then manual verification of the full settings flow.
</verification>

<success_criteria>
- "s" opens full-screen settings overlay from any pane (SETT-01)
- Theme cycling shows live preview -- app redraws immediately (SETT-02)
- Country can be changed in settings (SETT-03)
- First day of week can be changed in settings (SETT-04)
- Enter saves all settings to config.toml and closes overlay (SETT-05)
- Escape cancels without saving, reverts previewed changes (SETT-06)
- "s" does not trigger during todo text input
- Help bar context-switches between normal and settings keys
</success_criteria>

<output>
After completion, create `.planning/phases/08-settings-overlay/08-02-SUMMARY.md`
</output>

---
phase: 09-overview-panel
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/store/store.go
  - internal/calendar/styles.go
  - internal/calendar/model.go
autonomous: true

must_haves:
  truths:
    - "Calendar panel displays todo count per month below the calendar grid"
    - "Overview shows count of undated (floating) todos"
    - "Counts update live as todos are added, completed, or deleted"
    - "Currently viewed month is visually distinct in the overview"
  artifacts:
    - path: "internal/store/store.go"
      provides: "TodoCountsByMonth and FloatingTodoCount query methods"
      contains: "func (s *Store) TodoCountsByMonth"
    - path: "internal/calendar/styles.go"
      provides: "OverviewHeader, OverviewCount, OverviewActive styles"
      contains: "OverviewHeader"
    - path: "internal/calendar/model.go"
      provides: "renderOverview method and updated View"
      contains: "func (m Model) renderOverview"
  key_links:
    - from: "internal/calendar/model.go"
      to: "internal/store/store.go"
      via: "m.store.TodoCountsByMonth() and m.store.FloatingTodoCount() calls in renderOverview"
      pattern: "m\\.store\\.TodoCountsByMonth|m\\.store\\.FloatingTodoCount"
    - from: "internal/calendar/model.go"
      to: "internal/calendar/styles.go"
      via: "m.styles.OverviewHeader/OverviewCount/OverviewActive in renderOverview"
      pattern: "m\\.styles\\.Overview"
    - from: "internal/calendar/model.go"
      to: "View() calling renderOverview()"
      via: "View appends renderOverview output below RenderGrid output"
      pattern: "renderOverview"
---

<objective>
Add at-a-glance todo count overview below the calendar grid, showing how many todos exist per month and how many are undated (floating).

Purpose: Users can see where work is concentrated across months without switching views. This is the final feature of the v1.2 milestone.
Output: Calendar panel renders an "Overview" section below the grid with per-month counts and a floating/unknown count, using themed styles. Counts are always fresh because they are computed from the store on every render.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-overview-panel/09-RESEARCH.md

@internal/store/store.go
@internal/store/todo.go
@internal/calendar/model.go
@internal/calendar/styles.go
@internal/theme/theme.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add store aggregation methods and overview styles</name>
  <files>internal/store/store.go, internal/calendar/styles.go</files>
  <action>
**Store methods (internal/store/store.go):**

1. Add a `MonthCount` struct type (exported) with fields `Year int`, `Month time.Month`, `Count int`.

2. Add method `TodoCountsByMonth() []MonthCount` on `*Store`:
   - Iterate `s.data.Todos`, skip todos where `t.Date == ""`.
   - Parse each date with `time.Parse(dateFormat, t.Date)`, skip on error.
   - Group counts using a map keyed by a local `ym` struct `{y int; m time.Month}` (avoids needing `fmt` import).
   - Convert map to slice, sort chronologically (year ascending, then month ascending) using `sort.Slice`.
   - Return the sorted slice.

3. Add method `FloatingTodoCount() int` on `*Store`:
   - Iterate `s.data.Todos`, count todos where `!t.HasDate()`.
   - Return the count.

Both methods are read-only queries with no side effects. They follow the exact pattern of existing `TodosForMonth`, `FloatingTodos`, and `IncompleteTodosPerDay`.

**Calendar styles (internal/calendar/styles.go):**

4. Add three new fields to the `Styles` struct:
   - `OverviewHeader lipgloss.Style` -- for the "Overview" section heading
   - `OverviewCount  lipgloss.Style` -- for non-active month rows
   - `OverviewActive lipgloss.Style` -- for the currently viewed month row

5. Initialize them in `NewStyles(t theme.Theme)`:
   - `OverviewHeader`: `lipgloss.NewStyle().Bold(true).Foreground(t.AccentFg)`
   - `OverviewCount`: `lipgloss.NewStyle().Foreground(t.MutedFg)`
   - `OverviewActive`: `lipgloss.NewStyle().Bold(true).Foreground(t.NormalFg)`
  </action>
  <verify>Run `go build ./...` from project root -- must compile with zero errors. Run `go vet ./...` -- must pass.</verify>
  <done>MonthCount type exported from store package. TodoCountsByMonth returns chronologically sorted month counts. FloatingTodoCount returns count of undated todos. Three new overview styles initialized from theme colors in calendar Styles struct.</done>
</task>

<task type="auto">
  <name>Task 2: Wire overview rendering into calendar View</name>
  <files>internal/calendar/model.go</files>
  <action>
1. Add `"fmt"` and `"strings"` to the import block in `model.go` (if not already present).

2. Add a private method `renderOverview() string` on `Model`:
   - Create a `strings.Builder`.
   - Write a blank line, then the styled "Overview" header using `m.styles.OverviewHeader.Render("Overview")`, then a newline.
   - Call `m.store.TodoCountsByMonth()` to get month counts.
   - For each `MonthCount`:
     - Build a label: just the month name (`mc.Month.String()`) if `mc.Year == m.year`, otherwise `fmt.Sprintf("%s %d", mc.Month.String(), mc.Year)` to disambiguate cross-year entries.
     - Format the line as `fmt.Sprintf(" %-16s[%d]", label, mc.Count)`.
     - If `mc.Year == m.year && mc.Month == m.month`, render with `m.styles.OverviewActive`; otherwise render with `m.styles.OverviewCount`.
     - Write the styled line followed by a newline.
   - After the month loop, render the floating count:
     - `floatingCount := m.store.FloatingTodoCount()`
     - Format as `fmt.Sprintf(" %-16s[%d]", "Unknown", floatingCount)`
     - Render with `m.styles.OverviewCount` (floating row is never "active").
     - Write styled line followed by a newline.
   - Return `b.String()`.

3. Modify the existing `View() string` method:
   - After the existing `RenderGrid(...)` call, call `m.renderOverview()`.
   - Return `grid + overview` (the overview string already starts with a blank line for spacing).

**Important:** Do NOT cache overview data in model fields. Compute fresh from store on every View() call. This guarantees live updates without cache invalidation. The data set is tiny (personal todo list, <100 items).

**Width consideration:** The calendar grid is 34 chars wide. The longest possible overview line is `" September 2026  [999]"` = ~24 chars, well within limits.
  </action>
  <verify>Run `go build ./...` -- must compile. Run `go vet ./...` -- must pass. Run the app with `go run .` and verify: (1) Overview section appears below the calendar grid with an "Overview" heading, (2) months with todos show their counts, (3) the "Unknown" row shows floating todo count, (4) the currently viewed month is visually distinct (bold), (5) navigating to a different month updates the active highlight, (6) adding or deleting a todo updates counts immediately.</verify>
  <done>Calendar View() renders overview below the grid. Month counts and floating count are displayed. Currently viewed month is highlighted with OverviewActive style. Counts update live on every render cycle.</done>
</task>

</tasks>

<verification>
1. `go build ./...` compiles without errors
2. `go vet ./...` passes
3. Application runs and displays the overview section below the calendar grid
4. Months with todos show correct counts (e.g., "February [3]")
5. Undated todos show as "Unknown [N]"
6. Currently viewed month is bold/highlighted
7. Adding a todo updates the count immediately
8. Deleting a todo updates the count immediately
9. Navigating months changes which row is highlighted
10. Cross-year month entries show the year (e.g., "January 2025")
</verification>

<success_criteria>
- Calendar panel displays todo count per month below the calendar grid (OVRVW-01)
- Overview shows count of undated floating todos as "Unknown [N]" (OVRVW-02)
- Counts update live as todos are added, completed, or deleted (no cache, fresh from store)
- Currently viewed month is visually distinct from other months
- All existing functionality (grid, indicators, navigation, themes) unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/09-overview-panel/09-01-SUMMARY.md`
</output>

---
phase: 11-date-format-setting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/config/config.go
  - internal/settings/model.go
  - internal/todolist/model.go
  - internal/app/model.go
autonomous: true

must_haves:
  truths:
    - "User can cycle through 3 date format presets (ISO, European, US) in settings overlay"
    - "All date displays in todo list reflect the chosen format"
    - "Date input accepts dates in the chosen format and shows matching placeholder"
    - "Date format preference persists in config.toml across app restarts"
    - "Edit date mode pre-populates in the display format, not raw ISO"
  artifacts:
    - path: "internal/config/config.go"
      provides: "DateFormat field, DateLayout(), DatePlaceholder(), FormatDate(), ParseUserDate()"
      contains: "DateFormat"
    - path: "internal/settings/model.go"
      provides: "4th option row for date format cycling with live date previews"
      contains: "Date Format"
    - path: "internal/todolist/model.go"
      provides: "dateLayout field, SetDateFormat setter, format-aware rendering and input parsing"
      contains: "SetDateFormat"
    - path: "internal/app/model.go"
      provides: "SetDateFormat wiring at init and on settings save"
      contains: "SetDateFormat"
  key_links:
    - from: "internal/config/config.go"
      to: "internal/todolist/model.go"
      via: "DateLayout() returns Go layout string consumed by FormatDate/ParseUserDate"
      pattern: "DateLayout"
    - from: "internal/app/model.go"
      to: "internal/todolist/model.go"
      via: "SetDateFormat() called in New() and SaveMsg handler"
      pattern: "SetDateFormat"
    - from: "internal/settings/model.go"
      to: "internal/config/config.go"
      via: "Config() returns DateFormat field from options[3]"
      pattern: "DateFormat.*options\\[3\\]"
    - from: "internal/todolist/model.go"
      to: "internal/config/config.go"
      via: "FormatDate and ParseUserDate used in renderTodo and date input modes"
      pattern: "FormatDate|ParseUserDate"
---

<objective>
Add date format preference with 3 presets (ISO YYYY-MM-DD, European DD.MM.YYYY, US MM/DD/YYYY) that persists in config.toml, is configurable via the settings overlay, and applies to all date displays and date inputs throughout the app.

Purpose: Users in different regions see and type dates in their familiar format, improving usability.
Output: Working date format cycling in settings, format-aware date display and input, persistent preference.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-date-format-setting/11-RESEARCH.md
@internal/config/config.go
@internal/settings/model.go
@internal/todolist/model.go
@internal/app/model.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DateFormat config field and date conversion helpers</name>
  <files>internal/config/config.go</files>
  <action>
Add `DateFormat string` field with `toml:"date_format"` tag to the Config struct. Update DefaultConfig() to set DateFormat to `"iso"`.

Add three methods/functions to config.go:

1. `DateLayout() string` method on Config -- returns the Go time layout string for the configured format:
   - `"iso"` (default) -> `"2006-01-02"`
   - `"eu"` -> `"02.01.2006"`
   - `"us"` -> `"01/02/2006"`

2. `DatePlaceholder() string` method on Config -- returns the human-readable placeholder:
   - `"iso"` -> `"YYYY-MM-DD"`
   - `"eu"` -> `"DD.MM.YYYY"`
   - `"us"` -> `"MM/DD/YYYY"`

3. `FormatDate(isoDate, layout string) string` package-level function -- parses an ISO date string (`"2006-01-02"` layout) and formats it with the given layout. Returns the original string unchanged if parsing fails (graceful fallback).

4. `ParseUserDate(input, layout string) (string, error)` package-level function -- parses a date string in the user's display format and returns the ISO storage format (`"2006-01-02"`). Returns error if parsing fails.

Add `"time"` to the imports.

IMPORTANT: The store always uses `"2006-01-02"` internally. FormatDate and ParseUserDate are the ONLY bridge between storage format and display format. Never pass display layout strings to store operations.
  </action>
  <verify>Run `cd /home/antti/Repos/Misc/todo-calendar && go build ./...` -- must compile with no errors.</verify>
  <done>Config struct has DateFormat field with "iso" default. DateLayout(), DatePlaceholder(), FormatDate(), and ParseUserDate() exist and compile. Config.Save/Load round-trips the new field via TOML.</done>
</task>

<task type="auto">
  <name>Task 2: Wire date format through settings, todolist, and app</name>
  <files>internal/settings/model.go, internal/todolist/model.go, internal/app/model.go</files>
  <action>
**settings/model.go:**
1. Add `"time"` and `"fmt"` imports (fmt already present, add time).
2. In `New()`, after the dayValues/dayDisplay block, add a 4th option for date format:
   ```
   formatValues := []string{"iso", "eu", "us"}
   now := time.Now()
   formatDisplay := []string{
       fmt.Sprintf("ISO (%s)", now.Format("2006-01-02")),
       fmt.Sprintf("European (%s)", now.Format("02.01.2006")),
       fmt.Sprintf("US (%s)", now.Format("01/02/2006")),
   }
   ```
   Append to the options slice: `{label: "Date Format", values: formatValues, display: formatDisplay, index: indexOf(formatValues, cfg.DateFormat)}`
3. In `Config()`, add `DateFormat: m.options[3].values[m.options[3].index]` to the returned config.Config.
4. Update the cursor comment from "0, 1, or 2" to "0-3".

**todolist/model.go:**
1. Add `dateLayout string` field to the Model struct.
2. In `New()`, initialize `dateLayout: "2006-01-02"` (ISO default).
3. Add `SetDateFormat(layout string)` setter method on `*Model`:
   ```go
   func (m *Model) SetDateFormat(layout string) {
       m.dateLayout = layout
   }
   ```
4. In `renderTodo()`, change `m.styles.Date.Render(t.Date)` to `m.styles.Date.Render(config.FormatDate(t.Date, m.dateLayout))`. Add import for `"github.com/antti/todo-calendar/internal/config"`.
5. In `updateNormalMode()` for AddDated (key.Matches(msg, m.keys.AddDated) block), after entering dateInputMode: change `m.input.Placeholder = "YYYY-MM-DD"` to use `config.Config{DateFormat: "iso"}.DatePlaceholder()` -- wait, simpler: store a `datePlaceholder` field too. Actually, simplest approach: add a `datePlaceholder string` field to Model, default `"YYYY-MM-DD"`, updated in SetDateFormat alongside dateLayout. Then use `m.datePlaceholder` for placeholders.

   Revised approach for SetDateFormat:
   ```go
   func (m *Model) SetDateFormat(layout, placeholder string) {
       m.dateLayout = layout
       m.datePlaceholder = placeholder
   }
   ```
   This keeps todolist decoupled from the config package for the placeholder. The app layer calls `tl.SetDateFormat(cfg.DateLayout(), cfg.DatePlaceholder())`.

6. In `updateInputMode()` where it transitions to dateInputMode (the `m.addingDated` block): change `m.input.Placeholder = "YYYY-MM-DD"` to `m.input.Placeholder = m.datePlaceholder`.
7. In `updateDateInputMode()` Confirm handler: replace `time.Parse("2006-01-02", date)` validation with `config.ParseUserDate(date, m.dateLayout)` and use the returned ISO string for `m.store.Add(m.pendingText, isoDate)`.
8. In `updateNormalMode()` EditDate handler: change `m.input.Placeholder = "YYYY-MM-DD (empty = floating)"` to `m.input.Placeholder = m.datePlaceholder + " (empty = floating)"`. Change `m.input.SetValue(todo.Date)` to `m.input.SetValue(config.FormatDate(todo.Date, m.dateLayout))` so the pre-populated value matches the display format.
9. In `updateEditDateMode()` Confirm handler: replace `time.Parse("2006-01-02", date)` validation with `config.ParseUserDate(date, m.dateLayout)` and use the returned ISO string for `m.store.Update(m.editingID, todo.Text, isoDate)`.

**app/model.go:**
1. In `New()`, after creating `tl := todolist.New(s, t)`, add: `tl.SetDateFormat(cfg.DateLayout(), cfg.DatePlaceholder())`.
2. In the `settings.SaveMsg` handler, after `m.calendar.SetMondayStart(msg.Cfg.MondayStart())`, add: `m.todoList.SetDateFormat(m.cfg.DateLayout(), m.cfg.DatePlaceholder())`.

NOTE: Do NOT modify store package, calendar package, or any other files. The store always uses ISO format internally.
  </action>
  <verify>Run `cd /home/antti/Repos/Misc/todo-calendar && go build ./...` -- must compile with no errors. Then run `go vet ./...` for correctness.</verify>
  <done>Settings overlay shows 4 options with "Date Format" as the 4th row, cycling through ISO/European/US with today's date preview. Todo dates display in the configured format. Date input accepts the configured format with matching placeholder. Edit date pre-populates in display format. App propagates format on init and settings save. App compiles and runs cleanly.</done>
</task>

</tasks>

<verification>
1. `cd /home/antti/Repos/Misc/todo-calendar && go build ./...` -- compiles
2. `go vet ./...` -- no issues
3. Run the app, open settings (S key), verify "Date Format" row appears as 4th option
4. Cycle through ISO/European/US -- each shows a preview with today's date
5. Save with European format, verify todo dates display as DD.MM.YYYY
6. Add a dated todo, verify the placeholder shows DD.MM.YYYY and accepts European format input
7. Edit a todo's date (E then date), verify it pre-populates in European format
8. Restart the app, verify date format persists as European
9. Check config.toml contains `date_format = "eu"`
</verification>

<success_criteria>
- Settings overlay has 4 rows: Theme, Country, First Day of Week, Date Format
- All 3 presets cycle correctly with date previews
- Todo dates render in the active format (not raw ISO)
- Date input parses the active format (not hardcoded ISO)
- Edit date pre-populates in display format
- Preference persists in config.toml
- App compiles, vets, and runs without errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-date-format-setting/11-01-SUMMARY.md`
</output>

---
phase: 12-weekly-calendar-view
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/calendar/model.go
  - internal/calendar/grid.go
  - internal/calendar/keys.go
  - internal/app/model.go
autonomous: true

must_haves:
  truths:
    - "User can press 'w' to toggle between monthly and weekly calendar view"
    - "Weekly view shows 7 days with day numbers, holiday markers, and todo indicators"
    - "User can navigate week-by-week with left/right arrows or h/l in weekly mode"
    - "Switching from monthly to weekly view auto-selects the week containing today"
    - "Switching back to monthly view preserves the month the user was viewing"
    - "Help bar updates to show 'prev week / next week' in weekly mode"
  artifacts:
    - path: "internal/calendar/model.go"
      provides: "ViewMode type, weekStart field, toggle and navigation logic, weekStartFor helper"
      contains: "ViewMode"
    - path: "internal/calendar/grid.go"
      provides: "RenderWeekGrid pure function for 7-day single-row grid"
      contains: "RenderWeekGrid"
    - path: "internal/calendar/keys.go"
      provides: "ToggleWeek key binding, contextual help text"
      contains: "ToggleWeek"
    - path: "internal/app/model.go"
      provides: "ToggleWeek in help bar, todolist month sync after toggle"
      contains: "ToggleWeek"
  key_links:
    - from: "internal/calendar/model.go"
      to: "internal/calendar/grid.go"
      via: "View() calls RenderWeekGrid when viewMode == WeekView"
      pattern: "RenderWeekGrid"
    - from: "internal/calendar/model.go"
      to: "internal/calendar/keys.go"
      via: "Update() matches ToggleWeek key binding"
      pattern: "key\\.Matches.*ToggleWeek"
    - from: "internal/app/model.go"
      to: "internal/calendar/model.go"
      via: "Help bar reads calendar Keys() which returns contextual help"
      pattern: "calendar\\.Keys\\(\\)"
    - from: "internal/calendar/model.go"
      to: "internal/calendar/model.go"
      via: "Week navigation updates m.year and m.month to keep todolist sync working"
      pattern: "m\\.year.*weekStart"
---

<objective>
Add a weekly calendar view mode that users can toggle into from the existing monthly view. The weekly view shows a single week (7 days) with day numbers, holiday markers, and todo indicators, using the same 34-char grid width as the monthly view for visual consistency.

Purpose: Users can zoom into a single week for focused daily planning instead of seeing the entire month.
Output: Working weekly view toggle with `w` key, weekly grid rendering, week-by-week navigation, and contextual help text.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-weekly-calendar-view/12-RESEARCH.md
@internal/calendar/model.go
@internal/calendar/grid.go
@internal/calendar/keys.go
@internal/app/model.go
@internal/app/keys.go
@internal/calendar/styles.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ViewMode, weekStart, RenderWeekGrid, and ToggleWeek keybinding to calendar package</name>
  <files>
    internal/calendar/model.go
    internal/calendar/grid.go
    internal/calendar/keys.go
  </files>
  <action>
**keys.go** -- Add ToggleWeek binding and make help contextual:

1. Add `ToggleWeek key.Binding` field to `KeyMap` struct.
2. In `DefaultKeyMap()`, add: `ToggleWeek: key.NewBinding(key.WithKeys("w"), key.WithHelp("w", "weekly view"))`.
3. Add `ToggleWeek` to `ShortHelp()` return slice.
4. Add `ToggleWeek` to `FullHelp()` return slice.

**grid.go** -- Add `RenderWeekGrid` pure function:

1. Add `RenderWeekGrid(weekStart time.Time, today time.Time, holidays *holidays.Provider, mondayStart bool, st *store.Store, s Styles) string`.
2. Import `holidays` and `store` packages (grid.go currently only imports fmt, strings, time).
3. The function renders:
   - **Header line**: date range centered in `gridWidth` (34 chars). Use format: same-month "Feb 2 - 8, 2026", cross-month "Jan 26 - Feb 1, 2026", cross-year "Dec 29, 2025 - Jan 4, 2026". Style with `s.Header`.
   - **Weekday header**: same as RenderGrid (the `" Mo   Tu   We   Th   Fr   Sa   Su "` or Sunday-start variant), styled with `s.WeekdayHdr`.
   - **Day cells (7 cells)**: iterate `i := 0; i < 7; i++`, compute `d := weekStart.AddDate(0, 0, i)`. For each day:
     - Fetch holidays: call `holidays.HolidaysInMonth(d.Year(), d.Month())` to get the month's holiday map, then check `holidayMap[d.Day()]`. To avoid calling HolidaysInMonth 7 times, cache by (year, month) -- at most 2 months in a straddling week.
     - Fetch indicators: call `st.IncompleteTodosPerDay(d.Year(), d.Month())` similarly, cache by (year, month).
     - Format cell as 4 chars: `[%2d]` if indicator > 0, else ` %2d `.
     - Style priority: today > holiday > indicator > normal (same as RenderGrid). Today check: `d.Year() == today.Year() && d.Month() == today.Month() && d.Day() == today.Day()`.
     - Append cell to builder. Add `" "` separator between cells (not after last cell). End with `"\n"`.
4. Use the same `gridWidth` constant (34 chars) for centering the header.

**model.go** -- Add ViewMode, weekStart, toggle logic, and contextual navigation:

1. Add `ViewMode` type and constants above Model struct:
   ```go
   type ViewMode int
   const (
       MonthView ViewMode = iota
       WeekView
   )
   ```
2. Add fields to `Model` struct: `viewMode ViewMode` and `weekStart time.Time`.
3. Add unexported helper `weekStartFor(t time.Time, mondayStart bool) time.Time`:
   - `wd := int(t.Weekday())` (Sunday=0..Saturday=6)
   - If mondayStart: `offset := (wd + 6) % 7; return time.Date(t.Year(), t.Month(), t.Day()-offset, 0, 0, 0, 0, time.Local)`
   - Else: `return time.Date(t.Year(), t.Month(), t.Day()-wd, 0, 0, 0, 0, time.Local)`
4. In `Update()`, add a new case for `ToggleWeek` BEFORE the PrevMonth/NextMonth cases:
   - If `viewMode == MonthView`: set `viewMode = WeekView`, compute `weekStart = weekStartFor(time.Now(), m.mondayStart)`, update `m.year = m.weekStart.Year()`, `m.month = m.weekStart.Month()`, refresh holidays and indicators.
   - If `viewMode == WeekView`: set `viewMode = MonthView`, refresh holidays and indicators (m.year/m.month already track the week's month).
5. Modify `PrevMonth` case: if `viewMode == WeekView`, do `m.weekStart = m.weekStart.AddDate(0, 0, -7)`, then `m.year = m.weekStart.Year()`, `m.month = m.weekStart.Month()`, refresh holidays and indicators. Else: existing month navigation logic.
6. Modify `NextMonth` case: same pattern but `AddDate(0, 0, 7)`.
7. In `View()`: if `m.viewMode == WeekView`, call `RenderWeekGrid(m.weekStart, time.Now(), m.provider, m.mondayStart, m.store, m.styles)` instead of `RenderGrid(...)`. Append `m.renderOverview()` in both cases.
8. Update `Keys()` method to return contextual help: if `viewMode == WeekView`, return a copy of `m.keys` where PrevMonth and NextMonth have updated help text ("prev week" / "next week"). Specifically:
   ```go
   func (m Model) Keys() KeyMap {
       k := m.keys
       if m.viewMode == WeekView {
           k.PrevMonth = key.NewBinding(key.WithKeys("left", "h"), key.WithHelp("<-/h", "prev week"))
           k.NextMonth = key.NewBinding(key.WithKeys("right", "l"), key.WithHelp("->/l", "next week"))
           k.ToggleWeek = key.NewBinding(key.WithKeys("w"), key.WithHelp("w", "monthly view"))
       }
       return k
   }
   ```
9. Add `ViewMode() ViewMode` method returning `m.viewMode` (exported, for app model to query if needed).
  </action>
  <verify>
Run `go build ./...` from project root -- must compile with no errors. Verify that `weekStartFor`, `RenderWeekGrid`, `ViewMode`, `WeekView`, `MonthView`, and `ToggleWeek` are all defined.
  </verify>
  <done>
Calendar package has: ViewMode enum (MonthView/WeekView), weekStart field in Model, weekStartFor() helper, ToggleWeek key binding in KeyMap with contextual help text, RenderWeekGrid pure function that renders 7 days with header/holidays/indicators, and Update() handles toggle and week navigation. Code compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire weekly view toggle into app help bar and verify todolist sync</name>
  <files>
    internal/app/model.go
  </files>
  <action>
**app/model.go** -- Expose ToggleWeek in help bar when calendar is focused:

1. In `currentHelpKeys()`, in the `calendarPane` case: the existing code does `calKeys := m.calendar.Keys()` then appends `calKeys.PrevMonth, calKeys.NextMonth`. Add `calKeys.ToggleWeek` to this list:
   ```go
   case calendarPane:
       calKeys := m.calendar.Keys()
       bindings = append(bindings, calKeys.PrevMonth, calKeys.NextMonth, calKeys.ToggleWeek)
   ```
   Since `calendar.Keys()` already returns contextual help text (prev week/next week and monthly/weekly toggle label), no further logic is needed in the app model.

2. **Verify todolist sync already works**: The existing code at line 172 does `m.todoList.SetViewMonth(m.calendar.Year(), m.calendar.Month())` after every calendar update. Since the calendar model's `Year()` and `Month()` methods return `m.year` and `m.month` (which Task 1 updates to match `weekStart` during toggle and week navigation), the todolist automatically syncs to the correct month. No additional changes needed.

3. **Verify RefreshIndicators works**: The existing code at line 179 calls `m.calendar.RefreshIndicators()` after every update cycle. Since `RefreshIndicators` uses `m.year` and `m.month` (updated in Task 1), this continues to work correctly. No changes needed.

4. Run the app manually: `go run .` and verify:
   - Press `w` when calendar is focused -- should switch to weekly view showing the current week.
   - Help bar should show "prev week", "next week", "monthly view" (not "prev month", "next month", "weekly view").
   - Press left/right or h/l -- should navigate by week, and the todolist should update to show the correct month's todos.
   - Press `w` again -- should switch back to monthly view showing the month of the last viewed week.
   - Overview section should still appear below the weekly grid.
  </action>
  <verify>
Run `go build ./...` -- must compile. Run `go vet ./...` -- no warnings. Manually run `go run .` and test the weekly view toggle, navigation, help bar, and todolist sync.
  </verify>
  <done>
Help bar shows ToggleWeek binding when calendar focused. Help text is contextual (shows "prev week/next week/monthly view" in weekly mode, "prev month/next month/weekly view" in monthly mode). Todolist syncs to the correct month when navigating weeks. Overview panel renders below both views. The complete weekly calendar view feature works end-to-end.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` compiles without errors
2. `go vet ./...` reports no issues
3. Manual testing:
   - Launch app with `go run .`
   - Focus calendar pane (default or press Tab)
   - Press `w` -- monthly view switches to weekly view showing current week
   - Verify weekly view shows: date range header (e.g., "Feb 2 - 8, 2026"), weekday labels, 7 day cells with correct day numbers
   - Verify holidays show in red on the weekly grid (navigate to a week with a known holiday)
   - Verify todo indicators show bracket notation `[N]` for days with incomplete todos
   - Press left/h -- navigates to previous week; todolist updates if month boundary crossed
   - Press right/l -- navigates to next week
   - Verify help bar shows "prev week / next week / monthly view" in weekly mode
   - Press `w` -- returns to monthly view showing the month from the weekly view
   - Verify help bar reverts to "prev month / next month / weekly view"
   - Press `s` to open settings, change first day of week, save, toggle to weekly -- verify week starts on the correct day
</verification>

<success_criteria>
- WKVIEW-01: `w` toggles between monthly and weekly view
- WKVIEW-02: Weekly view shows 7 days with day numbers, holiday markers, and todo indicators in a single row
- WKVIEW-03: Left/right (h/l) navigate by week in weekly mode
- WKVIEW-04: Toggling to weekly view computes weekStart from time.Now(), showing the current week
- Help bar is contextual: shows week-appropriate labels in weekly mode
- Overview panel renders below both monthly and weekly views
- Todolist syncs to the correct month when navigating weeks
</success_criteria>

<output>
After completion, create `.planning/phases/12-weekly-calendar-view/12-01-SUMMARY.md`
</output>

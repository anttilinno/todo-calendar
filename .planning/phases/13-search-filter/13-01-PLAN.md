---
phase: 13-search-filter
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/todolist/model.go
  - internal/todolist/keys.go
autonomous: true

must_haves:
  truths:
    - "User can type / to activate inline filter when todolist is focused in normal mode"
    - "Visible todos narrow to only those matching the typed query (case-insensitive substring)"
    - "User can press Esc to clear the filter and return to normal mode with all todos visible"
    - "Filter applies to both dated and floating todo sections"
    - "Filter is cleared automatically when month changes via SetViewMonth"
  artifacts:
    - path: "internal/todolist/model.go"
      provides: "filterMode in mode enum, filterQuery field, updateFilterMode handler, filtered visibleItems"
      contains: "filterMode"
    - path: "internal/todolist/keys.go"
      provides: "Filter key binding mapped to /"
      contains: "Filter"
  key_links:
    - from: "internal/todolist/model.go"
      to: "visibleItems()"
      via: "filterQuery applied in visibleItems to filter todoItems"
      pattern: "strings\\.Contains.*strings\\.ToLower"
    - from: "internal/todolist/model.go"
      to: "updateNormalMode"
      via: "/ key triggers filterMode entry"
      pattern: "key\\.Matches.*keys\\.Filter"
    - from: "internal/todolist/model.go"
      to: "SetViewMonth"
      via: "filterQuery cleared on month change"
      pattern: "filterQuery.*="
---

<objective>
Add inline todo filtering to the todolist pane. When the user presses `/` in normal mode, a text input appears and the visible todo list narrows in real-time to show only todos whose text matches the typed query (case-insensitive substring). Pressing Esc clears the filter and returns to normal mode.

Purpose: Satisfies SRCH-01 (activate inline filter with `/`) and SRCH-02 (clear with Esc). Users can quickly find todos in the current month without scrolling.
Output: Modified todolist with filter mode, key binding, and filtered rendering.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-search-filter/13-RESEARCH.md

@internal/todolist/model.go
@internal/todolist/keys.go
@internal/todolist/styles.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Filter key binding to todolist KeyMap</name>
  <files>internal/todolist/keys.go</files>
  <action>
Add a `Filter` field to the `KeyMap` struct with key `/` and help text `"/" "filter"`.

In `DefaultKeyMap()`, add:
```go
Filter: key.NewBinding(
    key.WithKeys("/"),
    key.WithHelp("/", "filter"),
),
```

Add `k.Filter` to the `ShortHelp()` and `FullHelp()` return slices.
  </action>
  <verify>Run `go build ./...` -- compiles without errors.</verify>
  <done>KeyMap has a Filter binding mapped to `/` with help text.</done>
</task>

<task type="auto">
  <name>Task 2: Implement filterMode in todolist model</name>
  <files>internal/todolist/model.go</files>
  <action>
This is the core implementation. Make these changes to `internal/todolist/model.go`:

1. **Add filterMode to mode enum:** Add `filterMode` after `editDateMode` in the const block.

2. **Add filterQuery field to Model:** Add `filterQuery string` field to the Model struct.

3. **Update IsInputting():** It currently returns `m.mode != normalMode`. This is already correct -- filterMode will be treated as "inputting" which suppresses quit/tab/settings keys. This is the desired behavior since the user is typing in the filter input.

4. **Update HelpBindings():** In the `m.mode != normalMode` branch, return the existing `Confirm` and `Cancel` bindings. For filterMode specifically, the user only needs Esc (Cancel). The current behavior is acceptable since both modes show Confirm/Cancel.

   Additionally, add `m.keys.Filter` to the normalMode help bindings slice (the else branch), so the help bar shows `/` as available.

5. **Apply filter in visibleItems():** After building the `items` slice (which contains headers, todos, and empty placeholders), if `m.filterQuery != ""`, filter the items:
   - Keep all `headerItem` entries (section headers always visible).
   - For `todoItem` entries, keep only those where `strings.Contains(strings.ToLower(item.todo.Text), strings.ToLower(m.filterQuery))` is true.
   - Remove `emptyItem` entries (they will be misleading when filtered).
   - After filtering, if a header has no todo items following it (before the next header or end), add an `emptyItem` with label `"(no matches)"` after it.

   Implementation approach: Build the filtered slice, then post-process to insert empty placeholders for headerless sections.

6. **Handle filter activation in updateNormalMode():** Add a case:
   ```go
   case key.Matches(msg, m.keys.Filter):
       m.mode = filterMode
       m.filterQuery = ""
       m.input.Placeholder = "Filter todos..."
       m.input.Prompt = "/ "
       m.input.SetValue("")
       return m, m.input.Focus()
   ```

7. **Add updateFilterMode() method:** Create a new method that handles key events in filter mode:
   ```go
   func (m Model) updateFilterMode(msg tea.KeyMsg) (Model, tea.Cmd) {
       switch {
       case key.Matches(msg, m.keys.Cancel):
           // Esc clears filter and returns to normal mode
           m.mode = normalMode
           m.filterQuery = ""
           m.input.Blur()
           m.input.SetValue("")
           // Clamp cursor after filter removal restores all items
           selectable := selectableIndices(m.visibleItems())
           if m.cursor >= len(selectable) {
               m.cursor = max(0, len(selectable)-1)
           }
           return m, nil
       }
       // Forward all other keys to the text input
       var cmd tea.Cmd
       m.input, cmd = m.input.Update(msg)
       m.filterQuery = m.input.Value()
       // Clamp cursor after filter narrows visible items
       selectable := selectableIndices(m.visibleItems())
       if m.cursor >= len(selectable) {
           m.cursor = max(0, len(selectable)-1)
       }
       return m, cmd
   }
   ```

8. **Route filterMode in Update():** In the `tea.KeyMsg` switch on `m.mode`, add:
   ```go
   case filterMode:
       return m.updateFilterMode(msg)
   ```
   Place this before the `default` case.

9. **Clear filter on month change:** In `SetViewMonth()`, add:
   ```go
   m.filterQuery = ""
   if m.mode == filterMode {
       m.mode = normalMode
       m.input.Blur()
       m.input.SetValue("")
   }
   ```

10. **Show filter input in View():** The existing `if m.mode != normalMode` block at the bottom of View() already shows the input field. Since filterMode is not normalMode, the filter input will automatically be shown. No change needed here.

Make sure to add `"strings"` to the imports if not already present (it is already imported).
  </action>
  <verify>
Run `go build ./...` -- compiles without errors.
Run `go vet ./...` -- no issues.
Manually verify by reading the modified file that:
- filterMode exists in mode enum
- filterQuery field exists on Model
- visibleItems applies filter when filterQuery is set
- updateFilterMode handles Esc and forwards other keys
- SetViewMonth clears filter state
  </verify>
  <done>
- `/` activates filter mode with text input showing "/ " prompt
- Typing narrows visible todos by case-insensitive substring match
- Both dated and floating sections are filtered
- Esc clears filter and returns to normal mode
- Cursor is clamped after every filter change
- Filter is cleared when month changes via SetViewMonth
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` succeeds
2. `go vet ./...` passes
3. The filterMode constant exists in the mode enum
4. The Filter key binding exists in KeyMap mapped to "/"
5. visibleItems() contains filter logic with strings.Contains/strings.ToLower
6. SetViewMonth() clears filterQuery
</verification>

<success_criteria>
- SRCH-01: `/` activates inline filter that narrows visible todos by text substring
- SRCH-02: Esc clears filter and restores normal mode with all todos visible
- Filter applies to both dated and floating sections
- Cursor never goes out of bounds after filter changes
- Filter state is cleared on month navigation
</success_criteria>

<output>
After completion, create `.planning/phases/13-search-filter/13-01-SUMMARY.md`
</output>

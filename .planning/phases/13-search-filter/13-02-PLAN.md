---
phase: 13-search-filter
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/search/model.go
  - internal/search/keys.go
  - internal/search/styles.go
  - internal/store/store.go
  - internal/calendar/model.go
  - internal/app/model.go
  - internal/app/keys.go
autonomous: true

must_haves:
  truths:
    - "User can press Ctrl+F to open a full-screen search overlay"
    - "Typing a query shows matching todos from ALL months (dated and floating)"
    - "Search results display the todo text and its formatted date (or 'No date' for floating)"
    - "User can navigate results with j/k and press Enter to jump to that todo's month"
    - "Pressing Esc closes the search overlay and returns to the normal split-pane view"
  artifacts:
    - path: "internal/search/model.go"
      provides: "Search overlay model with textinput, results list, cursor, JumpMsg, CloseMsg"
      contains: "JumpMsg"
    - path: "internal/search/keys.go"
      provides: "KeyMap for search navigation"
      contains: "KeyMap"
    - path: "internal/search/styles.go"
      provides: "Theme-aware styles for search rendering"
      contains: "NewStyles"
    - path: "internal/store/store.go"
      provides: "SearchTodos(query) method returning matched todos sorted by date"
      contains: "SearchTodos"
    - path: "internal/calendar/model.go"
      provides: "SetYearMonth method for direct navigation"
      contains: "SetYearMonth"
    - path: "internal/app/model.go"
      provides: "showSearch bool, search field, overlay routing, JumpMsg/CloseMsg handling"
      contains: "showSearch"
    - path: "internal/app/keys.go"
      provides: "Search key binding (Ctrl+F)"
      contains: "Search"
  key_links:
    - from: "internal/app/model.go"
      to: "internal/search/model.go"
      via: "showSearch flag routes messages to search.Model.Update()"
      pattern: "m\\.search.*Update"
    - from: "internal/search/model.go"
      to: "internal/store/store.go"
      via: "search model calls store.SearchTodos(query) on input change"
      pattern: "SearchTodos"
    - from: "internal/app/model.go"
      to: "internal/calendar/model.go"
      via: "JumpMsg triggers calendar.SetYearMonth(year, month)"
      pattern: "SetYearMonth"
    - from: "internal/search/model.go"
      to: "JumpMsg"
      via: "Enter on a dated result emits JumpMsg with year/month"
      pattern: "JumpMsg"
---

<objective>
Add a full-screen search overlay that searches todos across ALL months. When the user presses Ctrl+F, an overlay appears with a text input. Typing filters all todos (dated and floating) by case-insensitive substring. Results show todo text with formatted dates. The user can navigate with j/k and press Enter to jump to a result's month.

Purpose: Satisfies SRCH-03 (full-screen search overlay), SRCH-04 (results show todos with dates), and SRCH-05 (navigate results and jump to month). This is the cross-month discovery feature.
Output: New `internal/search` package, store SearchTodos method, calendar SetYearMonth method, app-level wiring.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-search-filter/13-RESEARCH.md

@internal/settings/model.go
@internal/settings/keys.go
@internal/settings/styles.go
@internal/store/store.go
@internal/store/todo.go
@internal/calendar/model.go
@internal/app/model.go
@internal/app/keys.go
@internal/config/config.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SearchTodos to store and SetYearMonth to calendar</name>
  <files>
    internal/store/store.go
    internal/calendar/model.go
  </files>
  <action>
**store/store.go -- Add SearchTodos method:**

Add a `SearchTodos(query string) []Todo` method to the Store. This searches ALL todos (dated and floating) by case-insensitive substring match and returns sorted results (dated first sorted by date ascending, then floating sorted by ID).

```go
// SearchTodos returns all todos whose text contains the query (case-insensitive).
// Results are sorted: dated todos first by date ascending, then floating by ID.
func (s *Store) SearchTodos(query string) []Todo {
    if query == "" {
        return nil
    }
    q := strings.ToLower(query)
    var results []Todo
    for _, t := range s.data.Todos {
        if strings.Contains(strings.ToLower(t.Text), q) {
            results = append(results, t)
        }
    }
    sort.Slice(results, func(i, j int) bool {
        // Dated before floating
        if results[i].HasDate() != results[j].HasDate() {
            return results[i].HasDate()
        }
        // By date ascending for dated, by ID for floating
        if results[i].Date != results[j].Date {
            return results[i].Date < results[j].Date
        }
        return results[i].ID < results[j].ID
    })
    return results
}
```

Add `"strings"` to the import block in store.go (it is not currently imported there).

**calendar/model.go -- Add SetYearMonth method:**

Add a `SetYearMonth(year int, month time.Month)` method that navigates the calendar directly to a specific year/month. This is needed for jumping from search results.

```go
// SetYearMonth navigates directly to the specified year and month,
// refreshing holidays and indicators.
func (m *Model) SetYearMonth(year int, month time.Month) {
    m.year = year
    m.month = month
    m.holidays = m.provider.HolidaysInMonth(year, month)
    m.indicators = m.store.IncompleteTodosPerDay(year, month)
}
```
  </action>
  <verify>Run `go build ./...` -- compiles without errors.</verify>
  <done>
- `store.SearchTodos("query")` returns matching todos sorted by date
- `calendar.SetYearMonth(2026, time.March)` navigates directly to March 2026
  </done>
</task>

<task type="auto">
  <name>Task 2: Create search overlay package and wire into app</name>
  <files>
    internal/search/model.go
    internal/search/keys.go
    internal/search/styles.go
    internal/app/model.go
    internal/app/keys.go
  </files>
  <action>
**Create `internal/search/keys.go`:**

Follow the exact pattern from `internal/settings/keys.go`. Define a KeyMap struct with: Up, Down, Select (Enter), Cancel (Esc).

```go
package search

import "github.com/charmbracelet/bubbles/key"

type KeyMap struct {
    Up     key.Binding
    Down   key.Binding
    Select key.Binding
    Cancel key.Binding
}

func (k KeyMap) ShortHelp() []key.Binding {
    return []key.Binding{k.Up, k.Down, k.Select, k.Cancel}
}

func (k KeyMap) FullHelp() [][]key.Binding {
    return [][]key.Binding{k.ShortHelp()}
}

func DefaultKeyMap() KeyMap {
    return KeyMap{
        Up: key.NewBinding(
            key.WithKeys("k", "up"),
            key.WithHelp("k/up", "up"),
        ),
        Down: key.NewBinding(
            key.WithKeys("j", "down"),
            key.WithHelp("j/dn", "down"),
        ),
        Select: key.NewBinding(
            key.WithKeys("enter"),
            key.WithHelp("enter", "jump"),
        ),
        Cancel: key.NewBinding(
            key.WithKeys("esc"),
            key.WithHelp("esc", "close"),
        ),
    }
}
```

**Create `internal/search/styles.go`:**

Follow the pattern from `internal/settings/styles.go`. Define styles for: Title, Input, ResultText, ResultDate, SelectedResult, Hint, Empty.

```go
package search

import (
    "github.com/antti/todo-calendar/internal/theme"
    "github.com/charmbracelet/lipgloss"
)

type Styles struct {
    Title          lipgloss.Style
    ResultText     lipgloss.Style
    ResultDate     lipgloss.Style
    SelectedResult lipgloss.Style
    SelectedDate   lipgloss.Style
    Hint           lipgloss.Style
    Empty          lipgloss.Style
}

func NewStyles(t theme.Theme) Styles {
    return Styles{
        Title:          lipgloss.NewStyle().Bold(true).Foreground(t.AccentFg),
        ResultText:     lipgloss.NewStyle().Foreground(t.NormalFg),
        ResultDate:     lipgloss.NewStyle().Foreground(t.MutedFg),
        SelectedResult: lipgloss.NewStyle().Bold(true).Foreground(t.AccentFg),
        SelectedDate:   lipgloss.NewStyle().Foreground(t.AccentFg),
        Hint:           lipgloss.NewStyle().Foreground(t.MutedFg),
        Empty:          lipgloss.NewStyle().Foreground(t.MutedFg),
    }
}
```

**Create `internal/search/model.go`:**

This is the main search overlay model. Follow the settings overlay pattern closely.

Structure:
- `JumpMsg{Year int, Month time.Month}` -- emitted when user selects a dated result
- `CloseMsg{}` -- emitted when user presses Esc
- `Model` struct with: `input textinput.Model`, `results []store.Todo`, `cursor int`, `store *store.Store`, `dateLayout string`, `width int`, `height int`, `keys KeyMap`, `styles Styles`
- `New(s *store.Store, t theme.Theme, cfg config.Config) Model` -- creates the model, initializes textinput with "Search all todos..." placeholder and prompt "? "
- `Init() tea.Cmd` -- returns `textinput.Blink` (to start cursor blinking)
- `SetSize(w, h int)` -- stores dimensions
- `SetTheme(t theme.Theme)` -- updates styles
- `Update(msg tea.Msg) (Model, tea.Cmd)` -- handles key events:
  - Esc: emit `CloseMsg{}`
  - Enter: if results exist and cursor is valid, check if result has a date. If dated, parse to get year/month, emit `JumpMsg{Year, Month}`. If floating, emit `CloseMsg{}` (no month to jump to).
  - j/k/up/down: navigate cursor (clamp to 0..len(results)-1)
  - Default: forward to textinput, then update results from `s.SearchTodos(m.input.Value())` and clamp cursor.
- `View() string` -- renders:
  - Title "Search" (styled)
  - The textinput
  - A blank line
  - Results list with cursor indicator ("> " for selected, "  " for others). Each result shows: checkbox `[x]`/`[ ]`, todo text, and date (formatted via `config.FormatDate(todo.Date, m.dateLayout)`, or "No date" for floating). Cap visible results to `m.height - 8` to avoid overflow.
  - If no results and query is non-empty: show "(no matches)" in empty style.
  - If query is empty: show hint text "Type to search across all months" in empty style.
  - Bottom hint line: "j/k navigate | enter jump to month | esc close"
  - Center vertically using the same approach as settings overlay (pad with newlines if m.height > 0).
- `HelpBindings() []key.Binding` -- returns search-specific bindings for help bar.

Key implementation detail: Update results on EVERY keystroke by calling `m.store.SearchTodos(m.input.Value())` after forwarding the key to the textinput. This keeps results live as user types.

**Modify `internal/app/keys.go`:**

Add a `Search` field to the app KeyMap struct:
```go
Search key.Binding
```

In `DefaultKeyMap()`, add:
```go
Search: key.NewBinding(
    key.WithKeys("ctrl+f"),
    key.WithHelp("C-f", "search"),
),
```

Add `k.Search` to `ShortHelp()` and `FullHelp()`.

**Modify `internal/app/model.go`:**

1. Add import for `"github.com/antti/todo-calendar/internal/search"`.

2. Add fields to Model struct:
   ```go
   showSearch bool
   search     search.Model
   store      *store.Store  // direct reference for search overlay
   ```

3. In `New()`, save the store reference:
   ```go
   store: s,
   ```

4. Handle search messages at the top of `Update()` alongside settings messages (before the `if m.showSettings` check). Add handling for:
   ```go
   case search.JumpMsg:
       m.showSearch = false
       m.calendar.SetYearMonth(msg.Year, msg.Month)
       m.todoList.SetViewMonth(msg.Year, msg.Month)
       m.calendar.RefreshIndicators()
       return m, nil

   case search.CloseMsg:
       m.showSearch = false
       return m, nil
   ```

5. After the `if m.showSettings` block, add a similar block for search:
   ```go
   if m.showSearch {
       return m.updateSearch(msg)
   }
   ```

6. Add the Ctrl+F key handler in the `tea.KeyMsg` switch (alongside the Settings case, with the same `!isInputting` guard):
   ```go
   case key.Matches(msg, m.keys.Search) && !isInputting:
       m.search = search.New(m.store, theme.ForName(m.cfg.Theme), m.cfg)
       m.search.SetSize(m.width, m.height)
       m.showSearch = true
       return m, m.search.Init()
   ```

7. Add `updateSearch()` method (follows the exact pattern of `updateSettings()`):
   ```go
   func (m Model) updateSearch(msg tea.Msg) (tea.Model, tea.Cmd) {
       if wsm, ok := msg.(tea.WindowSizeMsg); ok {
           m.width = wsm.Width
           m.height = wsm.Height
           m.ready = true
           m.help.Width = wsm.Width
           m.search.SetSize(wsm.Width, wsm.Height)
           var calCmd, todoCmd tea.Cmd
           m.calendar, calCmd = m.calendar.Update(msg)
           m.todoList, todoCmd = m.todoList.Update(msg)
           return m, tea.Batch(calCmd, todoCmd)
       }
       var cmd tea.Cmd
       m.search, cmd = m.search.Update(msg)
       return m, cmd
   }
   ```

8. In `View()`, add search overlay rendering after the settings check:
   ```go
   if m.showSearch {
       m.help.Width = m.width
       helpBar := m.help.View(m.currentHelpKeys())
       return lipgloss.JoinVertical(lipgloss.Left, m.search.View(), helpBar)
   }
   ```

9. In `currentHelpKeys()`, add a search check before the settings check:
   ```go
   if m.showSearch {
       return helpKeyMap{bindings: m.search.HelpBindings()}
   }
   ```

10. In `applyTheme()`, add `m.search.SetTheme(t)`.

11. Add `m.keys.Search` to the help bar bindings in `currentHelpKeys()` (the line that appends Tab, Settings, Quit):
    ```go
    bindings = append(bindings, m.keys.Tab, m.keys.Settings, m.keys.Search, m.keys.Quit)
    ```
  </action>
  <verify>
Run `go build ./...` -- compiles without errors.
Run `go vet ./...` -- no issues.
Manually verify by reading files that:
- `internal/search/` package exists with model.go, keys.go, styles.go
- search.JumpMsg and search.CloseMsg types are defined
- app.Model has showSearch field and search field
- app.Update routes to search when showSearch is true
- Ctrl+F opens search, Esc closes, Enter on result emits JumpMsg
  </verify>
  <done>
- Ctrl+F opens full-screen search overlay
- Typing shows matching todos from all months with formatted dates
- j/k navigates results, Enter jumps to selected result's month
- Floating todos show "No date" instead of a date
- Esc closes the overlay
- Calendar navigates to the correct month on jump
- Todolist syncs to the jumped month
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` succeeds
2. `go vet ./...` passes
3. `internal/search/` package exists with 3 files
4. `store.SearchTodos()` method exists
5. `calendar.SetYearMonth()` method exists
6. App routes Ctrl+F to open search overlay
7. App handles JumpMsg by navigating calendar and todolist
8. App handles CloseMsg by closing search overlay
</verification>

<success_criteria>
- SRCH-03: Ctrl+F opens full-screen search overlay showing todos from all months
- SRCH-04: Search results display todo text with formatted date (or "No date")
- SRCH-05: Enter on a dated result navigates to that month; cursor on floating result closes overlay
- Search overlay follows the same pattern as settings overlay (centered, full-screen, help bar)
- Calendar and todolist sync to the jumped month
</success_criteria>

<output>
After completion, create `.planning/phases/13-search-filter/13-02-SUMMARY.md`
</output>

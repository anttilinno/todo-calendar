---
phase: 15-markdown-templates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/store/todo.go
  - internal/store/store.go
  - internal/store/sqlite.go
  - internal/tmpl/tmpl.go
autonomous: true

must_haves:
  truths:
    - "Todo struct has a Body string field included in all SQL queries"
    - "TodoStore interface includes UpdateBody, AddTemplate, ListTemplates, FindTemplate, DeleteTemplate methods"
    - "SQLite migration v2 creates a templates table"
    - "Both Store (JSON) and SQLiteStore satisfy the extended TodoStore interface"
    - "ExtractPlaceholders parses template content and returns unique placeholder names"
    - "ExecuteTemplate fills placeholders with provided values"
  artifacts:
    - path: "internal/store/todo.go"
      provides: "Todo.Body field, Todo.HasBody() method, Template type"
      contains: "Body string"
    - path: "internal/store/store.go"
      provides: "Extended TodoStore interface, updated JSON Store methods"
      contains: "UpdateBody"
    - path: "internal/store/sqlite.go"
      provides: "Migration v2 templates table, body in todoColumns/scanTodo, template CRUD"
      contains: "templates"
    - path: "internal/tmpl/tmpl.go"
      provides: "ExtractPlaceholders and ExecuteTemplate utility functions"
      contains: "ExtractPlaceholders"
  key_links:
    - from: "internal/store/sqlite.go"
      to: "internal/store/store.go"
      via: "interface satisfaction"
      pattern: "var _ TodoStore = \\(\\*SQLiteStore\\)"
    - from: "internal/store/store.go"
      to: "internal/store/store.go"
      via: "interface satisfaction"
      pattern: "var _ TodoStore = \\(\\*Store\\)"
---

<objective>
Add the store-layer foundation for markdown bodies and templates: Body field in Todo struct, templates table in SQLite, template CRUD methods, TodoStore interface extensions, and template placeholder utilities.

Purpose: This is the data layer prerequisite for all Phase 15 UI work (preview overlay, body indicator, template creation flow).
Output: Extended store types and methods, template utilities, all compiling and satisfying the TodoStore interface.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-markdown-templates/15-RESEARCH.md
@internal/store/todo.go
@internal/store/store.go
@internal/store/sqlite.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Body field to Todo struct and update SQL queries</name>
  <files>internal/store/todo.go, internal/store/sqlite.go, internal/store/store.go</files>
  <action>
1. In `internal/store/todo.go`:
   - Add `Body string json:"body,omitempty"` field to the Todo struct (after Text, before Date).
   - Add `HasBody() bool` method that returns `t.Body != ""`.
   - Add a `Template` struct: `type Template struct { ID int; Name string; Content string; CreatedAt string }`.

2. In `internal/store/sqlite.go`:
   - Update `todoColumns` const to include body: `"id, text, body, date, done, created_at, sort_order"`.
   - Update `scanTodo` to scan `&t.Body` between `&t.Text` and `&date`.
   - Update `Add()` method: change the INSERT to include body column with empty string default `''`. The method signature stays `Add(text string, date string) Todo` (body is always empty on initial add; templates set body via UpdateBody after creation). No signature change needed.
   - Add `UpdateBody(id int, body string)` method: `UPDATE todos SET body = ? WHERE id = ?`.

3. In `internal/store/store.go`:
   - Add `UpdateBody(id int, body string)` to the TodoStore interface.
   - Add `UpdateBody` method to the JSON `Store` struct: find todo by ID, set Body, call Save().

4. Verify both compile-time checks pass: `var _ TodoStore = (*Store)(nil)` and `var _ TodoStore = (*SQLiteStore)(nil)`.
  </action>
  <verify>Run `go build ./...` -- no compilation errors. Both interface satisfaction checks pass.</verify>
  <done>Todo struct has Body field, scanTodo reads body from DB, UpdateBody method exists on both store implementations, TodoStore interface includes UpdateBody.</done>
</task>

<task type="auto">
  <name>Task 2: Add templates table migration and template CRUD methods</name>
  <files>internal/store/sqlite.go, internal/store/store.go</files>
  <action>
1. In `internal/store/sqlite.go`, extend the `migrate()` function:
   - After the `version < 1` block, add a `version < 2` block that:
     - Creates the templates table: `CREATE TABLE IF NOT EXISTS templates (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT NOT NULL UNIQUE, content TEXT NOT NULL, created_at TEXT NOT NULL)`
     - Sets `PRAGMA user_version = 2`

2. Add template CRUD methods to `SQLiteStore`:
   - `AddTemplate(name, content string) (Template, error)`: INSERT into templates, return the created Template. Use `time.Now().Format(dateFormat)` for created_at. Return error if name is not unique (UNIQUE constraint).
   - `ListTemplates() []Template`: SELECT all templates ordered by name. Return empty slice (not nil) if none.
   - `FindTemplate(id int) *Template`: SELECT by id, return nil if not found.
   - `DeleteTemplate(id int)`: DELETE by id.

3. In `internal/store/store.go`:
   - Add these four methods to the TodoStore interface: `AddTemplate(name, content string) (Template, error)`, `ListTemplates() []Template`, `FindTemplate(id int) *Template`, `DeleteTemplate(id int)`.
   - Add stub implementations on the JSON `Store` struct so it satisfies the interface:
     - `AddTemplate` returns `Template{}, fmt.Errorf("templates not supported in JSON store")`
     - `ListTemplates` returns `nil`
     - `FindTemplate` returns `nil`
     - `DeleteTemplate` is a no-op

4. The Add() method signature does NOT change. When creating a todo from a template, the UI will: (1) call Add(text, date) to get the todo, (2) call UpdateBody(todo.ID, body) to set the rendered template body.
  </action>
  <verify>Run `go build ./...` -- compiles. Run `go vet ./...` -- no issues.</verify>
  <done>Migration v2 creates templates table. SQLiteStore has working AddTemplate, ListTemplates, FindTemplate, DeleteTemplate. JSON Store has stub implementations. TodoStore interface includes all template methods.</done>
</task>

<task type="auto">
  <name>Task 3: Create template placeholder extraction and execution utilities</name>
  <files>internal/tmpl/tmpl.go</files>
  <action>
1. Create new package `internal/tmpl/` with file `tmpl.go`.

2. Implement `ExtractPlaceholders(content string) ([]string, error)`:
   - Use `text/template/parse.Parse("tpl", content, "{{", "}}")` to parse the template.
   - Walk the parse tree recursively to find all `*parse.FieldNode` instances.
   - Collect unique field names (FieldNode.Ident[0]) in order of first appearance.
   - Return the sorted unique names slice and nil error.
   - If parsing fails, return nil and the error.
   - Handle node types: ListNode, ActionNode, PipeNode, CommandNode, FieldNode, IfNode, RangeNode, WithNode (recursive walking).

3. Implement `ExecuteTemplate(content string, values map[string]string) (string, error)`:
   - Parse content with `template.New("tpl").Option("missingkey=zero").Parse(content)`.
   - Execute with the values map into a `strings.Builder`.
   - Return the result string and any error.

4. Both functions are pure (no side effects, no dependencies on store or UI packages).
  </action>
  <verify>Run `go build ./internal/tmpl/` -- compiles. Run `go vet ./internal/tmpl/` -- no issues.</verify>
  <done>ExtractPlaceholders correctly extracts unique {{.Field}} names from template content. ExecuteTemplate fills placeholders with provided values map. Both functions compile and handle edge cases (empty content, no placeholders, missing keys).</done>
</task>

</tasks>

<verification>
1. `go build ./...` passes with zero errors
2. `go vet ./...` passes with zero issues
3. The TodoStore interface has 20 methods (16 original + UpdateBody + AddTemplate + ListTemplates + FindTemplate + DeleteTemplate -- wait, that's 16 + 5 = 21). Actually count: original 16 methods + UpdateBody + AddTemplate + ListTemplates + FindTemplate + DeleteTemplate = 21 methods.
4. Both `*Store` and `*SQLiteStore` satisfy `TodoStore` (compile-time checks pass)
5. `internal/tmpl` package exists and builds independently
</verification>

<success_criteria>
- Todo.Body field exists and is read/written in all SQL queries
- Template type defined with ID, Name, Content, CreatedAt fields
- Templates table created by migration v2 with UNIQUE name constraint
- All 5 new methods on TodoStore interface implemented by both backends
- ExtractPlaceholders and ExecuteTemplate utilities compile and are importable
- Full project builds cleanly: `go build ./...`
</success_criteria>

<output>
After completion, create `.planning/phases/15-markdown-templates/15-01-SUMMARY.md`
</output>

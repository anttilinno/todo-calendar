---
phase: 15-markdown-templates
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - internal/preview/model.go
  - internal/preview/keys.go
  - internal/preview/styles.go
  - internal/todolist/model.go
  - internal/todolist/keys.go
  - internal/todolist/styles.go
  - internal/app/model.go
  - internal/app/keys.go
  - go.mod
  - go.sum
autonomous: true

must_haves:
  truths:
    - "User can press 'p' on a selected todo to open a full-screen markdown preview of its body"
    - "Preview renders markdown with styled headings, lists, and code blocks via glamour"
    - "User can scroll the preview with j/k and close it with Esc or q"
    - "Todos with a non-empty body show a [+] indicator in the todo list"
    - "Preview overlay blocks all other input while open (like search/settings)"
  artifacts:
    - path: "internal/preview/model.go"
      provides: "Preview overlay Bubble Tea model with viewport and glamour rendering"
      contains: "CloseMsg"
      min_lines: 40
    - path: "internal/preview/keys.go"
      provides: "Preview keybindings (scroll, close)"
      contains: "KeyMap"
    - path: "internal/preview/styles.go"
      provides: "Theme-integrated glamour renderer builder"
      contains: "NewMarkdownRenderer"
    - path: "internal/todolist/styles.go"
      provides: "BodyIndicator style for [+] marker"
      contains: "BodyIndicator"
  key_links:
    - from: "internal/app/model.go"
      to: "internal/preview/model.go"
      via: "showPreview bool + preview field + CloseMsg handler"
      pattern: "showPreview"
    - from: "internal/todolist/model.go"
      to: "internal/app/model.go"
      via: "PreviewMsg with todo ID"
      pattern: "PreviewMsg"
    - from: "internal/preview/styles.go"
      to: "github.com/charmbracelet/glamour"
      via: "glamour.NewTermRenderer with WithStyles"
      pattern: "glamour.NewTermRenderer"
---

<objective>
Build the markdown preview overlay and body indicator. Users can view any todo's markdown body in a full-screen styled preview, and see at a glance which todos have bodies.

Purpose: Implements MDTPL-04 (styled markdown rendering) and the visual affordance part of MDTPL-01 (body indicator). The preview overlay follows the established search/settings overlay pattern.
Output: New `preview` package, glamour dependency, body indicator in todolist, preview keybinding wired through app.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-markdown-templates/15-RESEARCH.md
@.planning/phases/15-markdown-templates/15-01-SUMMARY.md
@internal/app/model.go
@internal/app/keys.go
@internal/app/styles.go
@internal/todolist/model.go
@internal/todolist/keys.go
@internal/todolist/styles.go
@internal/search/model.go
@internal/theme/theme.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create preview package with glamour markdown rendering</name>
  <files>internal/preview/model.go, internal/preview/keys.go, internal/preview/styles.go, go.mod, go.sum</files>
  <action>
1. Run `go get github.com/charmbracelet/glamour@v0.10.0` to add the glamour dependency.

2. Create `internal/preview/keys.go`:
   - Define a `KeyMap` struct with bindings: `Up`, `Down`, `PageUp`, `PageDown`, `Close`.
   - `DefaultKeyMap()` returns: Up=k/up, Down=j/down, PageUp=pgup/b, PageDown=pgdown/f, Close=esc/q.
   - `HelpBindings()` returns bindings for help bar display.

3. Create `internal/preview/styles.go`:
   - Import `glamour`, `glamour/ansi`, `glamour/styles`, and the app's `theme` package.
   - `NewMarkdownRenderer(themeName string, width int) (*glamour.TermRenderer, error)`:
     - Pick base style: `styles.LightStyleConfig` for "light" theme, `styles.DarkStyleConfig` for all others.
     - Set `Document.Margin` to `&zero` (where zero is `uint(0)`) to prevent glamour adding its own padding.
     - Call `glamour.NewTermRenderer(glamour.WithStyles(baseStyle), glamour.WithWordWrap(width))`.
   - `Styles` struct with `Title`, `Border` lipgloss styles.
   - `NewStyles(t theme.Theme) Styles` constructor.

4. Create `internal/preview/model.go`:
   - Import `bubbles/viewport`.
   - `Model` struct fields: `title string`, `viewport viewport.Model`, `renderer *glamour.TermRenderer`, `rawBody string`, `width int`, `height int`, `keys KeyMap`, `styles Styles`, `themeName string`.
   - `CloseMsg struct{}` -- message emitted when user closes the preview.
   - `New(title, body, themeName string, t theme.Theme, width, height int) Model`:
     - Build renderer via `NewMarkdownRenderer(themeName, width-4)` (account for border padding).
     - Render the body: `rendered, err := renderer.Render(body)`. On error, use raw body.
     - Create viewport: `vp := viewport.New(width-4, height-4)`, `vp.SetContent(rendered)`.
     - If body is empty, set content to a muted "(no body)" message.
     - Store all fields and return.
   - `Update(msg tea.Msg) (Model, tea.Cmd)`:
     - On `tea.KeyMsg`: check Close keybinding -> return `CloseMsg` command. Otherwise forward to viewport.
     - On `tea.WindowSizeMsg`: update width/height, recreate renderer and viewport with new dimensions.
   - `View() string`:
     - Render a title bar at top (todo title, styled).
     - Render viewport content below.
     - Add a bottom hint line: "j/k scroll | Esc close".
     - Wrap everything in a border using styles.
   - `SetTheme(t theme.Theme)`: update styles, rebuild renderer.
   - `HelpBindings() []key.Binding`: return help-bar bindings.
  </action>
  <verify>Run `go build ./internal/preview/` -- compiles with glamour dependency.</verify>
  <done>Preview package exists with Model, KeyMap, Styles. Glamour renders markdown to styled ANSI. Viewport enables scrolling. CloseMsg emitted on Esc/q.</done>
</task>

<task type="auto">
  <name>Task 2: Wire preview overlay into app and add body indicator to todolist</name>
  <files>internal/todolist/model.go, internal/todolist/keys.go, internal/todolist/styles.go, internal/app/model.go, internal/app/keys.go</files>
  <action>
1. In `internal/todolist/styles.go`:
   - Add `BodyIndicator lipgloss.Style` field to the `Styles` struct.
   - In `NewStyles()`, set: `BodyIndicator: lipgloss.NewStyle().Foreground(t.MutedFg)`.

2. In `internal/todolist/model.go`:
   - In `renderTodo()`, after the text line but before the date, add body indicator:
     ```
     if t.HasBody() {
         text += " " + m.styles.BodyIndicator.Render("[+]")
     }
     ```
     Place this BEFORE the date rendering so it reads: "Todo text [+] 2026-01-15".
   - Add a `PreviewMsg` struct: `type PreviewMsg struct { Todo store.Todo }`. This is emitted when user wants to preview a todo's body.
   - In `updateNormalMode`, add a case for the new Preview keybinding (`p`):
     - If there's a selected todo and it has a body, emit a `PreviewMsg` command containing the todo.
     - If the todo has no body, do nothing (no preview for empty bodies).
   - Add `Preview` binding to `HelpBindings()` return slice (in normalMode only).

3. In `internal/todolist/keys.go`:
   - Add `Preview key.Binding` to the `KeyMap` struct.
   - In `DefaultKeyMap()`, add: `Preview: key.NewBinding(key.WithKeys("p"), key.WithHelp("p", "preview"))`.
   - Add `Preview` to `ShortHelp()` and `FullHelp()` returns.

4. In `internal/app/model.go`:
   - Import the `preview` package.
   - Add fields to `Model`: `showPreview bool`, `preview preview.Model`.
   - Add `preview.CloseMsg` handler in the top-level switch (alongside settings/search close handlers): set `m.showPreview = false`, return.
   - Add `todolist.PreviewMsg` handler: create a new preview.Model with the todo's title and body, set `m.showPreview = true`, return.
   - In `Update()`, add routing block: when `m.showPreview` is true, route messages to `m.updatePreview(msg)`. Place this AFTER settings but BEFORE search routing, or alongside it.
   - Add `updatePreview(msg tea.Msg) (tea.Model, tea.Cmd)` method following the same pattern as `updateSettings`/`updateSearch`: handle WindowSizeMsg for resize, forward everything else to `m.preview.Update(msg)`.
   - In `View()`, add a `showPreview` block (after showSettings, before showSearch): render `m.preview.View()` + help bar.
   - In `currentHelpKeys()`, add preview help bindings when `m.showPreview`.
   - In `applyTheme()`, add `m.preview.SetTheme(t)`.
  </action>
  <verify>Run `go build ./...` -- full project compiles. Verify that pressing 'p' on a todo with a body would trigger PreviewMsg (code review).</verify>
  <done>Body indicator [+] appears next to todos with non-empty body. Pressing 'p' on a selected todo opens a full-screen preview overlay with glamour-rendered markdown. Esc/q closes the preview. Preview follows the same overlay pattern as search/settings.</done>
</task>

</tasks>

<verification>
1. `go build ./...` passes with zero errors
2. `go vet ./...` passes
3. `go.mod` includes `github.com/charmbracelet/glamour v0.10.0`
4. `internal/preview/` package has model.go, keys.go, styles.go
5. todolist renderTodo shows `[+]` for todos where `HasBody()` is true
6. app model routes to preview overlay when showPreview is true
7. Preview CloseMsg returns to normal app view
</verification>

<success_criteria>
- Glamour dependency added and preview package builds
- Preview overlay renders markdown with headings, lists, code blocks as styled ANSI
- Viewport enables scrolling for long bodies
- Body indicator [+] visible in todo list for todos with non-empty body
- Preview keybinding (p) wired through todolist -> app -> preview overlay
- Full project compiles: `go build ./...`
</success_criteria>

<output>
After completion, create `.planning/phases/15-markdown-templates/15-02-SUMMARY.md`
</output>

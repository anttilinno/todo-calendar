---
phase: 17-visual-polish-help
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - internal/app/keys.go
  - internal/app/model.go
  - internal/todolist/model.go
autonomous: true

must_haves:
  truths:
    - "Normal mode help bar shows max 5 todo action keys plus ? instead of all 15"
    - "Pressing ? toggles the full keybinding list"
    - "Input modes show only Enter/Esc regardless of help expansion state"
    - "Expanded help uses multi-line layout and content panes shrink to accommodate"
  artifacts:
    - path: "internal/app/keys.go"
      provides: "Help key binding (?) in app KeyMap"
      contains: "Help"
    - path: "internal/app/model.go"
      provides: "? toggle handler, dynamic help height, expanded help routing"
      contains: "ShowAll"
    - path: "internal/todolist/model.go"
      provides: "Short and full help binding methods"
      contains: "AllHelpBindings"
  key_links:
    - from: "internal/app/model.go"
      to: "internal/todolist/model.go"
      via: "m.todoList.HelpBindings() and m.todoList.AllHelpBindings()"
      pattern: "m\\.todoList\\.(HelpBindings|AllHelpBindings)"
    - from: "internal/app/model.go"
      to: "help.Model.ShowAll"
      via: "m.help.ShowAll toggle in Update()"
      pattern: "m\\.help\\.ShowAll"
---

<objective>
Rework the help bar to be mode-aware: show max 5 keys in normal mode, full list on ?, and Enter/Esc only in input modes.

Purpose: The current help bar shows 19 bindings in normal mode, overwhelming users. This plan reduces cognitive load by showing only the most useful keys and providing ? for discovery.
Output: Mode-aware help bar with ? toggle, dynamic height calculation, and FullHelp column layout.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-visual-polish-help/17-01-SUMMARY.md
@internal/app/keys.go
@internal/app/model.go
@internal/app/styles.go
@internal/todolist/model.go
@internal/todolist/keys.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ? keybinding and short/full help methods</name>
  <files>internal/app/keys.go, internal/todolist/model.go</files>
  <action>
**In `internal/app/keys.go`:**

1. Add `Help key.Binding` field to the KeyMap struct.
2. Add the Help binding to ShortHelp() return slice.
3. Add the Help binding to FullHelp() return slice.
4. In DefaultKeyMap(), add:
```go
Help: key.NewBinding(
    key.WithKeys("?"),
    key.WithHelp("?", "help"),
),
```

**In `internal/todolist/model.go`:**

1. Rename the existing `HelpBindings()` method to return only the SHORT list (max 5 keys) for normal mode. Change the normal-mode return from the full 15 bindings to just 5 most-used keys:
```go
func (m Model) HelpBindings() []key.Binding {
    if m.mode != normalMode {
        return []key.Binding{m.keys.Confirm, m.keys.Cancel}
    }
    // HELP-01: max 5 most-used keys
    return []key.Binding{m.keys.Add, m.keys.Toggle, m.keys.Delete, m.keys.Edit, m.keys.Filter}
}
```

The 5 keys are: `a` (add), `x` (complete), `d` (delete), `e` (edit), `/` (filter). These are the most-used CRUD and discovery operations.

2. Add a new `AllHelpBindings()` method that returns ALL bindings for the expanded help view. For non-normal modes, still return only Confirm/Cancel:
```go
func (m Model) AllHelpBindings() []key.Binding {
    if m.mode != normalMode {
        return []key.Binding{m.keys.Confirm, m.keys.Cancel}
    }
    return []key.Binding{
        m.keys.Up, m.keys.Down, m.keys.MoveUp, m.keys.MoveDown,
        m.keys.Add, m.keys.AddDated, m.keys.Edit, m.keys.EditDate,
        m.keys.Toggle, m.keys.Delete, m.keys.Filter,
        m.keys.Preview, m.keys.OpenEditor, m.keys.TemplateUse, m.keys.TemplateCreate,
    }
}
```
  </action>
  <verify>Run `go build ./...` -- must compile.</verify>
  <done>App has ? key binding. Todolist has short (5 keys) and full (15 keys) help methods.</done>
</task>

<task type="auto">
  <name>Task 2: Wire ? toggle, expanded help routing, and dynamic help height</name>
  <files>internal/app/model.go</files>
  <action>
Four changes in this file:

**1. Handle ? key in Update().**
In the `case tea.KeyMsg:` block inside `Update()` (around line 187), add a new case for the Help key AFTER the Search case and BEFORE the closing of the switch block. It must be guarded by `!isInputting`:
```go
case key.Matches(msg, m.keys.Help) && !isInputting:
    m.help.ShowAll = !m.help.ShowAll
    return m, nil
```

This toggles `help.Model.ShowAll` which switches between ShortHelp and FullHelp rendering.

**2. Update currentHelpKeys() to route short vs full bindings.**
In `currentHelpKeys()` (around line 328), change the todoPane case to check `m.help.ShowAll`:

Replace:
```go
case todoPane:
    bindings = append(bindings, m.todoList.HelpBindings()...)
```
With:
```go
case todoPane:
    if m.help.ShowAll {
        bindings = append(bindings, m.todoList.AllHelpBindings()...)
    } else {
        bindings = append(bindings, m.todoList.HelpBindings()...)
    }
```

Then, AFTER appending the app-level keys (Tab, Settings, Search, Quit), append the Help binding for the todo pane in normal mode so `?` appears in the help bar:
```go
bindings = append(bindings, m.keys.Tab, m.keys.Settings, m.keys.Search, m.keys.Quit)
// Show ? toggle hint when todo pane is focused and not inputting
if m.activePane == todoPane && !m.todoList.IsInputting() {
    m.keys.Help.SetHelp("?", "help")
    if m.help.ShowAll {
        m.keys.Help.SetHelp("?", "close help")
    }
    bindings = append(bindings, m.keys.Help)
}
return helpKeyMap{bindings: bindings}
```

Wait -- this adds complexity. Simpler approach: always append `m.keys.Help` as one of the bindings, but only when the todo pane is focused and not in input mode. Add this BEFORE the final return statement. Use the current m.keys.Help binding directly -- no need to change the help text dynamically.

Actually, simplest: just append `m.keys.Help` unconditionally after the app keys. It will show "? help" in the bar. In input modes, `HelpBindings()` returns only Confirm/Cancel, so the ? won't be in the todo section, but it'll still appear in the app section. That's fine for discoverability.

Revised approach -- add after `m.keys.Quit`:
```go
bindings = append(bindings, m.keys.Tab, m.keys.Settings, m.keys.Search, m.keys.Quit)
if !m.todoList.IsInputting() || m.activePane == calendarPane {
    bindings = append(bindings, m.keys.Help)
}
```

This hides `?` during input modes (HELP-02: input modes show only Enter/Esc) but shows it at all other times.

**3. Update helpKeyMap.FullHelp() to return proper column groups.**
Currently `helpKeyMap.FullHelp()` returns a single group:
```go
func (h helpKeyMap) FullHelp() [][]key.Binding { return [][]key.Binding{h.bindings} }
```

Change it to split bindings into groups of 5 for column rendering:
```go
func (h helpKeyMap) FullHelp() [][]key.Binding {
    if len(h.bindings) <= 5 {
        return [][]key.Binding{h.bindings}
    }
    var groups [][]key.Binding
    for i := 0; i < len(h.bindings); i += 5 {
        end := i + 5
        if end > len(h.bindings) {
            end = len(h.bindings)
        }
        groups = append(groups, h.bindings[i:end])
    }
    return groups
}
```

This creates ~4 columns of 5 bindings each when expanded, which `help.FullHelpView` renders side-by-side.

**4. Make help height dynamic in View().**
In `View()` (around line 385-418), the help bar height is hardcoded to 1. Change the main pane rendering block to calculate help FIRST, then size content panes from remaining space.

Replace the current code (lines ~385-418):
```go
// Calculate frame overhead from pane style
frameH, frameV := m.styles.Pane(true).GetFrameSize()

helpHeight := 1
contentHeight := m.height - helpHeight - frameV
```

With:
```go
// Calculate help bar first so we can measure its height
m.help.Width = m.width
helpBar := m.help.View(m.currentHelpKeys())
helpHeight := lipgloss.Height(helpBar)
if helpHeight < 1 {
    helpHeight = 1
}

// Calculate frame overhead from pane style
frameH, frameV := m.styles.Pane(true).GetFrameSize()
contentHeight := m.height - helpHeight - frameV
```

And at the bottom of View(), REMOVE the duplicate help bar calculation and use the one already computed. Change:
```go
m.help.Width = m.width
helpBar := m.help.View(m.currentHelpKeys())

return lipgloss.JoinVertical(lipgloss.Left, top, helpBar)
```
To:
```go
return lipgloss.JoinVertical(lipgloss.Left, top, helpBar)
```

The `helpBar` variable is already computed at the top. Remove the second `m.help.Width` and `m.help.View()` calls.

**5. Set FullHelp styles in help.Model initialization.**
In `New()` function (around line 70-73) and in `applyTheme()` (around line 323-325), add FullHelp styles alongside the existing ShortHelp styles:

In `New()`, after the ShortSeparator line:
```go
h.Styles.FullKey = lipgloss.NewStyle().Foreground(t.AccentFg)
h.Styles.FullDesc = lipgloss.NewStyle().Foreground(t.MutedFg)
h.Styles.FullSeparator = lipgloss.NewStyle().Foreground(t.MutedFg)
```

In `applyTheme()`, after the ShortSeparator line:
```go
m.help.Styles.FullKey = lipgloss.NewStyle().Foreground(t.AccentFg)
m.help.Styles.FullDesc = lipgloss.NewStyle().Foreground(t.MutedFg)
m.help.Styles.FullSeparator = lipgloss.NewStyle().Foreground(t.MutedFg)
```

Without these, the expanded help will use default (unstyled) rendering.

**6. Reset ShowAll when entering input mode or switching panes.**
This is a nice-to-have but avoids the expanded help persisting unexpectedly. In the Tab handling case (around line 192-202), add:
```go
m.help.ShowAll = false
```

Similarly, when entering settings, search, or preview overlays, reset ShowAll (optional but clean).
  </action>
  <verify>Run `go build ./...` -- must compile. Run `go vet ./...` for static analysis.</verify>
  <done>Pressing ? toggles expanded help. Normal mode shows 5 keys + ?. Input modes show Enter/Esc. Help bar grows/shrinks dynamically. Content panes resize accordingly.</done>
</task>

</tasks>

<verification>
1. `go build ./...` compiles without errors
2. `go vet ./...` passes
3. Visual verification:
   - Normal mode help bar shows ~10 items: 5 todo keys (a/add, x/complete, d/delete, e/edit, //filter) + tab + s/settings + C-f/search + q/quit + ?/help
   - Press ?: help bar expands to show all 15 todo bindings in columns, content panes shrink
   - Press ? again: help bar collapses back to short mode
   - Enter input mode (press a): help shows only "enter confirm . esc cancel"
   - Calendar pane: help shows calendar keys + app keys + ?
   - Switch panes with Tab: expanded help resets to collapsed
</verification>

<success_criteria>
- HELP-01: Normal mode shows max 5 todo action keys (not all 15)
- HELP-02: Input modes show only Enter/Esc
- HELP-03: ? reveals full keybinding list in multi-line column layout
- Dynamic help height: content panes resize when help expands/collapses
- All 4 themes render help styles correctly
</success_criteria>

<output>
After completion, create `.planning/phases/17-visual-polish-help/17-02-SUMMARY.md`
</output>

---
phase: 21-schedule-schema-crud
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/store/todo.go
  - internal/store/store.go
  - internal/store/sqlite.go
  - internal/store/sqlite_test.go
autonomous: true

must_haves:
  truths:
    - "Migration v4 creates schedules table with FK CASCADE to templates"
    - "Migration v5 adds schedule_id and schedule_date columns to todos table with unique dedup index"
    - "AddSchedule persists a schedule linked to a template and returns it with an ID"
    - "ListSchedules returns all schedules ordered by ID"
    - "ListSchedulesForTemplate returns only schedules for a given template"
    - "DeleteSchedule removes a schedule by ID"
    - "UpdateSchedule modifies cadence and placeholder defaults"
    - "TodoExistsForSchedule correctly detects duplicates by schedule_id + date"
    - "AddScheduledTodo creates a todo linked to a schedule with schedule_date set"
    - "Deleting a template cascades to delete its schedules"
    - "Deleting a schedule sets schedule_id to NULL on linked todos (SET NULL)"
  artifacts:
    - path: "internal/store/todo.go"
      provides: "Schedule struct and Todo.ScheduleID/ScheduleDate fields"
      contains: "type Schedule struct"
    - path: "internal/store/store.go"
      provides: "TodoStore interface with 7 schedule methods"
      contains: "AddSchedule"
    - path: "internal/store/sqlite.go"
      provides: "Migration v4+v5 and SQLite schedule method implementations"
      contains: "version < 4"
    - path: "internal/store/sqlite_test.go"
      provides: "Integration tests for schedule CRUD and FK behavior"
      contains: "TestSchedule"
  key_links:
    - from: "internal/store/sqlite.go"
      to: "internal/store/store.go"
      via: "SQLiteStore implements TodoStore schedule methods"
      pattern: "func \\(s \\*SQLiteStore\\) AddSchedule"
    - from: "internal/store/sqlite.go"
      to: "internal/store/todo.go"
      via: "Uses Schedule struct in return types"
      pattern: "Schedule\\{"
    - from: "internal/store/store.go"
      to: "internal/store/todo.go"
      via: "Interface references Schedule type"
      pattern: "Schedule"
---

<objective>
Add Schedule struct, extend TodoStore interface with 7 schedule methods, implement migrations v4+v5 in SQLite, and implement all schedule CRUD methods with deduplication support.

Purpose: This provides the complete data layer for recurring schedules -- schema, types, interface contract, and SQLite implementation -- so Phase 22 can build the UI and auto-creation logic on top.
Output: Extended store package with schedule support, tested with integration tests.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@internal/store/todo.go
@internal/store/store.go
@internal/store/sqlite.go
@internal/store/sqlite_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schedule struct, Todo fields, and interface extension</name>
  <files>internal/store/todo.go, internal/store/store.go</files>
  <action>
    In internal/store/todo.go, add:

    1. Schedule struct (after Template struct):
    ```go
    type Schedule struct {
        ID                  int
        TemplateID          int
        CadenceType         string
        CadenceValue        string
        PlaceholderDefaults string // JSON object of default placeholder values
        CreatedAt           string
    }
    ```

    2. Add two optional fields to the Todo struct (after SortOrder):
    ```go
    ScheduleID   int    `json:"schedule_id,omitempty"`
    ScheduleDate string `json:"schedule_date,omitempty"`
    ```

    In internal/store/store.go, add 7 methods to the TodoStore interface (grouped together after the template methods, before SwapOrder):
    ```go
    // Schedule operations
    AddSchedule(templateID int, cadenceType, cadenceValue, placeholderDefaults string) (Schedule, error)
    ListSchedules() []Schedule
    ListSchedulesForTemplate(templateID int) []Schedule
    DeleteSchedule(id int)
    UpdateSchedule(id int, cadenceType, cadenceValue, placeholderDefaults string) error
    TodoExistsForSchedule(scheduleID int, date string) bool
    AddScheduledTodo(text, date, body string, scheduleID int) Todo
    ```

    Also add JSON store stubs for all 7 methods at the bottom of store.go (after the existing template stubs), following the same pattern:
    - AddSchedule returns Schedule{}, fmt.Errorf("schedules not supported in JSON store")
    - ListSchedules returns nil
    - ListSchedulesForTemplate returns nil
    - DeleteSchedule is a no-op
    - UpdateSchedule returns fmt.Errorf("schedules not supported in JSON store")
    - TodoExistsForSchedule returns false
    - AddScheduledTodo returns Todo{}
  </action>
  <verify>
    `cd /home/antti/Repos/Misc/todo-calendar && go build ./...` compiles without errors (the compile-time interface checks in both store.go and sqlite.go will catch missing implementations).
  </verify>
  <done>Schedule struct defined, Todo has ScheduleID/ScheduleDate fields, TodoStore interface has 7 schedule methods, JSON store stubs compile.</done>
</task>

<task type="auto">
  <name>Task 2: SQLite migrations v4+v5 and schedule method implementations</name>
  <files>internal/store/sqlite.go, internal/store/sqlite_test.go</files>
  <action>
    In internal/store/sqlite.go, add migrations to the migrate() function:

    Migration v4 (after the version < 3 block):
    ```sql
    CREATE TABLE IF NOT EXISTS schedules (
        id                    INTEGER PRIMARY KEY AUTOINCREMENT,
        template_id           INTEGER NOT NULL REFERENCES templates(id) ON DELETE CASCADE,
        cadence_type          TEXT    NOT NULL,
        cadence_value         TEXT    NOT NULL DEFAULT '',
        placeholder_defaults  TEXT    NOT NULL DEFAULT '{}',
        created_at            TEXT    NOT NULL
    );
    CREATE INDEX IF NOT EXISTS idx_schedules_template ON schedules(template_id);
    PRAGMA user_version = 4;
    ```

    Migration v5:
    ```sql
    ALTER TABLE todos ADD COLUMN schedule_id INTEGER REFERENCES schedules(id) ON DELETE SET NULL;
    ALTER TABLE todos ADD COLUMN schedule_date TEXT;
    CREATE UNIQUE INDEX IF NOT EXISTS idx_todos_schedule_dedup ON todos(schedule_id, schedule_date);
    PRAGMA user_version = 5;
    ```

    Update todoColumns constant to include the two new columns:
    ```go
    const todoColumns = "id, text, body, date, done, created_at, sort_order, schedule_id, schedule_date"
    ```

    Update scanTodo to scan the two new nullable columns:
    ```go
    var scheduleID sql.NullInt64
    var scheduleDate sql.NullString
    // Add to Scan: ..., &scheduleID, &scheduleDate
    if scheduleID.Valid {
        t.ScheduleID = int(scheduleID.Int64)
    }
    if scheduleDate.Valid {
        t.ScheduleDate = scheduleDate.String
    }
    ```

    Implement all 7 schedule methods on SQLiteStore:

    AddSchedule: INSERT INTO schedules, return Schedule with LastInsertId.

    ListSchedules: SELECT all from schedules ORDER BY id.

    ListSchedulesForTemplate: SELECT from schedules WHERE template_id = ? ORDER BY id.

    DeleteSchedule: DELETE FROM schedules WHERE id = ?.

    UpdateSchedule: UPDATE schedules SET cadence_type = ?, cadence_value = ?, placeholder_defaults = ? WHERE id = ?. Return error if update fails.

    TodoExistsForSchedule: SELECT 1 FROM todos WHERE schedule_id = ? AND schedule_date = ? LIMIT 1. Return true if row found.

    AddScheduledTodo: INSERT INTO todos with schedule_id and schedule_date set. Compute sort_order as MAX+10 (same as Add). The date parameter is the todo's display date (YYYY-MM-DD), body is the rendered template content, schedule_date is the dedup key (same as date). Return the created Todo.

    Add a helper scanSchedule and scanSchedules similar to the todo scanners.

    In internal/store/sqlite_test.go, add integration tests:

    1. TestScheduleCRUD: Create a template, add a schedule, list schedules, list for template, update, delete. Verify each step.

    2. TestScheduleDeduplication: Create a schedule, add a scheduled todo for a date, verify TodoExistsForSchedule returns true for that date and false for a different date. Verify adding a second todo for the same schedule+date fails (UNIQUE constraint).

    3. TestScheduleCascadeOnTemplateDelete: Create template, add schedule, delete template, verify schedule is gone (ListSchedules returns empty).

    4. TestScheduleSetNullOnDelete: Create template, add schedule, add scheduled todo, delete schedule, verify todo still exists but ScheduleID is 0.

    5. TestAddScheduledTodo: Create template, add schedule, add scheduled todo, verify it appears in TodosForMonth with correct fields including ScheduleID and ScheduleDate.
  </action>
  <verify>
    `cd /home/antti/Repos/Misc/todo-calendar && go test ./internal/store/ -v -run TestSchedule` -- all new tests pass.
    `cd /home/antti/Repos/Misc/todo-calendar && go test ./internal/store/ -v` -- ALL existing tests still pass (seed template tests, etc.).
    `cd /home/antti/Repos/Misc/todo-calendar && go vet ./...` -- no issues.
  </verify>
  <done>Migration v4 creates schedules table with FK CASCADE, migration v5 adds schedule_id/schedule_date to todos with unique dedup index, all 7 SQLite methods work correctly, FK cascade and SET NULL behaviors verified by tests, existing tests unbroken.</done>
</task>

</tasks>

<verification>
- `cd /home/antti/Repos/Misc/todo-calendar && go test ./internal/store/ -v` -- all store tests pass (existing + new)
- `cd /home/antti/Repos/Misc/todo-calendar && go build ./...` -- full project compiles
- `cd /home/antti/Repos/Misc/todo-calendar && go vet ./...` -- clean
- Migration v4 creates schedules table (verify via test creating SQLiteStore on fresh db)
- Migration v5 adds columns to todos (verify via test that scans scheduled todo)
- FK CASCADE: deleting template deletes its schedules (TestScheduleCascadeOnTemplateDelete)
- FK SET NULL: deleting schedule nullifies schedule_id on todos (TestScheduleSetNullOnDelete)
- Dedup: UNIQUE(schedule_id, schedule_date) prevents duplicate scheduled todos (TestScheduleDeduplication)
</verification>

<success_criteria>
- Schedule struct exists in store/todo.go with all required fields
- Todo struct has ScheduleID and ScheduleDate fields
- TodoStore interface has all 7 schedule methods
- JSON Store has stubs for all 7 methods
- SQLiteStore migrations v4 and v5 run on fresh and existing databases
- All 7 SQLite schedule methods implemented and tested
- FK CASCADE verified: template delete cascades to schedules
- FK SET NULL verified: schedule delete nullifies todo.schedule_id
- Dedup index verified: same schedule_id+schedule_date rejected
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/21-schedule-schema-crud/21-02-SUMMARY.md`
</output>

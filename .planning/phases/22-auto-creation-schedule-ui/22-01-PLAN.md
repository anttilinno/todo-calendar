---
phase: 22-auto-creation-schedule-ui
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - internal/recurring/generate.go
  - internal/recurring/generate_test.go
  - main.go
autonomous: true

must_haves:
  truths:
    - "AutoCreate produces todos for all matching dates in a 7-day window"
    - "AutoCreate skips dates where a todo already exists (deduplication)"
    - "AutoCreate executes template placeholders with stored defaults"
    - "AutoCreate runs before TUI starts in main.go"
  artifacts:
    - path: "internal/recurring/generate.go"
      provides: "AutoCreate function"
      exports: ["AutoCreate"]
    - path: "internal/recurring/generate_test.go"
      provides: "Tests for auto-creation logic"
      min_lines: 50
    - path: "main.go"
      provides: "AutoCreate call between store init and app.New"
  key_links:
    - from: "internal/recurring/generate.go"
      to: "store.TodoStore"
      via: "interface parameter"
      pattern: "store\\.TodoStore"
    - from: "internal/recurring/generate.go"
      to: "internal/recurring/rule.go"
      via: "ParseRule + MatchesDate"
      pattern: "ParseRule|MatchesDate"
    - from: "internal/recurring/generate.go"
      to: "internal/tmpl/tmpl.go"
      via: "ExecuteTemplate for placeholder fill"
      pattern: "tmpl\\.ExecuteTemplate"
    - from: "main.go"
      to: "internal/recurring/generate.go"
      via: "recurring.AutoCreate(s) call"
      pattern: "recurring\\.AutoCreate"
---

<objective>
Implement the auto-creation engine that generates scheduled todos on app launch.

Purpose: REQ-31 -- On startup, iterate all schedules and create todos for matching dates in a rolling 7-day window (today + 6 days) with deduplication. Templates with placeholders use stored defaults.
Output: Tested AutoCreate function wired into main.go.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@internal/recurring/rule.go
@internal/store/store.go
@internal/store/todo.go
@internal/tmpl/tmpl.go
@main.go
</context>

<tasks>

<feature>
  <name>AutoCreate: Generate scheduled todos for 7-day window</name>
  <files>internal/recurring/generate.go, internal/recurring/generate_test.go, main.go</files>
  <behavior>
    AutoCreate(s store.TodoStore) iterates all schedules from s.ListSchedules().
    For each schedule:
    1. Parse cadence: build rule string from CadenceType + CadenceValue (e.g., "weekly" + "mon,fri" -> "weekly:mon,fri"; "daily" + "" -> "daily"; "monthly" + "15" -> "monthly:15").
    2. For each date in [today, today+1, ..., today+6]:
       a. Check rule.MatchesDate(date) -- skip if no match
       b. Check s.TodoExistsForSchedule(schedule.ID, dateStr) -- skip if exists (dedup)
       c. Find template via s.FindTemplate(schedule.TemplateID) -- skip if nil (orphan schedule)
       d. Execute template content with placeholder defaults: parse schedule.PlaceholderDefaults as JSON map, call tmpl.ExecuteTemplate(template.Content, defaults) to produce body
       e. Call s.AddScheduledTodo(template.Name, dateStr, body, schedule.ID)

    Test cases:
    - Daily schedule creates todos for all 7 days
    - Weekly schedule creates todos only on matching weekdays
    - Monthly schedule creates todo only on matching day (if in window)
    - Dedup: calling AutoCreate twice produces no extra todos
    - Template with placeholders: body contains filled values from defaults
    - Template with placeholders but empty defaults: body has empty placeholder values
    - Schedule with missing template (FindTemplate returns nil): skipped, no panic
    - Schedule with unparseable cadence: skipped, no panic

    Use a mock/fake TodoStore for testing (implement the minimal TodoStore interface methods needed).
  </behavior>
  <implementation>
    Create internal/recurring/generate.go with:
    - func AutoCreate(s store.TodoStore) that implements the algorithm above
    - Helper: buildRuleString(cadenceType, cadenceValue string) string -- concatenates type:value (or just type for daily/weekdays)
    - Uses time.Now() for today; for testability, also expose func AutoCreateForDate(s store.TodoStore, today time.Time) so tests can pin the date

    Create internal/recurring/generate_test.go with a fakeStore implementing TodoStore interface (only the methods AutoCreate calls: ListSchedules, FindTemplate, TodoExistsForSchedule, AddScheduledTodo). Use table-driven tests.

    Wire into main.go: after `s, err := store.NewSQLiteStore(dbPath)` and before `model := app.New(...)`, add `recurring.AutoCreate(s)`. Import the recurring package.
  </implementation>
</feature>

</tasks>

<verification>
- `cd /home/antti/Repos/Misc/todo-calendar && go test ./internal/recurring/ -v -run TestAutoCreate` passes all test cases
- `cd /home/antti/Repos/Misc/todo-calendar && go build ./...` compiles with no errors (main.go wiring)
- `grep -n "recurring.AutoCreate" main.go` shows the call between store init and app.New
</verification>

<success_criteria>
- AutoCreate generates todos for matching dates in 7-day window
- Deduplication prevents duplicate todos on repeated runs
- Placeholder defaults from schedule are used to fill template body
- Missing templates and bad cadences are gracefully skipped
- All tests pass
- main.go calls AutoCreate before TUI launch
</success_criteria>

<output>
After completion, create `.planning/phases/22-auto-creation-schedule-ui/22-01-SUMMARY.md`
</output>

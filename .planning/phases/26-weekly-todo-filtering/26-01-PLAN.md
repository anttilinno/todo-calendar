---
phase: 26-weekly-todo-filtering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/store/iface.go
  - internal/store/sqlite.go
  - internal/store/todo.go
  - internal/calendar/model.go
  - internal/todolist/model.go
  - internal/app/model.go
autonomous: true

must_haves:
  truths:
    - "In weekly view, todo panel shows only todos dated within that week's Monday-Sunday (or Sunday-Saturday) range"
    - "Floating (undated) todos remain visible in the todo panel regardless of which week is selected"
    - "When user presses h/l to navigate weeks, the todo panel immediately shows the new week's todos"
    - "When user presses w to return to monthly view, the todo panel reverts to showing all month todos"
  artifacts:
    - path: "internal/store/iface.go"
      provides: "TodosForDateRange method on TodoStore interface"
      contains: "TodosForDateRange"
    - path: "internal/store/sqlite.go"
      provides: "SQLite implementation of TodosForDateRange"
      contains: "func (s *SQLiteStore) TodosForDateRange"
    - path: "internal/calendar/model.go"
      provides: "WeekStart getter for app model to read current week boundary"
      contains: "func (m Model) WeekStart()"
    - path: "internal/todolist/model.go"
      provides: "Week filter state and conditional query logic in visibleItems"
      contains: "weekFilterStart"
    - path: "internal/app/model.go"
      provides: "Wiring that syncs calendar view mode to todolist week filter"
      contains: "SetWeekFilter"
  key_links:
    - from: "internal/app/model.go"
      to: "internal/calendar/model.go"
      via: "GetViewMode() and WeekStart() calls"
      pattern: "calendar\\.GetViewMode\\(\\)|calendar\\.WeekStart\\(\\)"
    - from: "internal/app/model.go"
      to: "internal/todolist/model.go"
      via: "SetWeekFilter/ClearWeekFilter calls"
      pattern: "todoList\\.SetWeekFilter|todoList\\.ClearWeekFilter"
    - from: "internal/todolist/model.go"
      to: "internal/store/iface.go"
      via: "TodosForDateRange call in visibleItems when week filter active"
      pattern: "store\\.TodosForDateRange"
---

<objective>
Add weekly todo filtering so the todo panel shows only the current week's todos (plus floating items) when the calendar is in weekly view, with instant updates on week navigation.

Purpose: Users currently see all month's todos even in weekly view, which defeats the purpose of the focused weekly perspective. This makes the weekly view useful for task focus.
Output: Modified store interface, SQLite query, calendar getter, todolist filter, and app wiring.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@internal/store/iface.go
@internal/store/sqlite.go
@internal/store/todo.go
@internal/calendar/model.go
@internal/todolist/model.go
@internal/app/model.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add date-range query and model support</name>
  <files>internal/store/iface.go, internal/store/sqlite.go, internal/store/todo.go, internal/calendar/model.go, internal/todolist/model.go</files>
  <action>
1. **Store interface** (`internal/store/iface.go`): Add `TodosForDateRange(startDate, endDate string) []Todo` method to the `TodoStore` interface. Parameters are ISO date strings ("YYYY-MM-DD"). Returns todos whose date falls within [startDate, endDate] inclusive, sorted by sort_order, date, id (same as TodosForMonth).

2. **SQLite implementation** (`internal/store/sqlite.go`): Implement `TodosForDateRange` on `*SQLiteStore`. Follow the exact pattern of `TodosForMonth` (line 272-287): use the same SQL query structure (`SELECT todoColumns FROM todos WHERE date >= ? AND date <= ? ORDER BY sort_order, date, id`) but pass startDate and endDate directly as parameters instead of computing them from year/month.

3. **Todo helper** (`internal/store/todo.go`): Add `InDateRange(startDate, endDate string) bool` method on `Todo`. Return false if `t.Date == ""`. Parse `t.Date`, `startDate`, and `endDate` using `dateFormat` ("2006-01-02"). Return true if todo date >= startDate and <= endDate. This mirrors the existing `InMonth` helper.

4. **Calendar getter** (`internal/calendar/model.go`): Add `WeekStart() time.Time` public getter that returns `m.weekStart`. This allows the app model to compute the week's date range. The weekStart field is already maintained by the existing toggle/navigation logic.

5. **Todolist week filter** (`internal/todolist/model.go`):
   - Add two new fields to the `Model` struct: `weekFilterStart string` and `weekFilterEnd string` (ISO date strings, empty = no filter).
   - Add `SetWeekFilter(startDate, endDate string)` method that sets both fields AND resets cursor to 0 and clears any active inline filter (same pattern as SetViewMonth).
   - Add `ClearWeekFilter()` method that clears both fields to "".
   - Modify `visibleItems()`: After the month header line (`monthLabel := ...`), check `if m.weekFilterStart != ""`. If active, use `m.store.TodosForDateRange(m.weekFilterStart, m.weekFilterEnd)` instead of `m.store.TodosForMonth(m.viewYear, m.viewMonth)` to get dated todos. Also change the header label: when week filter is active, show "Week of {startDate}" instead of "January 2026" format (use the start date formatted via the dateLayout for user-friendliness). Floating todos section is unchanged -- `m.store.FloatingTodos()` is always called regardless of week filter.
  </action>
  <verify>
Run `go build ./...` to confirm all interface implementations are satisfied and no compile errors. Run `go test ./...` to confirm existing tests pass. Grep for `TodosForDateRange` in iface.go, sqlite.go, and todolist/model.go to confirm the wiring chain exists.
  </verify>
  <done>
TodoStore interface has TodosForDateRange method. SQLiteStore implements it. Calendar exposes WeekStart(). Todolist model has SetWeekFilter/ClearWeekFilter methods and visibleItems() conditionally uses date-range query when filter is active. All code compiles and existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire app model to sync weekly view with todo filtering</name>
  <files>internal/app/model.go</files>
  <action>
Add a helper method `syncTodoView()` on `*Model` that replaces the scattered `m.todoList.SetViewMonth(...)` calls with view-mode-aware logic:

```go
func (m *Model) syncTodoView() {
    m.todoList.SetViewMonth(m.calendar.Year(), m.calendar.Month())
    if m.calendar.GetViewMode() == calendar.WeekView {
        ws := m.calendar.WeekStart()
        we := ws.AddDate(0, 0, 6)
        m.todoList.SetWeekFilter(
            ws.Format("2006-01-02"),
            we.Format("2006-01-02"),
        )
    } else {
        m.todoList.ClearWeekFilter()
    }
}
```

Then replace every occurrence of `m.todoList.SetViewMonth(m.calendar.Year(), m.calendar.Month())` in the Update method with `m.syncTodoView()`. There are 4 call sites to update:

1. **Tab switching** (line ~273): `m.todoList.SetViewMonth(...)` -> `m.syncTodoView()`
2. **WindowSizeMsg** (line ~305): `m.todoList.SetViewMonth(...)` -> `m.syncTodoView()`
3. **Calendar navigation sync** (line ~323): `m.todoList.SetViewMonth(...)` -> `m.syncTodoView()`
4. **SearchJumpMsg** (line ~154): `m.todoList.SetViewMonth(msg.Year, msg.Month)` -> keep this as-is but ALSO call `m.todoList.ClearWeekFilter()` after it, since jumping from search should exit weekly filtering context.

This ensures:
- Pressing `w` to enter weekly view -> syncTodoView detects WeekView -> sets week filter
- Pressing `h`/`l` in weekly view -> calendar updates weekStart -> syncTodoView sets new week filter
- Pressing `w` to exit weekly view -> syncTodoView detects MonthView -> clears week filter
- Tab switching preserves the correct filter state
- Search jump clears week filter (monthly context)
  </action>
  <verify>
Run `go build ./...` to confirm compilation. Run the app with `go run .` and test:
1. Start app, press Tab to see todo list, verify normal month view works
2. Press Tab back to calendar, press `w` to enter weekly view -- todo panel should show only this week's dated todos plus floating todos
3. Press `h` to go to previous week -- todo panel should update to show previous week's todos
4. Press `l` to go to next week -- todo panel updates again
5. Press `w` to exit weekly view -- todo panel reverts to showing all month's todos
6. Run `go test ./...` to confirm all tests pass
  </verify>
  <done>
All 4 SetViewMonth call sites updated to use syncTodoView. Pressing w toggles between weekly-filtered and monthly-full todo lists. Navigation with h/l in weekly mode instantly updates the todo panel. Returning to monthly view shows all month todos. Floating todos always visible.
  </done>
</task>

</tasks>

<verification>
- `go build ./...` succeeds
- `go test ./...` passes
- In weekly view: todo panel header shows "Week of {date}" and only that week's dated todos appear
- In weekly view: floating todos section unchanged, always visible
- Week navigation (h/l): todo panel updates immediately
- Toggling back to monthly view (w): todo panel shows full month todos with month header
- Tab switching preserves correct filter state
- Search jump returns to monthly context
</verification>

<success_criteria>
All 4 requirements satisfied:
1. WKLY-01: Weekly view filters todo panel to visible week's date range
2. WKLY-02: Floating todos always visible regardless of week
3. WKLY-03: h/l navigation immediately updates todo panel
4. Implicit: w toggle back to monthly restores full month view
</success_criteria>

<output>
After completion, create `.planning/phases/26-weekly-todo-filtering/26-01-SUMMARY.md`
</output>

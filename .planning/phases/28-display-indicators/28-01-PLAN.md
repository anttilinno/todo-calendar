---
phase: 28-display-indicators
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/todolist/model.go
autonomous: true

must_haves:
  truths:
    - "Month-level todos appear in a 'This Month' section below the dated section"
    - "Year-level todos appear in a 'This Year' section below the month section"
    - "Sections update when navigating months (This Month matches viewed month)"
    - "Sections update when navigating to a different year (This Year matches viewed year)"
    - "Fuzzy-date sections do not appear when weekly view is active"
    - "Reorder (K/J) respects section boundaries for all four sections"
  artifacts:
    - path: "internal/todolist/model.go"
      provides: "visibleItems with This Month and This Year sections, section-aware reordering"
      contains: "This Month"
  key_links:
    - from: "internal/todolist/model.go"
      to: "store.MonthTodos"
      via: "visibleItems query"
      pattern: "m\\.store\\.MonthTodos"
    - from: "internal/todolist/model.go"
      to: "store.YearTodos"
      via: "visibleItems query"
      pattern: "m\\.store\\.YearTodos"
---

<objective>
Add "This Month" and "This Year" sections to the todo panel for fuzzy-date todos.

Purpose: Users need to see month-level and year-level todos in dedicated sections that update when navigating the calendar. These sections appear only in monthly view, not weekly.

Output: Updated todolist with 4 sections: dated (month name or week), This Month, This Year, Floating.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-date-precision-input/27-01-SUMMARY.md
@internal/todolist/model.go
@internal/store/iface.go
@internal/store/todo.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add This Month and This Year sections to visibleItems</name>
  <files>internal/todolist/model.go</files>
  <action>
Modify the `visibleItems()` method to add two new sections between the dated/week section and the floating section:

1. **"This Month" section** (only when weekFilterStart is empty, i.e., monthly view):
   - After the dated section, add a header "This Month"
   - Query `m.store.MonthTodos(m.viewYear, m.viewMonth)` to get month-precision todos
   - If no month todos, show "(no month todos)" empty item
   - Otherwise render each todo as a todoItem

2. **"This Year" section** (only when weekFilterStart is empty):
   - After the This Month section, add a header "This Year"
   - Query `m.store.YearTodos(m.viewYear)` to get year-precision todos
   - If no year todos, show "(no year todos)" empty item
   - Otherwise render each todo as a todoItem

3. **Floating section** remains at the end, unchanged.

4. **When weekly view is active** (weekFilterStart != ""):
   - Do NOT add This Month or This Year sections. Only show the week section + Floating.
   - This satisfies VIEW-01: fuzzy todos only appear in monthly view.

5. **Fix section boundary for MoveUp/MoveDown:**
   The current boundary logic uses `curTodo.HasDate() == prevTodo.HasDate()` which is too coarse now that there are 4 sections. Instead, derive a section tag for each todoItem based on which section it belongs to. The simplest approach: add a `section` field to `visibleItem` (type int or string). Set it during visibleItems construction:
   - section 0: dated todos
   - section 1: month todos
   - section 2: year todos
   - section 3: floating todos

   Then in MoveUp/MoveDown, compare `items[curIdx].section == items[prevIdx].section` instead of `HasDate()`.

   Add a `section int` field to the `visibleItem` struct. Set it for each todoItem when building the list. headerItem and emptyItem can use any value (they are not selectable).

6. The inline filter (filterQuery) should also apply to todos in the new sections, using the same fuzzy.Match logic.
  </action>
  <verify>
Run `go build ./...` to confirm compilation.
Run `go test ./...` to confirm all existing tests pass.
Manually inspect that visibleItems builds the correct 4-section structure by reading the code.
  </verify>
  <done>
visibleItems() returns items with 4 sections in monthly view: dated header + todos, "This Month" header + month todos, "This Year" header + year todos, "Floating" header + floating todos.
In weekly view, only week + floating sections appear (no This Month or This Year).
MoveUp/MoveDown respects all 4 section boundaries.
Inline filter applies to all sections.
  </done>
</task>

</tasks>

<verification>
- `go build ./...` passes
- `go test ./...` passes
- visibleItems code shows MonthTodos and YearTodos queries with section headers
- Section boundary in MoveUp/MoveDown uses section field comparison
- Weekly view branch does not include month/year sections
</verification>

<success_criteria>
- Todo panel shows 4 sections in monthly view with correct headers
- Sections update dynamically based on viewYear and viewMonth
- Weekly view shows only week + floating (fuzzy-date exclusion)
- Reordering stays within section boundaries for all 4 sections
- All existing tests pass, app compiles
</success_criteria>

<output>
After completion, create `.planning/phases/28-display-indicators/28-01-SUMMARY.md`
</output>

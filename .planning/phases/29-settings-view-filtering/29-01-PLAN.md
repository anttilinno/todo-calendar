---
phase: 29-settings-view-filtering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/config/config.go
  - internal/settings/model.go
  - internal/todolist/model.go
  - internal/app/model.go
  - internal/calendar/grid.go
autonomous: true

must_haves:
  truths:
    - "Settings overlay has a Show Month Todos toggle (Show/Hide)"
    - "Settings overlay has a Show Year Todos toggle (Show/Hide)"
    - "Toggling settings takes effect immediately with live preview"
    - "Settings persist to config.toml after save"
    - "Hidden sections do not appear in the todo panel"
    - "Calendar circle indicators are hidden when corresponding section is hidden"
  artifacts:
    - path: "internal/config/config.go"
      provides: "ShowMonthTodos and ShowYearTodos bool fields with true defaults"
      contains: "ShowMonthTodos"
    - path: "internal/settings/model.go"
      provides: "Two boolean toggle options in settings overlay"
      contains: "Show Month Todos"
    - path: "internal/todolist/model.go"
      provides: "Section visibility gating in visibleItems()"
      contains: "showMonthTodos"
    - path: "internal/app/model.go"
      provides: "Wiring of visibility settings to todolist on init and save"
      contains: "SetShowFuzzySections"
    - path: "internal/calendar/grid.go"
      provides: "Circle indicator gating based on visibility config"
      contains: "showMonthTodos"
  key_links:
    - from: "internal/settings/model.go"
      to: "internal/config/config.go"
      via: "Config() reads toggle values and sets bool fields"
      pattern: "ShowMonthTodos.*==.*true"
    - from: "internal/app/model.go"
      to: "internal/todolist/model.go"
      via: "SaveMsg handler calls SetShowFuzzySections"
      pattern: "SetShowFuzzySections"
    - from: "internal/app/model.go"
      to: "internal/calendar/grid.go"
      via: "Config bools propagated to calendar via RefreshIndicators or direct field"
      pattern: "showMonthTodos|ShowMonthTodos"
---

<objective>
Add show/hide toggles for month-level and year-level todo sections to the settings overlay, with live preview and persistence.

Purpose: Complete v1.9 milestone by giving users control over fuzzy-date section visibility (SET-01, SET-02, SET-03).
Output: Settings overlay with 6 options (4 existing + 2 new toggles), config persistence, gated sections in todolist and calendar.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@internal/config/config.go
@internal/settings/model.go
@internal/todolist/model.go
@internal/app/model.go
@internal/calendar/grid.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add visibility config fields and settings toggles</name>
  <files>internal/config/config.go, internal/settings/model.go</files>
  <action>
**config.go:**
1. Add two bool fields to the Config struct:
   - `ShowMonthTodos bool` with TOML tag `toml:"show_month_todos"`
   - `ShowYearTodos bool` with TOML tag `toml:"show_year_todos"`
2. In `DefaultConfig()`, set both to `true` (sections visible by default).

**settings/model.go:**
3. In `New()`, add two new options after the DateFormat option (indices 4 and 5):
   - Option at index 4: label "Show Month Todos", values `["true", "false"]`, display `["Show", "Hide"]`, index from `boolIndex(cfg.ShowMonthTodos)`
   - Option at index 5: label "Show Year Todos", values `["true", "false"]`, display `["Show", "Hide"]`, index from `boolIndex(cfg.ShowYearTodos)`
4. Add helper function `boolIndex(b bool) int` that returns 0 for true, 1 for false.
5. Update `Config()` method to include the new fields:
   - `ShowMonthTodos: m.options[4].values[m.options[4].index] == "true"`
   - `ShowYearTodos: m.options[5].values[m.options[5].index] == "true"`
6. Update the cursor bounds comment from `0-3` to `0-5` (6 options total).
  </action>
  <verify>
`go build ./...` compiles successfully. Manually verify in settings/model.go that New() creates 6 options and Config() maps all 6 back to config fields.
  </verify>
  <done>Config struct has ShowMonthTodos/ShowYearTodos bool fields defaulting to true. Settings overlay renders 6 option rows with Show/Hide cycling for the two new toggles.</done>
</task>

<task type="auto">
  <name>Task 2: Gate sections in todolist and calendar, wire from app</name>
  <files>internal/todolist/model.go, internal/app/model.go, internal/calendar/grid.go</files>
  <action>
**todolist/model.go:**
1. Add two fields to Model struct: `showMonthTodos bool` and `showYearTodos bool`.
2. In `New()`, initialize both to `true`.
3. Add a setter method:
   ```go
   func (m *Model) SetShowFuzzySections(showMonth, showYear bool) {
       m.showMonthTodos = showMonth
       m.showYearTodos = showYear
   }
   ```
4. In `visibleItems()`, inside the `if m.weekFilterStart == ""` block:
   - Wrap the "This Month" section (lines ~317-325) in `if m.showMonthTodos { ... }`
   - Wrap the "This Year" section (lines ~328-336) in `if m.showYearTodos { ... }`

**app/model.go:**
5. In `New()` (the app constructor), after creating the todolist, call:
   `tl.SetShowFuzzySections(cfg.ShowMonthTodos, cfg.ShowYearTodos)`
6. In the `settings.SaveMsg` handler, after the existing `m.todoList.SetDateFormat(...)` call, add:
   `m.todoList.SetShowFuzzySections(msg.Cfg.ShowMonthTodos, msg.Cfg.ShowYearTodos)`

**calendar/grid.go:**
7. In `RenderGrid`, the function already receives a `store.TodoStore` parameter and calls `store.MonthTodos` and `store.YearTodos` for circle indicators. Add two bool parameters to `RenderGrid`: `showMonthTodos bool` and `showYearTodos bool`. Gate the month circle indicator rendering on `showMonthTodos` and the year circle indicator rendering on `showYearTodos`. When false, skip fetching todos and rendering the circle for that type.
8. Update the `RenderGrid` call site in `internal/calendar/model.go` View() to pass the new parameters. The calendar model needs these bools â€” add `showMonthTodos` and `showYearTodos` fields to the calendar Model, a `SetShowFuzzySections(showMonth, showYear bool)` setter, and pass them to RenderGrid.
9. In `internal/app/model.go` New(), call `cal.SetShowFuzzySections(cfg.ShowMonthTodos, cfg.ShowYearTodos)`.
10. In the `settings.SaveMsg` handler, call `m.calendar.SetShowFuzzySections(msg.Cfg.ShowMonthTodos, msg.Cfg.ShowYearTodos)` before `m.calendar.RefreshIndicators()`.

NOTE: The additional file `internal/calendar/model.go` will also be modified (adding fields + setter + updated View call), though the primary logic change is in grid.go.
  </action>
  <verify>
`go build ./...` compiles successfully. `go test ./...` passes. Review that visibleItems() skips month/year sections when bools are false, and RenderGrid skips circle indicators when bools are false.
  </verify>
  <done>
- Setting Show Month Todos to Hide removes the "This Month" section from the todo panel and hides the left circle indicator on the calendar
- Setting Show Year Todos to Hide removes the "This Year" section from the todo panel and hides the right circle indicator on the calendar
- Changes take effect immediately (live preview) because the settings SaveMsg handler calls the setters before returning
- Settings persist because config.Save writes ShowMonthTodos/ShowYearTodos to config.toml
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` compiles without errors
2. `go test ./...` passes all tests
3. Settings overlay shows 6 options: Theme, Country, First Day of Week, Date Format, Show Month Todos, Show Year Todos
4. New toggles cycle between "Show" and "Hide" with left/right arrows
5. When "Show Month Todos" is set to Hide: "This Month" section absent from todo panel, left circle absent from calendar title
6. When "Show Year Todos" is set to Hide: "This Year" section absent from todo panel, right circle absent from calendar title
7. Save persists both settings to config.toml (fields: show_month_todos, show_year_todos)
8. Cancel reverts toggle changes (existing settings cancel behavior)
</verification>

<success_criteria>
- SET-01: Setting to show/hide month-level todo section -- SATISFIED by Show Month Todos toggle
- SET-02: Setting to show/hide year-level todo section -- SATISFIED by Show Year Todos toggle
- SET-03: Settings accessible in existing overlay with live preview -- SATISFIED by adding toggles to existing settings overlay with immediate effect on save
- All 3 success criteria from ROADMAP Phase 29 are met
</success_criteria>

<output>
After completion, create `.planning/phases/29-settings-view-filtering/29-01-SUMMARY.md`
</output>

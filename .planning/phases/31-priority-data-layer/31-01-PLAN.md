---
phase: 31-priority-data-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/store/todo.go
  - internal/store/iface.go
  - internal/store/sqlite.go
  - internal/store/sqlite_test.go
  - internal/todolist/model.go
  - internal/recurring/generate_test.go
autonomous: true

must_haves:
  truths:
    - "SQLite schema is at version 7 with a priority INTEGER column"
    - "Existing todos have priority 0 (no priority) after migration"
    - "Store Add() and Update() accept priority and persist it correctly"
    - "Store queries return todos with their priority value populated"
    - "All tests pass including new priority roundtrip tests"
  artifacts:
    - path: "internal/store/todo.go"
      provides: "Priority field on Todo struct plus HasPriority() and PriorityLabel() helpers"
      contains: "Priority"
    - path: "internal/store/iface.go"
      provides: "Extended Add and Update signatures with priority int parameter"
      contains: "priority int"
    - path: "internal/store/sqlite.go"
      provides: "Migration v7, updated todoColumns/scanTodo/Add/Update/AddScheduledTodo"
      contains: "version < 7"
    - path: "internal/store/sqlite_test.go"
      provides: "Priority roundtrip and helper tests"
      contains: "TestPriorityRoundtrip"
  key_links:
    - from: "internal/store/iface.go"
      to: "internal/store/sqlite.go"
      via: "SQLiteStore implements TodoStore with new priority parameter"
      pattern: "func \\(s \\*SQLiteStore\\) Add\\(.*priority int\\)"
    - from: "internal/store/sqlite.go"
      to: "internal/store/todo.go"
      via: "scanTodo populates Priority field from DB column"
      pattern: "&t\\.Priority"
    - from: "internal/todolist/model.go"
      to: "internal/store/iface.go"
      via: "saveAdd and saveEdit call Add/Update with priority 0"
      pattern: "\\.(Add|Update)\\(.*0\\)"
    - from: "internal/recurring/generate_test.go"
      to: "internal/store/iface.go"
      via: "fakeStore stubs match updated interface signatures"
      pattern: "func \\(f \\*fakeStore\\) Add\\(.*priority int\\)"
---

<objective>
Add priority data layer: schema migration v7, Todo struct extension, store interface updates, and all caller updates so that priority (0=none, 1-4) persists through the full store roundtrip.

Purpose: Foundation for Phase 32 (Priority UI). Without the data layer, priority has nowhere to be stored or read from.
Output: Working priority field across the entire store layer with passing tests.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-priority-data-layer/31-RESEARCH.md
@internal/store/todo.go
@internal/store/iface.go
@internal/store/sqlite.go
@internal/store/sqlite_test.go
@internal/todolist/model.go
@internal/recurring/generate_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema migration v7, struct extension, and store implementation</name>
  <files>
    internal/store/todo.go
    internal/store/iface.go
    internal/store/sqlite.go
    internal/todolist/model.go
    internal/recurring/generate_test.go
  </files>
  <action>
    This is an atomic change -- the interface signature change breaks all callers, so all files must be updated together. Follow the exact v6 (date_precision) migration precedent.

    1. **internal/store/todo.go** -- Add Priority field and helpers:
       - Add `Priority int \`json:"priority"\`` field to Todo struct after DatePrecision
       - Add `HasPriority() bool` method: returns `t.Priority >= 1 && t.Priority <= 4`
       - Add `PriorityLabel() string` method: returns `fmt.Sprintf("P%d", t.Priority)` for 1-4, `""` otherwise
       - Import "fmt" (needed for Sprintf in PriorityLabel)

    2. **internal/store/iface.go** -- Extend interface signatures:
       - `Add(text string, date string, datePrecision string, priority int) Todo`
       - `Update(id int, text string, date string, datePrecision string, priority int)`
       - No other methods change. AddScheduledTodo signature stays the same.

    3. **internal/store/sqlite.go** -- Migration + column plumbing:
       - Add migration v7 block after the `version < 6` block:
         ```
         if version < 7 {
             ALTER TABLE todos ADD COLUMN priority INTEGER NOT NULL DEFAULT 0
             PRAGMA user_version = 7
         }
         ```
         No post-migration fixup needed (DEFAULT 0 = no priority is correct for all existing rows).
       - Update `todoColumns`: append `, priority` to the end of the string
       - Update `scanTodo`: add `&t.Priority` as the last Scan argument
       - Update `Add()`: add `priority int` parameter, include `priority` in INSERT column list and VALUES, set `Priority: priority` in returned Todo struct
       - Update `Update()`: add `priority int` parameter, include `priority = ?` in UPDATE SET clause with the priority value
       - Update `AddScheduledTodo()`: include `priority` in the INSERT column list with value `0`, set `Priority: 0` in returned Todo struct. Do NOT change the method signature.

    4. **internal/todolist/model.go** -- Update callers to pass 0:
       - Line ~868 `saveAdd()`: change `m.store.Add(text, isoDate, precision)` to `m.store.Add(text, isoDate, precision, 0)`
       - Line ~831 `saveEdit()`: change `m.store.Update(m.editingID, text, isoDate, precision)` to `m.store.Update(m.editingID, text, isoDate, precision, 0)`
       - The `0` is a placeholder; Phase 32 will wire actual priority from the edit form.

    5. **internal/recurring/generate_test.go** -- Update fakeStore stubs:
       - Line 48: change `func (f *fakeStore) Add(text, date, datePrecision string) store.Todo` to `func (f *fakeStore) Add(text, date, datePrecision string, priority int) store.Todo`
       - Line 52: change `func (f *fakeStore) Update(id int, text, date, datePrecision string)` to `func (f *fakeStore) Update(id int, text, date, datePrecision string, priority int)`

    After all changes, verify the code compiles: `go build ./...`
  </action>
  <verify>
    Run `go build ./...` from project root -- must compile with zero errors.
    Run `go vet ./...` -- must pass with no issues.
  </verify>
  <done>
    All 5 files updated. The project compiles. The interface change is propagated to all callers. Migration v7 block exists. todoColumns and scanTodo include priority.
  </done>
</task>

<task type="auto">
  <name>Task 2: Priority roundtrip and helper tests</name>
  <files>
    internal/store/sqlite_test.go
  </files>
  <action>
    Add three test functions to sqlite_test.go. These verify the full priority data roundtrip and the struct helper methods.

    1. **TestPriorityRoundtrip** -- Tests Add, Find, Update, and Todos with priority values:
       - Create store with TempDir
       - `s.Add("Urgent task", "2026-03-15", "day", 1)` -- verify returned Todo has Priority=1
       - `s.Find(todo.ID)` -- verify Priority=1 survives DB roundtrip
       - `s.Update(todo.ID, "Urgent task", "2026-03-15", "day", 3)` -- then Find and verify Priority=3
       - `s.Todos()` -- find the todo in the list and verify Priority=3

    2. **TestPriorityDefaultZero** -- Tests that priority 0 works correctly:
       - `s.Add("Normal task", "2026-03-15", "day", 0)` -- verify Priority=0
       - Find and verify Priority=0

    3. **TestPriorityHelpers** -- Table-driven test for HasPriority() and PriorityLabel():
       - Priority 0 -> HasPriority()=false, PriorityLabel()=""
       - Priority 1 -> HasPriority()=true, PriorityLabel()="P1"
       - Priority 2 -> HasPriority()=true, PriorityLabel()="P2"
       - Priority 3 -> HasPriority()=true, PriorityLabel()="P3"
       - Priority 4 -> HasPriority()=true, PriorityLabel()="P4"
       - Priority -1 -> HasPriority()=false, PriorityLabel()=""
       - Priority 5 -> HasPriority()=false, PriorityLabel()=""

    Also update ALL existing test calls to Add() and Update() in sqlite_test.go to pass the new priority parameter. Specifically:
    - Every `s.Add("...", "...", "...")` becomes `s.Add("...", "...", "...", 0)`
    - These appear in: TestDatePrecision, TestMonthTodosQuery, TestYearTodosQuery, TestDayQueriesExcludeFuzzy

    Run the full test suite to confirm everything passes.
  </action>
  <verify>
    Run `go test ./internal/store/ -v -run TestPriority` -- all 3 new tests pass.
    Run `go test ./...` -- entire test suite passes (no regressions from signature changes).
  </verify>
  <done>
    3 new test functions exist in sqlite_test.go. All existing tests updated for new Add/Update signatures. Full test suite passes with `go test ./...` showing 0 failures. Priority roundtrip (Add -> Find -> Update -> Todos) verified. Helper methods (HasPriority, PriorityLabel) verified for all edge cases (0, 1-4, -1, 5).
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` compiles cleanly (interface change propagated to all callers)
2. `go test ./...` passes with 0 failures (all existing + new tests)
3. `go vet ./...` reports no issues
4. Grep confirms migration v7: `grep "version < 7" internal/store/sqlite.go`
5. Grep confirms priority in todoColumns: `grep "priority" internal/store/sqlite.go`
6. Grep confirms struct field: `grep "Priority" internal/store/todo.go`
7. Grep confirms callers pass 0: `grep "priority.*0" internal/todolist/model.go` (placeholder until Phase 32)
</verification>

<success_criteria>
- SQLite schema version is 7 with `priority INTEGER NOT NULL DEFAULT 0` column
- Todo struct has Priority int field with HasPriority() and PriorityLabel() helpers
- TodoStore interface Add() and Update() accept priority int parameter
- SQLiteStore Add/Update/AddScheduledTodo persist priority correctly
- All callers (todolist model, recurring fakeStore) updated for new signatures
- All tests pass including 3 new priority-specific tests
- No regressions in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/31-priority-data-layer/31-01-SUMMARY.md`
</output>

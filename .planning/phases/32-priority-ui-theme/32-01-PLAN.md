---
phase: 32-priority-ui-theme
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/theme/theme.go
  - internal/store/iface.go
  - internal/store/sqlite.go
  - internal/store/sqlite_test.go
  - internal/todolist/styles.go
  - internal/todolist/model.go
  - internal/recurring/generate_test.go
autonomous: true

must_haves:
  truths:
    - "User can set priority (P1-P4 or none) on any todo via the edit/add form"
    - "Todos display a colored [P1]-[P4] badge prefix with aligned text"
    - "Completed prioritized todos show colored badge but greyed-out strikethrough text"
    - "Priority badge uses fixed-width 5-char slot for consistent column alignment"
  artifacts:
    - path: "internal/theme/theme.go"
      provides: "PriorityP1Fg through PriorityP4Fg color fields on Theme struct, defined for all 4 themes"
      contains: "PriorityP1Fg"
    - path: "internal/store/iface.go"
      provides: "HighestPriorityPerDay method on TodoStore interface"
      contains: "HighestPriorityPerDay"
    - path: "internal/store/sqlite.go"
      provides: "HighestPriorityPerDay SQL implementation with GROUP BY"
      contains: "HighestPriorityPerDay"
    - path: "internal/todolist/styles.go"
      provides: "Priority badge styles (PriorityP1 through PriorityP4)"
      contains: "PriorityP1"
    - path: "internal/todolist/model.go"
      provides: "editPriority field, priority selector in edit form, badge rendering in normalView"
      contains: "editPriority"
  key_links:
    - from: "internal/todolist/model.go"
      to: "internal/store/iface.go"
      via: "saveAdd/saveEdit pass m.editPriority instead of 0"
      pattern: "m\\.editPriority"
    - from: "internal/todolist/model.go"
      to: "internal/todolist/styles.go"
      via: "renderTodo uses priorityBadgeStyle for badge coloring"
      pattern: "priorityBadgeStyle"
    - from: "internal/todolist/styles.go"
      to: "internal/theme/theme.go"
      via: "NewStyles reads PriorityP*Fg for badge styles"
      pattern: "PriorityP[1-4]Fg"
---

<objective>
Add priority theme colors, store query, and wire the complete priority UX in the todolist package: edit form field for setting priority, badge rendering in the todo list, and priority-aware save.

Purpose: This is the core priority experience -- users can set, see, and distinguish priority levels on todos. PRIO-01, PRIO-02, PRIO-03, PRIO-04, PRIO-05 (partial -- todolist styles only).
Output: Theme with priority colors, store HighestPriorityPerDay method, todolist with priority edit field and badge rendering.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-priority-ui-theme/32-RESEARCH.md
@.planning/phases/31-priority-data-layer/31-01-SUMMARY.md
@internal/theme/theme.go
@internal/store/iface.go
@internal/store/sqlite.go
@internal/store/todo.go
@internal/todolist/styles.go
@internal/todolist/model.go
@internal/recurring/generate_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Theme priority colors, store HighestPriorityPerDay, and todolist priority styles</name>
  <files>internal/theme/theme.go, internal/store/iface.go, internal/store/sqlite.go, internal/store/sqlite_test.go, internal/todolist/styles.go, internal/recurring/generate_test.go</files>
  <action>
1. **internal/theme/theme.go** -- Add 4 new fields to the Theme struct:
   ```
   PriorityP1Fg lipgloss.Color // P1 (urgent/critical) -- red family
   PriorityP2Fg lipgloss.Color // P2 (high) -- orange family
   PriorityP3Fg lipgloss.Color // P3 (medium) -- blue family
   PriorityP4Fg lipgloss.Color // P4 (low) -- grey/muted family
   ```
   Add these to all 4 theme functions with these exact hex values:
   - Dark(): `#FF5F5F`, `#FFAF5F`, `#5F87FF`, `#808080`
   - Light(): `#D70000`, `#AF5F00`, `#005FAF`, `#8A8A8A`
   - Nord(): `#BF616A`, `#D08770`, `#5E81AC`, `#4C566A`
   - Solarized(): `#DC322F`, `#CB4B16`, `#268BD2`, `#586E75`

2. **internal/store/iface.go** -- Add method to TodoStore interface:
   ```
   HighestPriorityPerDay(year int, month time.Month) map[int]int
   ```
   This returns day->priority mapping for days that have at least one incomplete prioritized todo.

3. **internal/store/sqlite.go** -- Implement HighestPriorityPerDay using a single GROUP BY query:
   ```sql
   SELECT CAST(substr(date, 9, 2) AS INTEGER) AS day,
          MIN(priority) AS highest
   FROM todos
   WHERE done = 0
     AND date >= ? AND date <= ?
     AND date_precision = 'day'
     AND priority BETWEEN 1 AND 4
   GROUP BY day
   ```
   Use the same start/end date calculation pattern as IncompleteTodosPerDay. Return map[int]int (day -> priority). Return nil on error.

4. **internal/store/sqlite_test.go** -- Add test `TestHighestPriorityPerDay`:
   - Add todos with different priorities on the same day
   - Verify the highest (lowest number) priority wins per day
   - Verify completed prioritized todos are excluded
   - Verify non-prioritized todos (priority 0) are excluded
   - Verify empty result for month with no prioritized incomplete todos

5. **internal/todolist/styles.go** -- Add priority badge styles to the Styles struct:
   ```
   PriorityP1 lipgloss.Style
   PriorityP2 lipgloss.Style
   PriorityP3 lipgloss.Style
   PriorityP4 lipgloss.Style
   ```
   In NewStyles, initialize each as `lipgloss.NewStyle().Bold(true).Foreground(t.PriorityP*Fg)`.
   Also add a helper method `func (s Styles) priorityBadgeStyle(level int) lipgloss.Style` that returns the appropriate style for priority 1-4 (switch statement, default returns PriorityP4).

6. **internal/recurring/generate_test.go** -- Add stub method to fakeStore:
   ```
   func (f *fakeStore) HighestPriorityPerDay(y int, m time.Month) map[int]int { return nil }
   ```
  </action>
  <verify>
Run `go vet ./...` -- must pass with no errors.
Run `go test ./internal/store/...` -- all tests including new TestHighestPriorityPerDay must pass.
Run `go test ./internal/recurring/...` -- all tests must pass (fakeStore satisfies interface).
  </verify>
  <done>Theme struct has PriorityP*Fg fields defined for all 4 themes. TodoStore interface includes HighestPriorityPerDay. SQLite implementation queries correctly with GROUP BY. Test confirms highest priority wins per day. Todolist Styles struct has PriorityP1-P4 styles with priorityBadgeStyle helper. fakeStore in recurring tests compiles.</done>
</task>

<task type="auto">
  <name>Task 2: Priority edit field and badge rendering in todolist</name>
  <files>internal/todolist/model.go</files>
  <action>
This task modifies internal/todolist/model.go to wire the priority field into the edit form and render priority badges in the todo list.

**A. Named field constants (Pitfall 5 prevention):**
Define constants at the top of the file to replace magic editField numbers:
```go
const (
    fieldTitle    = 0
    fieldDate     = 1
    fieldPriority = 2
    fieldBody     = 3
    fieldTemplate = 4 // inputMode only
)
```
Replace ALL existing editField numeric comparisons (==, case) with these named constants throughout the file. This is critical -- there are many hardcoded checks for `m.editField == 2` (body) and `m.editField == 3` (template) that must shift.

**B. Model field addition:**
Add `editPriority int` to the Model struct (between editField and templateInput). This holds 0-4 during editing.

**C. Edit form field cycling -- editMode (3 fields -> 4 fields):**
Update updateEditMode SwitchField (Tab) handling:
- title(0) -> date(1): unchanged
- date(1) last segment -> priority(2): `m.editField = fieldPriority; m.blurAllDateSegments()` (no Focus cmd needed, priority is not a textinput)
- priority(2) -> body(3): `m.editField = fieldBody; return m, m.bodyTextarea.Focus()`
- body(3) -> title(0): unchanged logic, now uses fieldTitle constant

Update Confirm (Enter) handling: body field check changes from `== 2` to `== fieldBody`.
Update Cancel (Esc) handling: body field Esc-goes-back check changes from `== 2` to `== fieldBody`.
When `editField == fieldPriority`, Enter should save (same as title/date).

**D. Edit form field cycling -- inputMode (4 fields -> 5 fields):**
Update updateInputMode SwitchField (Tab) handling:
- title(0) -> date(1): unchanged
- date(1) last segment -> priority(2): blur date segments, set fieldPriority
- priority(2) -> body(3): set fieldBody, Focus bodyTextarea
- body(3) -> template(4): set fieldTemplate, blur bodyTextarea, Focus templateInput
- template(4) -> title(0): set fieldTitle, blur templateInput, Focus input

Update Confirm (Enter) handling: body check from `== 2` to `== fieldBody`, template check from `== 3` to `== fieldTemplate`.
Update Cancel (Esc) handling: `m.editField == 2 || m.editField == 3` changes to `m.editField == fieldBody || m.editField == fieldTemplate`.

**E. Priority field key handling:**
When editField == fieldPriority in updateEditMode/updateInputMode, handle:
- Left arrow: `m.editPriority = max(0, m.editPriority-1)`
- Right arrow: `m.editPriority = min(4, m.editPriority+1)`
- Other keys forwarded nowhere (priority is not a textinput)

Add this BEFORE the existing "Forward key events to the focused field" switch in both updateEditMode and updateInputMode. In the forward switch, add `case fieldPriority: // no-op, handled above`.

**F. Blink/tick forwarding (Update method):**
The non-key message forwarding switch at the top of Update() currently has cases for editField 2 (body) and 3 (template). Update to use fieldBody and fieldTemplate constants. Add `case fieldPriority: // no-op, no widget to forward to`.

**G. HelpBindings editField checks:**
Update HelpBindings() and AllHelpBindings() -- replace `m.editField == 2` and `m.editField == 3` with named constants. In editMode, the body field is now fieldBody (3), not 2. In inputMode, body is fieldBody (3) and template is fieldTemplate (4).

**H. Edit mode entry (normalMode -> editMode):**
In updateNormalMode, case Edit: after setting `m.editField = 0`, also set `m.editPriority = fresh.Priority` to load the existing todo's priority. This prevents Pitfall 2 (saveEdit resetting priority to 0).

**I. Add mode entry (normalMode -> inputMode):**
In updateNormalMode, case Add: also reset `m.editPriority = 0` (new todos default to no priority).

**J. Save functions:**
- `saveAdd()`: Change `m.store.Add(text, isoDate, precision, 0)` to `m.store.Add(text, isoDate, precision, m.editPriority)`. Also reset `m.editPriority = 0` at the end alongside other field resets.
- `saveEdit()`: Change `m.store.Update(m.editingID, text, isoDate, precision, 0)` to `m.store.Update(m.editingID, text, isoDate, precision, m.editPriority)`. Also reset `m.editPriority = 0` at the end.

**K. editView() rendering -- priority field in form:**
Add a `renderPrioritySelector()` method:
```go
func (m Model) renderPrioritySelector() string {
    options := []string{"none", "P1", "P2", "P3", "P4"}
    var parts []string
    for i, opt := range options {
        if i == m.editPriority {
            parts = append(parts, m.styles.Cursor.Render("["+opt+"]"))
        } else {
            parts = append(parts, " "+opt+" ")
        }
    }
    return strings.Join(parts, " ")
}
```

In editView():
- editMode section: after the Date field block and before the Body field block, add:
  ```
  b.WriteString(m.styles.FieldLabel.Render("Priority"))
  b.WriteString("\n")
  b.WriteString(m.renderPrioritySelector())
  b.WriteString("\n\n")
  ```
- inputMode normal form section: add the same Priority field between Date and Body blocks.

**L. renderTodo() -- priority badge in normal view (PRIO-02, PRIO-03, PRIO-04):**
In renderTodo(), BETWEEN the cursor indicator and the checkbox, add the priority badge:
```go
// Priority badge -- fixed-width 5-char slot (PRIO-04)
if t.HasPriority() {
    label := fmt.Sprintf("[%s]", t.PriorityLabel())
    style := m.styles.priorityBadgeStyle(t.Priority)
    b.WriteString(style.Render(label))
    b.WriteString(" ")
} else {
    b.WriteString("     ") // 5 spaces to match "[P1] " width
}
```
The badge always comes before the checkbox. For completed todos (PRIO-03), the badge keeps its priority color (the style comes from priorityBadgeStyle, not from Completed style). The text after the checkbox is already styled with m.styles.Completed when t.Done is true, so no additional changes needed for PRIO-03.

**M. Add a min() helper** (if not already present) alongside the existing max() at the bottom of the file:
```go
func min(a, b int) int {
    if a < b {
        return a
    }
    return b
}
```
  </action>
  <verify>
Run `go vet ./...` -- must pass with no errors.
Run `go test ./...` -- all tests must pass.
Verify manually: search for any remaining hardcoded editField numbers (grep for `editField == [0-9]` or `case [0-9]:` in the editField switch blocks) to ensure all were converted to named constants.
  </verify>
  <done>
Priority field appears in both add and edit forms between Date and Body. Left/right arrows cycle through none/P1/P2/P3/P4. Edit mode loads existing todo's priority. Save passes editPriority to store. Todo list renders colored [P1]-[P4] badge prefix with fixed 5-char slot. Completed todos show colored badge with grey strikethrough text. All editField references use named constants.
  </done>
</task>

</tasks>

<verification>
- `go vet ./...` passes
- `go test ./...` passes with all existing and new tests
- Grep confirms no remaining hardcoded editField number comparisons in todolist/model.go
- Theme struct has 4 new PriorityP*Fg fields across all 4 themes
- TodoStore interface has HighestPriorityPerDay method
- Todolist renders [P1]-[P4] badges with fixed-width alignment
- Edit/add forms have priority selector field
- saveAdd and saveEdit pass editPriority to store (not hardcoded 0)
</verification>

<success_criteria>
1. `go vet ./...` and `go test ./...` pass cleanly
2. Priority colors defined for all 4 themes (Dark, Light, Nord, Solarized)
3. HighestPriorityPerDay store method implemented and tested
4. Todo list shows colored priority badges with consistent 5-char column alignment
5. Edit form has priority selector (none/P1/P2/P3/P4 with left/right navigation)
6. Add form has priority selector defaulting to none
7. Editing a prioritized todo preserves its priority (not reset to 0)
8. Completed prioritized todos show colored badge with grey strikethrough text
</success_criteria>

<output>
After completion, create `.planning/phases/32-priority-ui-theme/32-01-SUMMARY.md`
</output>

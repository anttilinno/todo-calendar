---
phase: 33-oauth-offline-guard
plan: 02
type: execute
wave: 2
depends_on: ["33-01"]
files_modified:
  - internal/settings/model.go
  - internal/app/model.go
  - main.go
autonomous: false

must_haves:
  truths:
    - "Settings overlay shows Google Calendar row with status (Not configured / Sign in / Connected)"
    - "Pressing Enter on Google Calendar row when status is Sign in or Reconnect triggers OAuth flow"
    - "Auth flow result updates settings status to Connected on success"
    - "App launches normally when credentials.json is absent (no errors, no prompts)"
    - "App model passes AuthResultMsg to settings and updates Google auth state"
  artifacts:
    - path: "internal/settings/model.go"
      provides: "Google Calendar option row with auth state display and Enter trigger"
      contains: "Google Calendar"
    - path: "internal/app/model.go"
      provides: "AuthResultMsg handling, google auth state tracking"
      contains: "AuthResultMsg"
    - path: "main.go"
      provides: "Google auth state checked at startup and passed to app.New"
  key_links:
    - from: "internal/settings/model.go"
      to: "internal/google/auth.go"
      via: "google.AuthState, google.StartAuthFlow"
      pattern: "google\\."
    - from: "internal/app/model.go"
      to: "internal/google/auth.go"
      via: "google.AuthResultMsg handling"
      pattern: "google\\.AuthResultMsg"
    - from: "main.go"
      to: "internal/google/auth.go"
      via: "google.CheckAuthState at startup"
      pattern: "google\\.CheckAuthState"
---

<objective>
Wire Google OAuth into the existing TUI: add a "Google Calendar" row to the settings overlay showing auth status, trigger the OAuth flow from settings via Enter key, handle AuthResultMsg in the app model, and check auth state at startup. The app must launch fully functional when Google is not configured.

Purpose: Fulfills CONF-02 (setup triggered from settings) and AUTH-04 (graceful offline guard). Connects the auth package from Plan 01 into the live application.
Output: Modified settings overlay, app model, and main.go.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-oauth-offline-guard/33-RESEARCH.md
@.planning/phases/33-oauth-offline-guard/33-01-SUMMARY.md
@internal/settings/model.go
@internal/app/model.go
@main.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Google Calendar row to settings and wire auth into app</name>
  <files>internal/settings/model.go, internal/app/model.go, main.go</files>
  <action>
**settings/model.go changes:**

1. Import `"github.com/antti/todo-calendar/internal/google"` and `tea "github.com/charmbracelet/bubbletea"`.

2. Add `googleAuthState google.AuthState` field to `Model` struct. Add `authFlowActive bool` field.

3. Add new message type `StartGoogleAuthMsg struct{}` — emitted when user presses Enter on Google Calendar row and status is "Sign in" or "Reconnect".

4. Add new message type `GoogleAuthDoneMsg struct{ State google.AuthState }` — emitted after auth flow completes, so settings can update its display.

5. In `New()`, accept a `google.AuthState` parameter. Add a 7th option row:
   ```
   {label: "Google Calendar", values: googleStatusValues, display: googleStatusDisplay, index: stateIndex}
   ```
   where display depends on auth state:
   - `AuthNotConfigured`: display "Not configured" (non-interactive, dimmed)
   - `AuthNeedsLogin`: display "Sign in" (interactive)
   - `AuthReady`: display "Connected" (non-interactive)
   - `AuthRevoked`: display "Reconnect" (interactive)

   The Google Calendar row does NOT use left/right cycling. It is a special action row.

6. In `Update()`, add Enter key handling: when cursor is on the Google Calendar row (index 6) and state is `AuthNeedsLogin` or `AuthRevoked`, and `!m.authFlowActive`, emit `StartGoogleAuthMsg{}` and set `m.authFlowActive = true`.

7. In `View()`, render the Google Calendar row differently: no `< >` arrows, just the status text. When `authFlowActive`, show "Waiting for browser..." instead of the status.

8. Add `SetGoogleAuthState(state google.AuthState)` method that updates the stored state and display text, and sets `authFlowActive = false`.

9. Update `Config()` — no change needed since Google Calendar row is not a config value (it's an action row).

10. Left/Right key handling should be no-op when cursor is on Google Calendar row (index 6).

**app/model.go changes:**

1. Import `"github.com/antti/todo-calendar/internal/google"`.

2. Add `googleAuthState google.AuthState` field to `Model` struct.

3. Modify `New()` to accept `google.AuthState` parameter. Store it. Pass to settings when creating settings model.

4. Handle `google.AuthResultMsg` in the top-level message switch (alongside `settings.SettingChangedMsg`):
   - On success: set `m.googleAuthState = google.AuthReady`, update settings via `m.settings.SetGoogleAuthState(google.AuthReady)`.
   - On error: set state to `google.AuthRevoked` (or back to NeedsLogin), update settings.

5. Handle `settings.StartGoogleAuthMsg` in `updateSettings`:
   - Return `google.StartAuthFlow()` as the tea.Cmd. This launches the OAuth flow in a goroutine.

6. When creating settings model (on `s` key press), pass `m.googleAuthState` to `settings.New()`.

**main.go changes:**

1. Import `"github.com/antti/todo-calendar/internal/google"`.

2. After `recurring.AutoCreate(s)`, call `authState := google.CheckAuthState()`.

3. Pass `authState` to `app.New(provider, cfg.MondayStart(), s, t, cfg, authState)`.

This is a non-blocking call that just checks file existence. No network, no delay.
  </action>
  <verify>
`cd /home/antti/Repos/Misc/todo-calendar && go build ./...` compiles without errors. `go vet ./...` passes.
  </verify>
  <done>
Settings overlay shows "Google Calendar" row with status based on auth state. Enter triggers auth flow when applicable. App launches cleanly with no credentials (shows "Not configured"). AuthResultMsg updates settings status.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify OAuth flow end-to-end</name>
  <what-built>Complete OAuth flow: Google Calendar row in settings, browser-based auth, token persistence, graceful offline guard</what-built>
  <how-to-verify>
    1. Launch app without credentials.json: `cd /home/antti/Repos/Misc/todo-calendar && go run .`
       - Expected: App launches normally. Press `s` for settings. "Google Calendar" row shows "Not configured". Left/Right arrows do nothing on this row. Esc closes settings.

    2. (If you have a GCP project) Place credentials.json at `~/.config/todo-calendar/credentials.json`, restart app.
       - Expected: Settings shows "Sign in" for Google Calendar.
       - Press Enter on Google Calendar row.
       - Expected: Browser opens to Google consent page. Settings shows "Waiting for browser...".
       - Complete sign-in in browser.
       - Expected: Settings updates to "Connected". Token file exists at `~/.config/todo-calendar/google-token.json` with 0600 permissions.

    3. Restart app after successful auth.
       - Expected: Settings shows "Connected" immediately (token loaded from disk).
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- `go build ./...` compiles entire project
- `go test ./...` all tests pass
- `go vet ./...` no warnings
- App launches without credentials.json (AUTH-04 graceful offline)
- Settings shows Google Calendar status row (CONF-02)
- OAuth flow works end-to-end when credentials provided (AUTH-01, AUTH-02, AUTH-03)
</verification>

<success_criteria>
- Settings overlay has Google Calendar row with dynamic status
- OAuth flow triggered from settings via Enter key
- Auth result updates settings display
- Token persisted and reused across restarts
- App works fully when Google not configured
- All requirements met: AUTH-01, AUTH-02, AUTH-03, AUTH-04, CONF-02
</success_criteria>

<output>
After completion, create `.planning/phases/33-oauth-offline-guard/33-02-SUMMARY.md`
</output>

---
phase: 35-event-display-grid
plan: 02
type: execute
wave: 2
depends_on: ["35-01"]
files_modified:
  - internal/todolist/model.go
  - internal/app/model.go
autonomous: true

must_haves:
  truths:
    - "Timed events show HH:MM prefix in 24h format in the todo panel"
    - "All-day events show 'all day' label in the todo panel"
    - "Events appear above todos within the dated section"
    - "Events are not selectable -- cursor skips over them"
    - "Events have no checkbox, distinct color from todos"
    - "Events respect monthly view filtering"
    - "Events respect weekly view filtering"
    - "Multi-day events show on each day they span"
  artifacts:
    - path: "internal/todolist/model.go"
      provides: "eventItem kind, calendarEvents field, SetCalendarEvents, renderEvent, event insertion in visibleItems"
      contains: "eventItem"
    - path: "internal/app/model.go"
      provides: "Event data flow from app to todolist via SetCalendarEvents"
      contains: "SetCalendarEvents"
  key_links:
    - from: "internal/app/model.go"
      to: "internal/todolist/model.go"
      via: "SetCalendarEvents call in syncTodoView and EventsFetchedMsg handler"
      pattern: "todoList\\.SetCalendarEvents"
    - from: "internal/todolist/model.go"
      to: "internal/google/events.go"
      via: "ExpandMultiDay and CalendarEvent type usage"
      pattern: "google\\.ExpandMultiDay"
---

<objective>
Display Google Calendar events in the todo list panel with visual distinction, correct sorting, and view filtering.

Purpose: Satisfies DISP-01 through DISP-08 -- events rendered alongside todos in the todo panel.
Output: Events appear in the todo list, styled distinctly, sorted before todos, not selectable, respecting view filters.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-event-display-grid/35-RESEARCH.md
@.planning/phases/35-event-display-grid/35-01-SUMMARY.md
@internal/todolist/model.go
@internal/app/model.go
@internal/google/events.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add eventItem kind and event rendering to todolist</name>
  <files>internal/todolist/model.go</files>
  <action>
1. Add `eventItem` to the itemKind constants (after `emptyItem`):
   ```go
   eventItem  // Google Calendar event (non-selectable)
   ```

2. Add `event *google.CalendarEvent` field to `visibleItem` struct (alongside the existing `todo *store.Todo` field). Add comment: `// non-nil only for eventItem`

3. Add `calendarEvents []google.CalendarEvent` field to Model struct.

4. Add `SetCalendarEvents` setter method on `*Model`:
   ```go
   func (m *Model) SetCalendarEvents(events []google.CalendarEvent) {
       m.calendarEvents = events
   }
   ```

5. Add `renderEvent` method to Model:
   ```go
   func (m Model) renderEvent(b *strings.Builder, e *google.CalendarEvent) {
       b.WriteString("       ") // 2 spaces (no cursor) + 5 spaces (no priority badge)
       if e.AllDay {
           b.WriteString(m.styles.EventTime.Render("all day"))
       } else {
           b.WriteString(m.styles.EventTime.Render(e.Start.Format("15:04")))
       }
       b.WriteString("  ")
       b.WriteString(m.styles.EventText.Render(e.Summary))
       b.WriteString("\n")
   }
   ```

6. In `visibleItems()`, modify the dated section to insert events BEFORE todos. The logic for both week-filtered and month view branches needs the same treatment. For each branch, after appending the header and BEFORE appending todos:
   - Call `google.ExpandMultiDay(m.calendarEvents)` to get expanded events
   - Filter to the relevant date range:
     - Week view: events where `e.Date >= m.weekFilterStart && e.Date <= m.weekFilterEnd`
     - Month view: events where the date falls within the viewed month (parse Date, check year+month match)
   - For each matching event, append `visibleItem{kind: eventItem, event: &expandedEvents[i], section: sectionDated}`
   - Then proceed with existing todo insertion
   - Adjust the "(no todos this month/week)" empty item logic: only show empty placeholder if BOTH events and todos are empty for that section

7. In `normalView()`, add a case for `eventItem` in the render switch:
   ```go
   case eventItem:
       m.renderEvent(&b, item.event)
   ```

8. In the filter logic at the end of `visibleItems()`: when filtering, pass through `eventItem` entries unchanged (they should remain visible during filtering, or alternatively be hidden -- research says events are non-interactive, so hiding them during filter mode is cleaner). Hide events during filter mode by not including them in filtered results.

9. Add `"github.com/antti/todo-calendar/internal/google"` to imports.

Note: `selectableIndices()` already only returns `todoItem` indices, so events are automatically non-selectable (DISP-05). No changes needed there.
  </action>
  <verify>Run `go build ./internal/todolist/...` -- must compile. Run `go vet ./internal/todolist/...`.</verify>
  <done>eventItem kind exists, events rendered with time prefix and distinct style, inserted before todos in dated section, filtered by view range, non-selectable.</done>
</task>

<task type="auto">
  <name>Task 2: Wire event data from app model to todolist</name>
  <files>internal/app/model.go</files>
  <action>
1. In the `EventsFetchedMsg` handler (around line 161), after updating `m.calendarEvents`, call:
   ```go
   m.todoList.SetCalendarEvents(m.calendarEvents)
   ```
   Add this in BOTH the full-sync and incremental-sync branches, after the calendarEvents assignment.

2. In `syncTodoView()`, add a call to pass events to the todolist:
   ```go
   m.todoList.SetCalendarEvents(m.calendarEvents)
   ```
   This ensures events are refreshed when the user navigates months/weeks.

3. In `New()`, no changes needed since calendarEvents starts empty and will be populated after EventsFetchedMsg.

4. In the `google.AuthResultMsg` handler, after successfully creating the calendar service and dispatching fetch, no extra wiring needed -- the EventsFetchedMsg handler will propagate events when the fetch completes.
  </action>
  <verify>Run `go build ./...` -- full project must compile. Run `go vet ./...`.</verify>
  <done>Events flow from app model to todolist on every fetch and every view navigation. Events appear in the todo panel when Google Calendar is connected.</done>
</task>

</tasks>

<verification>
- `go build ./...` passes
- `go vet ./...` passes
- eventItem kind exists in todolist model
- visibleItems inserts events before todos in dated section
- Events filtered by month in monthly view, by week in weekly view
- renderEvent shows "all day" or "HH:MM" prefix
- selectableIndices still only returns todoItem indices
- App model calls SetCalendarEvents after fetch and during syncTodoView
</verification>

<success_criteria>
Google Calendar events appear in the todo list panel with HH:MM time prefix (timed) or "all day" label (all-day), visually distinct from todos, sorted above todos, not selectable by cursor, and filtered to the current view range.
</success_criteria>

<output>
After completion, create `.planning/phases/35-event-display-grid/35-02-SUMMARY.md`
</output>

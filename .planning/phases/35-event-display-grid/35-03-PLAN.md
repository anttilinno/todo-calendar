---
phase: 35-event-display-grid
plan: 03
type: execute
wave: 3
depends_on: ["35-01", "35-02"]
files_modified:
  - internal/calendar/model.go
  - internal/calendar/grid.go
  - internal/settings/model.go
  - internal/app/model.go
autonomous: true

must_haves:
  truths:
    - "Calendar grid days with events show bracket indicators even when no todos exist"
    - "Google Calendar can be toggled on/off in settings without removing credentials"
    - "When disabled, events are hidden from both todo list and grid"
  artifacts:
    - path: "internal/calendar/model.go"
      provides: "calendarEvents field, SetCalendarEvents setter, hasEventsForDay helper"
      contains: "SetCalendarEvents"
    - path: "internal/calendar/grid.go"
      provides: "hasEvents parameter in RenderGrid and RenderWeekGrid"
      contains: "hasEvents"
    - path: "internal/settings/model.go"
      provides: "Enable/Disable toggle for Google Calendar when AuthReady"
      contains: "Enabled"
    - path: "internal/app/model.go"
      provides: "Event data flow to calendar model, GoogleCalendarEnabled gating"
      contains: "calendar.SetCalendarEvents"
  key_links:
    - from: "internal/app/model.go"
      to: "internal/calendar/model.go"
      via: "SetCalendarEvents call in syncTodoView and EventsFetchedMsg"
      pattern: "calendar\\.SetCalendarEvents"
    - from: "internal/calendar/model.go"
      to: "internal/calendar/grid.go"
      via: "hasEvents map passed to RenderGrid/RenderWeekGrid"
      pattern: "hasEvents"
    - from: "internal/settings/model.go"
      to: "internal/config/config.go"
      via: "GoogleCalendarEnabled in Config()"
      pattern: "GoogleCalendarEnabled"
---

<objective>
Add event presence indicators to the calendar grid and a settings toggle to enable/disable Google Calendar display.

Purpose: Satisfies GRID-01 (grid indicators for events) and CONF-01 (settings toggle).
Output: Grid shows brackets on days with events. Settings allows enabling/disabling event display.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-event-display-grid/35-RESEARCH.md
@.planning/phases/35-event-display-grid/35-01-SUMMARY.md
@internal/calendar/model.go
@internal/calendar/grid.go
@internal/settings/model.go
@internal/app/model.go
@internal/config/config.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add event indicators to calendar grid</name>
  <files>internal/calendar/model.go, internal/calendar/grid.go</files>
  <action>
1. In `internal/calendar/model.go`:
   - Add import for `"github.com/antti/todo-calendar/internal/google"`
   - Add `calendarEvents []google.CalendarEvent` field to Model struct
   - Add `SetCalendarEvents` setter:
     ```go
     func (m *Model) SetCalendarEvents(events []google.CalendarEvent) {
         m.calendarEvents = events
     }
     ```
   - Add `hasEventsPerDay` helper that computes `map[int]bool` for the given year/month:
     ```go
     func (m Model) hasEventsPerDay(year int, month time.Month) map[int]bool {
         result := make(map[int]bool)
         expanded := google.ExpandMultiDay(m.calendarEvents)
         prefix := fmt.Sprintf("%04d-%02d-", year, int(month))
         for _, e := range expanded {
             if strings.HasPrefix(e.Date, prefix) {
                 day, err := strconv.Atoi(e.Date[8:10])
                 if err == nil {
                     result[day] = true
                 }
             }
         }
         return result
     }
     ```
   - Add imports for `"strconv"` and `"strings"` and `"fmt"` as needed.

2. In `View()` of calendar model, pass `hasEvents` to both grid render functions:
   - For MonthView: `hasEvents := m.hasEventsPerDay(m.year, m.month)` then add it as parameter to `RenderGrid`
   - For WeekView: need hasEvents for the week's month. Compute `hasEvents := m.hasEventsPerDay(m.year, m.month)` and pass to `RenderWeekGrid`

3. In `internal/calendar/grid.go`:
   - Add `hasEvents map[int]bool` parameter to `RenderGrid` function signature (after `priorities` parameter, before `st`).
   - In the day cell logic, modify the bracket condition:
     ```go
     hasPending := indicators[day] > 0
     hasAllDone := !hasPending && totals[day] > 0
     hasEvt := hasEvents[day]
     ```
     Change the cell format: `if hasPending || hasAllDone || hasEvt {` use brackets `[%2d]`
   - For the style selection, add a new case for event-only days (no todos). After the `hasAllDone` case and before `default`, add:
     ```go
     case hasEvt:
         cell = s.Indicator.Render(cell) // Use default indicator style for event-only days
     ```
     And for the today variants, extend: `case day == today && hasEvt:` use `s.TodayIndicator.Render(cell)` (default indicator, no priority).

   - Apply the same changes to `RenderWeekGrid`:
     - Add `hasEvents map[int]bool` parameter
     - Same bracket logic: `if hasPending || hasAllDone || hasEvt {`
     - Same event-only style case

4. Update all callers of `RenderGrid` and `RenderWeekGrid` in `model.go` View() to pass the new `hasEvents` parameter.
  </action>
  <verify>Run `go build ./internal/calendar/...` -- must compile. Run `go vet ./internal/calendar/...`.</verify>
  <done>Calendar grid shows bracket indicators on days that have events even when no todos exist. Event-only days use default indicator style.</done>
</task>

<task type="auto">
  <name>Task 2: Add settings toggle and app wiring for GoogleCalendarEnabled</name>
  <files>internal/settings/model.go, internal/app/model.go</files>
  <action>
1. In `internal/settings/model.go`:
   - Modify the Google Calendar row (row 6) initialization in `New()`. When `authState == google.AuthReady`, instead of static "Connected", use a cycling toggle:
     ```go
     if authState == google.AuthReady {
         // Cycling toggle: Enabled / Disabled
         enabledValues := []string{"true", "false"}
         enabledDisplay := []string{"Enabled", "Disabled"}
         idx := 0
         if !cfg.GoogleCalendarEnabled {
             idx = 1
         }
         options[googleCalendarRow] = option{
             label: "Google Calendar", values: enabledValues, display: enabledDisplay, index: idx,
         }
     }
     ```
     When NOT AuthReady, keep existing action-row behavior (static status text).

   - In `Update()`, the Left/Right handlers currently skip googleCalendarRow entirely. Change this: only skip if `m.googleAuthState != google.AuthReady`. When AuthReady, allow normal cycling (the existing Left/Right cycling code will work).

   - In `Config()`, add `GoogleCalendarEnabled` field. When authState is AuthReady, read from the toggle:
     ```go
     GoogleCalendarEnabled: m.googleAuthState == google.AuthReady && m.options[googleCalendarRow].values[m.options[googleCalendarRow].index] == "true",
     ```
     When NOT AuthReady, default to the previous config value. Simplest approach: always derive from the options. If not AuthReady, the values array has status text, not "true"/"false", so this would return false. Instead, handle it explicitly:
     ```go
     func (m Model) Config() config.Config {
         gcalEnabled := true // default
         if m.googleAuthState == google.AuthReady {
             gcalEnabled = m.options[googleCalendarRow].values[m.options[googleCalendarRow].index] == "true"
         }
         return config.Config{
             // ... existing fields ...
             GoogleCalendarEnabled: gcalEnabled,
         }
     }
     ```

   - In `SetGoogleAuthState()`, when state becomes AuthReady, update the row to be a cycling toggle (Enabled/Disabled) rather than static text.

2. In `internal/app/model.go`:
   - In the `EventsFetchedMsg` handler, gate the SetCalendarEvents calls on `m.cfg.GoogleCalendarEnabled`:
     ```go
     if m.cfg.GoogleCalendarEnabled {
         m.todoList.SetCalendarEvents(m.calendarEvents)
         m.calendar.SetCalendarEvents(m.calendarEvents)
     }
     ```
     When disabled, pass empty slices:
     ```go
     if !m.cfg.GoogleCalendarEnabled {
         m.todoList.SetCalendarEvents(nil)
         m.calendar.SetCalendarEvents(nil)
     }
     ```

   - In `syncTodoView()`, also gate:
     ```go
     if m.cfg.GoogleCalendarEnabled {
         m.todoList.SetCalendarEvents(m.calendarEvents)
         m.calendar.SetCalendarEvents(m.calendarEvents)
     } else {
         m.todoList.SetCalendarEvents(nil)
         m.calendar.SetCalendarEvents(nil)
     }
     ```

   - In the `SettingChangedMsg` handler, after `m.cfg = msg.Cfg`, add the same gating logic to immediately show/hide events when the toggle changes:
     ```go
     if m.cfg.GoogleCalendarEnabled {
         m.todoList.SetCalendarEvents(m.calendarEvents)
         m.calendar.SetCalendarEvents(m.calendarEvents)
     } else {
         m.todoList.SetCalendarEvents(nil)
         m.calendar.SetCalendarEvents(nil)
     }
     ```
  </action>
  <verify>Run `go build ./...` -- full project must compile. Run `go vet ./...`.</verify>
  <done>Settings shows Enabled/Disabled toggle for Google Calendar when connected. Toggling immediately shows/hides events. Config persists the setting. Events continue to be fetched in background even when display is disabled.</done>
</task>

</tasks>

<verification>
- `go build ./...` passes
- `go vet ./...` passes
- RenderGrid and RenderWeekGrid accept hasEvents parameter
- Days with events but no todos show bracket indicators
- Settings shows cycling toggle when Google Calendar is connected
- Settings shows action row (Sign in/Reconnect) when not connected
- GoogleCalendarEnabled persisted to config file
- Disabling hides events immediately, enabling shows them immediately
</verification>

<success_criteria>
Calendar grid shows indicators for event-only days. Settings toggle controls event visibility without affecting credentials or background fetching.
</success_criteria>

<output>
After completion, create `.planning/phases/35-event-display-grid/35-03-SUMMARY.md`
</output>

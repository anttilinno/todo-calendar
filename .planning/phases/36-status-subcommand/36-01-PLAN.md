---
phase: 36-status-subcommand
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - internal/theme/theme.go
  - internal/status/status.go
  - internal/status/status_test.go
autonomous: true
requirements:
  - BAR-01
  - BAR-02
  - BAR-03

must_haves:
  truths:
    - "FormatStatus returns Polybar-formatted string with priority color, icon, and count for pending todos"
    - "FormatStatus returns empty string when no pending todos exist for today"
    - "Highest priority (lowest number) among pending todos determines the hex color"
    - "Todos with no priority (0) use the AccentFg theme color as fallback"
    - "WriteStatusFile writes formatted output to /tmp/.todo_status"
  artifacts:
    - path: "internal/theme/theme.go"
      provides: "PriorityColorHex method returning raw hex string for priority level"
      contains: "PriorityColorHex"
    - path: "internal/status/status.go"
      provides: "FormatStatus and WriteStatusFile functions"
      contains: "FormatStatus"
    - path: "internal/status/status_test.go"
      provides: "Tests for FormatStatus covering all edge cases"
      contains: "TestFormatStatus"
  key_links:
    - from: "internal/status/status.go"
      to: "internal/theme/theme.go"
      via: "PriorityColorHex for Polybar %{F#hex} formatting"
      pattern: "PriorityColorHex"
    - from: "internal/status/status.go"
      to: "internal/store/iface.go"
      via: "TodosForDateRange to get today's todos"
      pattern: "TodosForDateRange"
---

<objective>
Create the status formatting engine and theme color helper for Polybar output.

Purpose: Enable `todo-calendar status` to query today's pending todos from SQLite and produce Polybar-compatible output in a state file. This is the core logic for the v2.3 Polybar Status feature.

Output: `internal/status` package with `FormatStatus` (pure function) and `WriteStatusFile` (side effect), plus `PriorityColorHex` on Theme.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@internal/theme/theme.go
@internal/store/iface.go
@internal/store/todo.go
@internal/store/sqlite.go
@internal/config/config.go
@internal/config/paths.go
</context>

<feature>
  <name>Status formatting with priority-colored Polybar output</name>
  <files>internal/theme/theme.go, internal/status/status.go, internal/status/status_test.go</files>
  <behavior>
    FormatStatus(todos []store.Todo, t theme.Theme) string:

    - Input: slice of today's todos (all, including completed), theme
    - Filter to pending only (Done == false)
    - If zero pending: return ""
    - Count pending todos
    - Find highest priority (lowest non-zero Priority value) among pending
    - If no pending todo has a priority (all priority==0): use AccentFg as color
    - Look up hex color via theme.PriorityColorHex(priority)
    - Return: fmt.Sprintf("%%{F%s}\uf46d %d%%{F-}", hexColor, count)
      (where \uf46d is a Nerd Font "task" icon -- U+F46D)

    Cases:
    - [] -> ""
    - [done:true] -> "" (all completed)
    - [{text:"buy milk", done:false, priority:0}] -> "%{F#5F5FD7}\uf46d 1%{F-}" (dark theme AccentFg)
    - [{done:false, priority:1}, {done:false, priority:3}] -> "%{F#FF5F5F}\uf46d 2%{F-}" (P1 red, dark theme)
    - [{done:false, priority:2}, {done:true, priority:1}] -> "%{F#FFAF5F}\uf46d 1%{F-}" (P2 orange, completed P1 ignored)

    PriorityColorHex(priority int) string on Theme:
    - 1 -> string(t.PriorityP1Fg)
    - 2 -> string(t.PriorityP2Fg)
    - 3 -> string(t.PriorityP3Fg)
    - 4 -> string(t.PriorityP4Fg)
    - 0 or other -> string(t.AccentFg)

    WriteStatusFile(content string) error:
    - Writes content to /tmp/.todo_status (atomic: write temp + rename)
    - Creates file if not exists, truncates if exists
  </behavior>
  <implementation>
    1. Add PriorityColorHex(priority int) string method to Theme struct in theme.go.
       Returns the raw hex string (e.g., "#FF5F5F") by casting lipgloss.Color to string.
       Switch on priority 1-4 returning PriorityP*Fg, default returns AccentFg.

    2. Create internal/status/status.go with:
       - const statusPath = "/tmp/.todo_status"
       - const statusIcon = "\uf46d" (Nerd Font task icon)
       - func FormatStatus(todos []store.Todo, t theme.Theme) string
       - func WriteStatusFile(content string) error (atomic write via temp file + os.Rename)

    3. Create internal/status/status_test.go with comprehensive tests using theme.Dark().
  </implementation>
</feature>

<verification>
cd /home/antti/Repos/Misc/todo-calendar/.dmux/worktrees/notifier && go test ./internal/status/ -v -count=1
cd /home/antti/Repos/Misc/todo-calendar/.dmux/worktrees/notifier && go build ./...
</verification>

<success_criteria>
- All tests pass in internal/status/ package
- FormatStatus correctly returns empty string for zero pending todos
- FormatStatus correctly identifies highest priority and maps to theme color hex
- FormatStatus correctly formats Polybar %{F#hex}ICON COUNT%{F-} output
- WriteStatusFile atomically writes to /tmp/.todo_status
- Project compiles cleanly with go build ./...
</success_criteria>

<output>
After completion, create `.planning/phases/36-status-subcommand/36-01-SUMMARY.md`
</output>
